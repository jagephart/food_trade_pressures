---
title: "Comtrade data: Weights of live animals traded by individual countries"
author: "Haley Epperly"
date: "2022-09-29"
output: html_document
editor_options: 
  chunk_output_type: console
---


1. Gapfill missing import data with export data from trading partners
Export data might be more accurate for animal size because they may change weight on the trade journey. However, we have discussed how import data is likely more reliable (and other journal articles agree) because countries are better at documenting what exactly is coming into their country.

For imports (or exports), for each country we could calculate the average size of each animal (or proportions of categories) that they import. You could just look at what each country trades with the "World". The World is the sum of all the trading partners. Then we could assume all trading partners are importing the same size animal into the primary country.

It would be best to look at the variation in animal size imported to one country from different countries to see if the previous approach is a good one or if the variation is too large. Same with looking at the size of animals one country exports to all trading partners.


### Categories (n represents number of trading partners including exports and imports):
Some categories are duplicates.

Cattle:
- Cattle; live, other than pure-bred breeding animals (n = 1183)
- Cattle; live, pure-bred breeding animals (n = 1162)

Chickens:
- Live fowls of species Gallus domesticus, weighing > 185g (n = 9)
- Live fowls of species Gallus domesticus, weighing >2000g (n = 2)
- Live fowls of species Gallus domesticus, weighing not >185g (n = 37)
- Poultry; live, fowls of the species Gallus domesticus, weighing more than 185g (n = 665)
- Poultry; live, fowls of the species Gallus domesticus, weighing not more than 185g (n = 1800)

Goats:
- Goats; live (n = 554)
- Live goats (n = 15)

Sheep:
- Live sheep (n = 19)
- Sheep; live (n = 887)

Pigs:
- Live swine other than pure-bred breeding animals, weighing < 50kg (n = 8)
- Live swine other than pure-bred breeding animals, weighing 50kg/more (n = 4)
- Live swine: pure-bred breeding animals (n = 8)
- Swine; live, other than pure-bred breeding animals, weighing 50kg or more (n = 520)
- Swine; live, other than pure-bred breeding animals, weighing less than 50kg (n = 553)
- Swine; live, pure-bred breeding animals (n = 678)



Load libraries
```{r}
library(tidyverse)
```


Read in Comtrade data (downloaded in script comtrade_data_download)
```{r}
comtrade <- read_csv("/home/shares/food-systems/social_justice_projects/_raw_data/comtrade/comtrade_live_animal_trade_data_dl_9_29_22.csv")

# only 2017 data
range(comtrade$year)
```


### Review data

Some categories of animal commodities are written in 2 different ways. Check to see if they have the same commodity code, so we can use that code going forward.
YES - all matching commodity categories use the same commodity code.
```{r}
# goats
goat <- comtrade %>% 
  filter(commodity == "Goats; live" | commodity == "Live goats")
table(goat$commodity_code) # yes same code - 010420

# sheep
sheep <- comtrade %>% 
  filter(commodity == "Sheep; live" | commodity == "Live sheep")
table(sheep$commodity_code) # yes same code - 010410

# chickens
chickens_1 <- comtrade %>% 
  filter(commodity == "Live fowls of species Gallus domesticus, weighing > 185g" | commodity == "Poultry; live, fowls of the species Gallus domesticus, weighing more than 185g")
table(chickens_1$commodity_code) # yes same code - 010594

chickens_2 <- comtrade %>% 
  filter(commodity == "Live fowls of species Gallus domesticus, weighing not >185g" | commodity == "Poultry; live, fowls of the species Gallus domesticus, weighing not more than 185g")
table(chickens_2$commodity_code) # yes same code - 010511

# pigs
pigs_1 <- comtrade %>% 
  filter(commodity == "Live swine other than pure-bred breeding animals, weighing < 50kg" | commodity == "Swine; live, other than pure-bred breeding animals, weighing less than 50kg")
table(pigs_1$commodity_code) # yes same code - 010391

pigs_2 <- comtrade %>% 
  filter(commodity == "Live swine other than pure-bred breeding animals, weighing 50kg/more" | commodity == "Swine; live, other than pure-bred breeding animals, weighing 50kg or more")
table(pigs_2$commodity_code) # yes same code - 010392

pigs_3 <- comtrade %>% 
  filter(commodity == "Live swine: pure-bred breeding animals" | commodity == "Swine; live, pure-bred breeding animals")
table(pigs_3$commodity_code) # yes same code - 010310
```


Only 2 instances of chickens > 2000g (commodity code = 010593), let's combine that with chickens > 185g by changing the commodity code.
```{r}
comtrade_1 <- comtrade %>% 
  mutate(commodity_code = case_when(commodity_code == "010593" ~ "010594", TRUE ~ commodity_code)) %>% 
  select(trade_flow_code, trade_flow, reporter, reporter_iso, partner, partner_iso, commodity_code, commodity, qty_unit,
         qty, netweight_kg)
```


qty_unit categories:
No Quantity = value is 0 for qty
Number of items (n = 7267)
Weight in kilograms (n = 51) - qty and netweight (kg) are the same value. This value only included in Export and Re-Export (and one Re-Import) rows.

```{r}
wt_in_kg <- comtrade_1 %>% 
  filter(qty_unit == "Weight in kilograms") %>% 
  filter(!partner == "World")

# only 37 instances where we have to deal with weight in kilograms
# 15 of which are re-exports, so really only 22 instances

# these are all for exports, so maybe we can fill these with import data - looks like it will work for some rows but not all
table(wt_in_kg$trade_flow)

# only for these countries - Barbados, Jordan, Namibia, Oman, Saudi Arabia
table(wt_in_kg$reporter)

# let's ignore the one re-import because it's only 90 kg of goats, so like 2 goats probably
wt_in_kg <- wt_in_kg %>% 
  filter(!(trade_flow == "Re-Import"))

# subtract re-export tonnes from export tonnes where available because re-exports are included in a country's exports
# and we don't want to double count them
wt_in_kg_1 <- wt_in_kg %>%
  select(-c(trade_flow_code, commodity, qty)) %>% 
  pivot_wider(names_from = trade_flow, values_from = netweight_kg)

# wherever there are re-exports, it is always the total amount of original exports.
# except there are lots of cases in Oman where there are re-exports, but no exports.

# when re-export amount = export amount, we can assume country A imported goats 
# from country C and then exported those live goats to country B. It does not
# appear these numbers are double counted, rather that they just put re-export
# values in the export column when all trade is a re-export. This might just be
# when values are in kg.

# does this hold true for all re-exports?
test <- comtrade_1 %>% 
  filter(trade_flow == "Export" | trade_flow == "Re-Export") %>% 
  select(-c(trade_flow_code, commodity, qty)) %>% 
  pivot_wider(names_from = trade_flow, values_from = netweight_kg)

# re-exports are included in the export column for all trade (except when the qty is in weight in kg)
# this means we can ignore the re-export column. We are not counting that trade twice between those 2 countries,
# it means that country A exported live cows to country B, then country B exported
# those live cows to country C. So we are counting the trade of those cows twice
# because we are counting their trade between 2 different sets of trading partners.
# But we don't have the full link from countries a to b to c. 

# we could proportionally subtract cows. For example, China imports 1,000 cows from 10
# trading partners, they re-export, 100 cows to Saudi Arabia. We could subtract 10%
# of cows from each country that imports cows to China. This might get messy with the 
# FAO production data.

# We're only using these data to come up with average import weights per country
# not to make an accurate trade matrix. So maybe we can just ignore the re-exports and re-imports.
# The live animal trade part will be included in the Kastner script and we don't need to adjust that.

# create import df
import <- comtrade_1 %>% 
  filter(trade_flow == "Import") %>% 
  filter(!partner == "World")
```


trade_flow categories:
Export
Re-Export
Import
Re-Import

How many cases of re-imports and re-exports occur (excluding trade with world because we can't do anything about that)
```{r}
# re-imports
re_import <- comtrade_1 %>% 
  filter(trade_flow == "Re-Import")

# remove cases where trade partner is world because we won't be able to account for that
re_import <- re_import %>% 
  filter(!partner == "World")

# most cases are where a country is re-importing into their own country. I think that's what the definition of re-imports are.
# A country exports a live animal and then re-imports it for some reason, like it wasn't accepted by the other country.

# I don't know what it means when the partner country is different than the reporter country.
# Maybe it just specifies that country A tried to send live product to Country B, but Country B rejected it and sent it back to Country A.

# We can't do anything with re-imports where a country and its partner are the same because we don't know where it was trying to export those products to originally.
re_import_1 <- re_import %>% 
  filter(!reporter == partner)
# 12 instances to take into account
# could subtract re-imports from exports. Ex., China exports 10 ton sheep to Kuwait, 
# China re-imports 5 ton sheep from Kuwait. So China exports (10 - 5) = 5 ton sheep to Kuwait.


# re-exports
re_export <- comtrade_1 %>% 
  filter(trade_flow == "Re-Export")

# remove cases where trade partner is world because we won't be able to account for that
re_export <- re_export %>% 
  filter(!partner == "World")

# remove cases where trade partners are the same country - no cases of this with re-export data
re_export_1 <- re_export %>% 
  filter(!reporter == partner)
# 97 instances to take into account - subtract from trade flow

# value in USD of re-exports
sum(re_export_1$trade_value_usd) # $52,845,954

# value in USD of exports
comtrade_1 %>% 
  filter(trade_flow == "Export") %>% 
  filter(!partner == "World") %>% 
  filter(!reporter == partner) %>% 
  summarise(sum = sum(trade_value_usd)) # 16,101,129,371

52845954/16101129371
# 0.3% of total live animal trade value is in these re-exports, so we can mostly ignore these
# we will just subtract (weight in kg or quantity number) where appropriate. 
# For example, Saudi Arabia re-exports 147,000 kg live sheep to Jordan, so we 
# will subtract 147,000 kg from the amount of live sheep Saudi Arabia exports
# to Jordan. 
# Need to check to make sure this doesn't introduce 0s.
```



### Fill in missing import data with export data
```{r}
# only include when we have quantity data because we need this to calc average weights
comtrade_2 <- comtrade_1 %>% 
  filter(qty_unit == "Number of items")

# calculate average weight per animal per trade
comtrade_3 <- comtrade_2 %>% 
  mutate(avg_weight = netweight_kg/qty)

# separate import and export data into separate dataframes
# rename export data so it can be merged with import data
export <- comtrade_3 %>%
  filter(trade_flow == "Export") %>% 
  rename(partner_1 = reporter) %>%
  rename(partner_iso_1 = reporter_iso) %>% 
  rename(reporter = partner) %>% 
  rename(reporter_iso = partner_iso) %>% 
  rename(partner = partner_1) %>% 
  rename(partner_iso = partner_iso_1) %>% 
  rename(avg_weight_export = avg_weight) %>%
  rename(qty_export = qty) %>% 
  rename(netweight_export = netweight_kg) %>% 
  select(-c(trade_flow_code, trade_flow, commodity, qty_unit))

import <- comtrade_3 %>%
  filter(trade_flow == "Import") %>% 
  select(-c(trade_flow_code, trade_flow, qty_unit))


# join import and export data back together 
import_export <- full_join(import, export, by = c("partner", "partner_iso", "reporter", "reporter_iso", "commodity_code"))

# fill in missing import quantities with export quantities
import_gf <- import_export %>% 
  mutate(avg_weight_2 = case_when(is.na(avg_weight) ~ avg_weight_export, 
                                  avg_weight == 0 ~ avg_weight_export,
                                  avg_weight > 2000 ~ avg_weight_export, # no animal is over 2,000 kg so these are errors
                                  TRUE ~ avg_weight))

length(which(is.na(import_gf$avg_weight_2))) # 189 NAs

# remove rows with NAs or where the gapfilled average weight is over 2,000 kg
# remove anything under 0.02 kg (20 g), chicks are ~38g when born 
import_gf_2 <-  import_gf %>% 
  filter(!is.na(avg_weight_2)) %>% 
  filter(avg_weight_2 < 1999.9) %>% 
  filter(avg_weight_2 > 0.02)
```


Commodity codes:

- Goats (010420)
- Sheep (010410)
- Chickens > 185g (010594)
- Chickens < 185g (010511)
- Pigs < 50kg (010391)
- Pigs > 50kg (010392)
- Pigs breeding animals (010310) - assume most pressure accrued in importing country because will be alive a long time
- Cows breeding animals (010221) - assume most pressure accrued in importing country because will be alive a long time
- Cows other than breeding animals (010229)


How much do average weights vary for the top exporters/importers for each animal?
I calculated the mean and sd for the top exporters and importers for each animal group (selecting one category to investigate from each animal group). I then compared the sd for each country (variation in size of animals traded with different trading partners) to the mean for that country. I found that the sds for importers vs exporters were fairly similar relative to their means, although import sds tended to be a bit lower. Therefore I will use average values for importers. Instead of  
```{r}
# goats
# top goat importers using world values for imports (no gapfilled values here)
goats <- import_gf_2 %>% 
  filter(commodity_code == "010420", partner == "World") %>% 
  arrange(desc(qty))

# Saudi Arabia, Oman, UAE = top 3
top_goats <- import_gf_2 %>% 
  filter(commodity_code == "010420", !partner == "World") %>% 
  filter(reporter == "Saudi Arabia" | reporter == "Oman" | reporter == "United Arab Emirates") %>% 
  group_by(reporter) %>% 
  mutate(mean = mean(avg_weight_2, na.rm = TRUE)) %>% 
  mutate(sd = sd(avg_weight_2, na.rm = TRUE))
# avg weights do not seem strange - goats can exceed 130kg
# Saudi avg weight = 49kg
# Oman avg weight = 33kg
# UAE avg weight = 43kg
# standard deviations are quite high, close to the mean amount for each country

# calculate average weights as sum of netweight / sum of qty per country (this isn't gapfilled so only using imports)
# these are probably the average weights we want to use so will need to gapfill missing qty and netweight values
# if we decide to use trading partners data, but probably will just use aggregate data, what country A trades
# with the world because of all the inaccuracies at country to country level
top_goats_2 <- import_gf_2 %>% 
  filter(commodity_code == "010420", !partner == "World") %>% 
  filter(reporter == "Saudi Arabia" | reporter == "Oman" | reporter == "United Arab Emirates") %>% 
  group_by(reporter) %>% 
  mutate(sum_qty = sum(qty, na.rm = TRUE)) %>% 
  mutate(sum_weight = sum(netweight_kg, na.rm = TRUE)) %>% 
  mutate(avg_weight_calc = sum_weight/sum_qty)
# Saudi avg weight = 53kg
# Oman avg weight = 22kg
# UAE avg weight = 47kg


# if we look at top exporters, are their sds lower?
goats_2 <- import_gf_2 %>% 
  filter(commodity_code == "010420", reporter == "World") %>% 
  arrange(desc(qty_export))
# top exporters = India, Sudan, Myanmar

top_goats_exporters <- import_gf_2 %>% 
  filter(commodity_code == "010420", !reporter == "World") %>% 
  filter(partner == "India" | partner == "Sudan" | partner == "Myanmar") %>% 
  group_by(partner) %>% 
  mutate(mean = mean(avg_weight_2, na.rm = TRUE)) %>% 
  mutate(sd = sd(avg_weight_2, na.rm = TRUE))
# no, the sds are somewhat close to the mean when we look at top exporters too


# cows (other than breeding animals) - compare sd for importer and exporter averages
# exporter averages have slightly lower sds
cows <- import_gf_2 %>% 
  filter(commodity_code == "010229", partner == "World") %>% 
  arrange(desc(qty))
top_cows <- import_gf_2 %>% 
  filter(commodity_code == "010229", !partner == "World") %>% 
  filter(reporter == "Jordan" | reporter == "USA" | reporter == "Netherlands") %>% 
  group_by(reporter) %>% 
  mutate(mean = mean(avg_weight_2, na.rm = TRUE)) %>% 
  mutate(sd = sd(avg_weight_2, na.rm = TRUE))
# means are close to sd
cows_2 <- import_gf_2 %>% 
  filter(commodity_code == "010229", reporter == "World") %>% 
  arrange(desc(qty_export))
top_cows_exporters <- import_gf_2 %>% 
  filter(commodity_code == "010229", !reporter == "World") %>% 
  filter(partner == "France" | partner == "Australia" | partner == "Germany") %>% 
  group_by(partner) %>% 
  mutate(mean = mean(avg_weight_2, na.rm = TRUE)) %>% 
  mutate(sd = sd(avg_weight_2, na.rm = TRUE))
# sds are a bit less than the means

# sheep - compare sd for importer and exporter averages
# imports might be better
sheep <- import_gf_2 %>% 
  filter(commodity_code == "010410", partner == "World") %>% 
  arrange(desc(qty))
top_sheep <- import_gf_2 %>% 
  filter(commodity_code == "010410", !partner == "World") %>% 
  filter(reporter == "Saudi Arabia" | reporter == "Libya" | reporter == "Kuwait") %>% 
  group_by(reporter) %>% 
  mutate(mean = mean(avg_weight_2, na.rm = TRUE)) %>% 
  mutate(sd = sd(avg_weight_2, na.rm = TRUE))
# sd are about 1/3 of the means
sheep_2 <- import_gf_2 %>% 
  filter(commodity_code == "010410", reporter == "World") %>% 
  arrange(desc(qty_export))
top_sheep_exporters <- import_gf_2 %>% 
  filter(commodity_code == "010410", !reporter == "World") %>% 
  filter(partner == "Romania" | partner == "Australia" | partner == "Sudan") %>% 
  group_by(partner) %>% 
  mutate(mean = mean(avg_weight_2, na.rm = TRUE)) %>% 
  mutate(sd = sd(avg_weight_2, na.rm = TRUE))
# sd good for Romania and Sudan but 2x mean for Australia


# chickens > 185g - compare sd for importer and exporter averages
# imports are better
chickens <- import_gf_2 %>% 
  filter(commodity_code == "010594", partner == "World") %>% 
  arrange(desc(qty))
top_chickens <- import_gf_2 %>% 
  filter(commodity_code == "010594", !partner == "World") %>% 
  filter(reporter == "Netherlands" | reporter == "Belgium" | reporter == "Germany") %>% 
  group_by(reporter) %>% 
  mutate(mean = mean(avg_weight_2, na.rm = TRUE)) %>% 
  mutate(sd = sd(avg_weight_2, na.rm = TRUE))
# sd are about 1/7 - 1/2 of the means
chickens_2 <- import_gf_2 %>% 
  filter(commodity_code == "010594", reporter == "World") %>% 
  arrange(desc(qty_export))
top_chickens_exporters <- import_gf_2 %>% 
  filter(commodity_code == "010594", !reporter == "World") %>% 
  filter(partner == "Netherlands" | partner == "Germany" | partner == "Malaysia") %>% 
  group_by(partner) %>% 
  mutate(mean = mean(avg_weight_2, na.rm = TRUE)) %>% 
  mutate(sd = sd(avg_weight_2, na.rm = TRUE))
# sd are about 2/3 of mean


# pigs > 50kg - compare sd for importer and exporter averages
# imports are better
pigs <- import_gf_2 %>% 
  filter(commodity_code == "010392", partner == "World") %>% 
  arrange(desc(qty))
top_pigs <- import_gf_2 %>% 
  filter(commodity_code == "010392", !partner == "World") %>% 
  filter(reporter == "USA" | reporter == "Portugal" | reporter == "Germany") %>% 
  group_by(reporter) %>% 
  mutate(mean = mean(avg_weight_2, na.rm = TRUE)) %>% 
  mutate(sd = sd(avg_weight_2, na.rm = TRUE))
# sd are about 1/10 - 7/8 of the means
pigs_2 <- import_gf_2 %>% 
  filter(commodity_code == "010392", reporter == "World") %>% 
  arrange(desc(qty_export))
top_pigs_exporters <- import_gf_2 %>% 
  filter(commodity_code == "010392", !reporter == "World") %>% 
  filter(partner == "Netherlands" | partner == "Ireland" | partner == "Spain") %>% 
  group_by(partner) %>% 
  mutate(mean = mean(avg_weight_2, na.rm = TRUE)) %>% 
  mutate(sd = sd(avg_weight_2, na.rm = TRUE))
# sd are about 1/5 - +1 of mean
```


Are the world values the same as adding up import values from all trading partners?
Yes.
```{r}
world_test <- import %>% 
  filter(!partner == "World") %>% 
  group_by(reporter, commodity_code) %>% 
  summarise(sum_qty = sum(qty), sum_weight = sum(netweight_kg))
world_test_2 <- import %>% 
  filter(partner == "World")
```


Calculate average weights for country imports for each animal group
```{r}
avg_weight_per_country <- import_gf_2 %>% 
  filter(partner == "World")
# nothing was gapfilled with export data when using world as the partner

# clean data and save
avg_weight_per_country_1 <- avg_weight_per_country %>% 
  select(-c(10:13))

write_csv(avg_weight_per_country_1, "scripts/comtrade_live_animal_trade_weight/outputs/avg_animal_wt_imported_per_country_2017.csv")
```

