---
title: "connect_trade_and_pressures"
output: html_document
date: "2023-09-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The goal of this script is to connect the trade data to the environmental efficiency data to calculate the quantity of the pressures from the producing countries. The next script will combine these pressures with freshwater aquaculture and adjust the trade for feed.

## Setup
Packages
```{r}
library(tidyverse)
library(countrycode)
```


Filepaths
```{r}
trade_matrix_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/01b_calc_trade_matrix_2017/"
fmfo_trade_matrix_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/01e_allocate_unknown_trade_fmfo_consumption/"
fish_trade_matrix_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/01c_allocate_unknown_trade_fish_consumption/"
pressure_efficiency_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/02a_efficiencies_data_prep/"
code_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/raw_data/Codes/"
```

## Pressure Efficiency Data
Read in the pressure efficiency data. 

```{r}
pressures_per_tonne <- read.csv(paste0(pressure_efficiency_path, "pressures_per_tonne.csv"))
```

### Crops
Subset the pressure efficiency data to the crops food group. Pivot wider to make joining with trade data easier to manage.
```{r}
pressures_crops <- pressures_per_tonne %>% 
  filter(food_group == "crops") 

pressures_crops_wide <- pressures_crops %>% 
  # pivot wide to simplify join with trade data
  pivot_wider(names_from = pressure,
              values_from = pressure_per_tonne) %>% 
  # remove item and item code because the data is aggregated by SPAM_super
  select(-item_code, -item) %>% 
  # join will be with SPAM_super so make sure we have no repeats
  distinct()

# check for dupes
pressures_crops_dupes <- pressures_crops %>%
    dplyr::group_by(iso3c, nceas_group, SPAM_super, item_code, item, food_group, pressure) %>%
    dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%
    dplyr::filter(n > 1L)
```

#### Gapfill Set Up
Set up regional gapfilling for crops pressures. For this purpose we will use the countrycode package and the United Nations regional designations. This will be used to gapfill countries that have trade data with another country for a given product, but are missing pressures data.
```{r}
pressures_crops_regions <- pressures_crops %>% 
  # add subregion
  mutate(subregion = countrycode(iso3c, 'iso3c', 'un.regionsub.name')) %>% 
  # add intermediate region
  mutate(intermed_region = countrycode(iso3c, 'iso3c', 'un.regionintermediate.name')) %>% 
  # the intermediate region designation is less broad than subregion
  # make a region column for when there is no intermediate region use the subregion
  mutate(region = case_when(is.na(intermed_region) ~ subregion,
                            TRUE ~ intermed_region))  

# fill in Taiwan Region
pressures_crops_regions$region[pressures_crops_regions$iso3c == "TWN"] <- "Eastern Asia"
# the iso3c code is presumed to be for Kosovo and will therefor have a designation of Southern Europe like neighboring countries
pressures_crops_regions$region[pressures_crops_regions$iso3c == "XKO"] <- "Southern Europe"

na_test <- pressures_crops_regions %>% 
  filter(is.na(region)) %>% 
  mutate(country = countrycode(iso3c, 'iso3c', 'country.name'))
# no region NAs

# calculate regional averages
pressures_crops_regions <- pressures_crops_regions %>% 
  group_by(region, SPAM_super, pressure) %>% 
  # count number of pressures used in calculation
  summarise(n = dplyr::n(),
            # calculate means of groupings 
            region_pressure_per_tonne = mean(pressure_per_tonne, na.rm = TRUE)) %>% 
  ungroup() 

pressures_crops_regions_wide <- pressures_crops_regions %>% 
  # remove count column
  select(-n) %>% 
  # pivot wide to merge with other data easily
  pivot_wider(names_from = pressure,
              values_from = region_pressure_per_tonne) %>% 
  rename(region_ghg = ghg,
         region_disturbance = disturbance,
         region_nutrient = nutrient,
         region_water = water)
  
```

### Livestock
```{r}
pressures_livestock <- pressures_per_tonne %>% 
  filter(food_group == "livestock") %>% 
  distinct()

pressures_livestock_wide <- pressures_livestock %>% 
  # pivot wide to simplify join with trade data
  pivot_wider(names_from = pressure,
              values_from = pressure_per_tonne) 

# check for dupes
pressure_livestock_dupes <- pressures_livestock %>%
    dplyr::group_by(iso3c, nceas_group, SPAM_super, item_code, item, food_group, pressure) %>%
    dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%
    dplyr::filter(n > 1L) 

pressure_livestock_codes <- pressures_livestock %>% 
  select(item_code, nceas_group) %>% 
  # there is no associated item code for goats milk
  filter(!is.na(item_code)) %>% 
  distinct()
```

### Marine Fish and FOFM

```{r}
pressures_fish <- pressures_per_tonne %>% 
  filter(food_group == "fisheries and mariculture") 

pressures_fish_wide <- pressures_fish %>% 
  # pivot wide to simplify join with trade data
  pivot_wider(names_from = pressure,
              values_from = pressure_per_tonne) %>% 
  mutate(food_group = "fisheries and mariculture")

# check for dupes
pressures_fish_dupes <- pressures_fish %>% 
  dplyr::group_by(iso3c, nceas_group, SPAM_super, item, item_code, food_group, pressure) %>%
    dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%
    dplyr::filter(n > 1L)
```

## Trade matrix - crops, animals, and fish
Read in the trade data and clean if necessary. 

```{r}
crop_livestock_trade_matrix <- read.csv(paste0(trade_matrix_path, "trade_matrix_by_country_of_origin_2015_2019_import.csv")) %>% 
  # don't need year column
  select(-Year) %>% 
  # rename some columns
  rename(consumer_country_code = Consumer_Country_Code,
         producer_country_code = Producer_Country_Code,
         traded_tonnes = Value,
         item_code = Item_Code) %>% 
  # remove zeros data (removes close to 60,000 rows of data)
  filter(traded_tonnes > 0) 

#  Subset to only crops and livestock (866 == cattle, everything < 866 == non animal product)
crop_trade_matrix <- crop_livestock_trade_matrix %>% 
  filter(item_code < 866)

livestock_trade_matrix <- crop_livestock_trade_matrix %>% 
  filter(item_code >= 866)

fish_marine_trade_matrix <- read.csv(paste0(fish_trade_matrix_path, "fish_trade_matrix_w_unknowns_allocated.csv")) %>% 
  # remove freshwater aquaculture since it is handled in step 03a
  filter(habitat == "marine")

inland_capture_trade_matrix <- read.csv(paste0(fish_trade_matrix_path, "fish_trade_matrix_w_unknowns_allocated.csv")) %>% 
  # inland capture pressures are included in these pressure efficiencies
  filter(habitat == "inland" & method == "capture")

# join marince trade and inland capture trade
fish_trade_matrix <- rbind(fish_marine_trade_matrix, inland_capture_trade_matrix)

fmfo_trade_matrix <- read.csv(paste0(fmfo_trade_matrix_path, "fmfo_trade_matrix_w_unknowns_allocated.csv"))

#old_trade <- read.csv(paste0(trade_matrix_path, "trade_matrix_by_country_of_origin_2017_import.csv"))

```

## Connect trade and pressures
This section will connect trade and pressures based on their broad groups. 

- Crops and livestock trade will be connected to the pressures via the producer country code and the item code
- fish and fmfo trade will be combined and connect to the pressures via their country code and nceas_group category

Set Up country codes and FAO codes to join trade and pressures
```{r}
# read in country codes from FAO detailed trade matrix definitions selecting the partner country group tab (reported country group tab says data unavailable)
country_codes <- read_csv(paste0(code_path, "FAOSTAT_country_codes_8-10-2022.csv"))

# format to match trade matrix variables names
countries <- country_codes %>% 
  select(`Partner Country Code`, `Partner Countries`, `ISO3 Code`) %>% 
  rename('Country_Code' = 'Partner Country Code',
         'Country' = 'Partner Countries',
         'ISO3' = 'ISO3 Code') %>% 
  unique()

# "China, mainland" on the FAO website has the ISO3 code F41.
# China, the aggregated country, has the ISO3 code CHN.
# In the pressures data, they assign China mainland the ISO3 code CHN, so we need to be aware
# of this in the gravity model if we match using ISO3 code. 
# we will keep in line with the pressures data here, and give China mainland the ISO3 code CHN.
countries <- countries %>% 
  mutate(ISO3 = ifelse(Country == "China, mainland", "CHN", ISO3))

# read in data to map item_code from trade_matrix to pressures data
map_to_fao <- read_csv(paste0("/home/shares/food-systems/social_justice_projects/food_trade_pressures/raw_data/Codes/", "MapSPAM_to_FAO_v2.csv")) %>% 
  select(item_code = FAO_item_code, item = product_description_FAOSTAT, SPAM_super) %>% 
  distinct()
```



### Crops
The crop trade data has a number of items/categories that should be removed as they are not considered food so we do not have pressures data for them.

- SPAM_super "ofib" includs fiber crops that are not considered food
- SPAM_super "othr" includes hops, pyrethrum, and rubber
- SPAM_super "teas" includes tea, which are all not considered food
- SPAM_super "toba" includes tobacco, which are all not considered food
- SPAM_super "xcof" includes green coffee, which are all not considered food
- Item "mate" is not considered food
- We do not have pressures for "Chillies and peppers, green"
```{r}
# join the trade matrix with iso3c data
crop_trade_countries <- crop_trade_matrix %>%
  # join with countries data to producer country code
  left_join(countries, by = c("producer_country_code" = "Country_Code")) %>%
  # rename to producer columns
  rename(producer_country = Country, producer_iso3c = ISO3) %>% 
  # relocate to after producer country code
  relocate(c(producer_country, producer_iso3c), .after = producer_country_code) %>% 
  # join with countries data to consumer country code
  left_join(countries, by = c("consumer_country_code" = "Country_Code")) %>%
  # rename to producer colomns
  rename(consumer_country = Country, consumer_iso3c = ISO3) %>% 
  # relocate to after producer country code
  relocate(c(consumer_country, consumer_iso3c), .after = consumer_country_code) %>% 
  # join with FAO SPAM and item_code data
  left_join(map_to_fao, 
            by = "item_code") %>% 
  # remove SPAM_super categories as explained above
  filter(!SPAM_super == "ofib", !SPAM_super == "othr", !SPAM_super == "teas",
         !SPAM_super == "toba", !SPAM_super == "xcof")

# check to see if any country codes didn't match
country_na <- crop_trade_countries %>% 
  filter(is.na(consumer_country) | is.na(producer_country) | is.na(consumer_iso3c) | is.na(producer_iso3c))
# no missing country code data!

```

#### Calculate the total pressures
```{r}
# Join pressures/tonne data based on the producer_iso3c from trader data and the item_code
crop_trade_pressures <- left_join(x = crop_trade_countries, 
                                  y = pressures_crops_wide,
                                  by = c("producer_iso3c" = "iso3c",
                                         # for crops we join by the SPAM_super category
                                         "SPAM_super")) %>% 
  # remove some redundant columns, keep nceas_group for now to check for NAs
  select(- c(consumer_country_code, producer_country_code)) %>% 
  # calculate the total pressure traded by multiplying traded_tonnes by the pressure efficiency
  mutate(disturbance_total = disturbance*traded_tonnes,
         water_total = water*traded_tonnes,
         ghg_total = ghg*traded_tonnes,
         nutrient_total = nutrient*traded_tonnes) %>% 
  # we do not have pressure efficiency data for sugar beet so filter out
  filter(item != "Sugar beet")

```

#### Missing Data Check
NA check for items we do not have pressures for
```{r}
trade_pressures_na <- crop_trade_pressures %>% 
  filter(is.na(nceas_group)) 

# how much of of the original data does this include?
# by quantity?
crop_trade_matrix_test <- crop_livestock_trade_matrix %>% 
  # join with FAO SPAM and item_code data
  left_join(map_to_fao, 
            by = "item_code") %>% 
  # remove SPAM_super categories as explained above
  filter(!SPAM_super == "ofib", !SPAM_super == "othr", !SPAM_super == "teas",
         !SPAM_super == "toba", !SPAM_super == "xcof") %>% 
  filter(item_code < 866) %>% 
  filter(item != "Sugar beet")

nrow(trade_pressures_na)/nrow(crop_trade_matrix_test)
# about 8.9% of the original rows of data

# by volume?
sum(trade_pressures_na$traded_tonnes)/sum(crop_trade_matrix_test$traded_tonnes)
# about 5.6% of total tonnes traded.

# read in item codes from FAO production data
item_codes <- read_csv(paste0(code_path, "FAOSTAT_production_item_codes_8-5-2022.csv"))

# format to match trade matrix
item_codes <- item_codes %>% 
  select("Item Code", Item) %>% 
  rename('item_code' = 'Item Code')

trade_pressures_na_items <- left_join(trade_pressures_na, item_codes, by = "item_code") %>% 
  select(producer_country, producer_iso3c, item_code, Item) %>% 
  distinct()

items_na <- trade_pressures_na_items %>% 
  select(item_code, Item) %>% 
  distinct()
```

We have a number of items that have been traded but do not have pressures associated with them. We will gapfill these pressures using regional averages.

#### Gapfill Crops
```{r, warning=FALSE}
crop_trade_pressures_missing <- crop_trade_pressures %>% 
  # Filter for rows with missing pressures
  filter(is.na(ghg) | is.na(nutrient) | is.na(disturbance) | is.na(water)) %>% 
  # add in regional ids
  # add subregion
  mutate(subregion = countrycode(producer_iso3c, 'iso3c', 'un.regionsub.name')) %>% 
  # add intermediate region
  mutate(intermed_region = countrycode(producer_iso3c, 'iso3c', 'un.regionintermediate.name')) %>% 
  # the intermediate region designation is less broad than subregion
  # make a region column for when there is no intermediate region use the subregion
  mutate(producer_region = case_when(is.na(intermed_region) ~ subregion,
                            TRUE ~ intermed_region)) %>% 
  select(-c(subregion, intermed_region, disturbance_total, water_total, ghg_total, nutrient_total))

# fill in Taiwan Region
crop_trade_pressures_missing$producer_region[crop_trade_pressures_missing$producer_iso3c == "TWN"] <- "Eastern Asia"
# the iso3c code is presumed to be for Kosovo and will therefor have a designation of Southern Europe like neighboring countries
crop_trade_pressures_missing$producer_region[crop_trade_pressures_missing$producer_iso3c == "XKO"] <- "Southern Europe"

# join with regions
crop_trade_pressures_gapfilled <- left_join(x = crop_trade_pressures_missing, 
                                            y = pressures_crops_regions_wide,
                                            by = c("producer_region" = "region",
                                                   # for crops we join by the SPAM_super category
                                                   "SPAM_super")) %>% 
  # gapfill
  mutate(ghg = if_else(condition = is.na(ghg),
                       true = region_ghg,
                       false = ghg),
         disturbance = if_else(condition = is.na(disturbance),
                       true = region_disturbance,
                       false = disturbance),
         water = if_else(condition = is.na(water),
                       true = region_water,
                       false = water),
         nutrient = if_else(condition = is.na(nutrient),
                       true = region_nutrient,
                       false = nutrient)) %>% 
  # remove extra columns for joining back with other data
  select(-c(producer_region, region_disturbance, region_ghg, region_nutrient, region_water)) %>% 
  # calculate the total pressure traded by multiplying traded_tonnes by the pressure efficiency
  mutate(disturbance_total = disturbance*traded_tonnes,
         water_total = water*traded_tonnes,
         ghg_total = ghg*traded_tonnes,
         nutrient_total = nutrient*traded_tonnes)

remaining_na <- crop_trade_pressures_gapfilled %>% 
  # Filter for rows with missing pressures
  filter(is.na(ghg) & is.na(nutrient) & is.na(disturbance) & is.na(water))

nrow(remaining_na)/nrow(crop_trade_matrix_test)
# about 1.5% of the original rows of data

# by volume?
sum(remaining_na$traded_tonnes)/sum(crop_trade_matrix_test$traded_tonnes)
# about 0.7% of total tonnes traded.

# unique(remaining_na$SPAM_super)
```

#### Rejoin gapfilled data
```{r}
# record the number of rows to ensure bind does not result in lost data 
nrow(crop_trade_pressures)

crop_trade_pressures <- crop_trade_pressures %>% 
  # Filter for rows with no missing pressures
  filter(!is.na(ghg) & !is.na(nutrient) & !is.na(disturbance) & !is.na(water)) 

nrow(crop_trade_pressures) + nrow(crop_trade_pressures_gapfilled)

crop_trade_pressures <- rbind(crop_trade_pressures, crop_trade_pressures_gapfilled)
```


### Livestock
```{r}
livestock_trade_countries <- livestock_trade_matrix %>%
  # join with countries data to producer country code
  left_join(countries, by = c("producer_country_code" = "Country_Code")) %>%
  # rename to producer columns
  rename(producer_country = Country, producer_iso3c = ISO3) %>% 
  # relocate to after producer country code
  relocate(c(producer_country, producer_iso3c), .after = producer_country_code) %>% 
  # join with countries data to consumer country code
  left_join(countries, by = c("consumer_country_code" = "Country_Code")) %>%
  # rename to producer columns
  rename(consumer_country = Country, consumer_iso3c = ISO3) %>% 
  # relocate to after producer country code
  relocate(c(consumer_country, consumer_iso3c), .after = consumer_country_code) %>% 
  # removing beeswax, hides, skins, silk-worms, honey, other bird eggs, and meats (nes, ass, camel, duck, game, goose, horse, rabbit, turkey)
  filter(item_code %in% c(pressure_livestock_codes[,1]))
                          
      
# check to see if any country codes didn't match
country_na <- livestock_trade_countries %>% 
  filter(is.na(consumer_country) | is.na(producer_country) | is.na(consumer_iso3c) | is.na(producer_iso3c))
# no missing country code data!

```

#### Calculate the total pressures
```{r}
livestock_trade_pressures <- livestock_trade_countries %>% 
  left_join(pressures_livestock_wide,
            by = c("producer_iso3c" = "iso3c",
                   # for livestock we join by the item_code 
                   "item_code")) %>% 
  # remove some redundant columns, keep nceas_group for now to check for NAs
  select(- c(consumer_country_code, producer_country_code, SPAM_super)) %>% 
  # calculate the total pressure traded by multiplying traded_tonnes by the pressure efficiency
  mutate(disturbance_total = disturbance*traded_tonnes,
         water_total = water*traded_tonnes,
         ghg_total = ghg*traded_tonnes,
         nutrient_total = nutrient*traded_tonnes)
```


```{r}
na_livestock <- livestock_trade_pressures %>% 
  filter(is.na(nceas_group))

# what percentage by volume is NA?
sum(na_livestock$traded_tonnes)/sum(livestock_trade_countries$traded_tonnes)
# <1% by traded tonnes

# what about by number of traded items?
nrow(na_livestock)/nrow(livestock_trade_countries)
# <1% by number of rows

na_livestock_items <- left_join(na_livestock, item_codes, by = "item_code") %>% 
  select(item_code, Item) %>% 
  distinct()
```


### Fish
```{r}
# join the trade matrix with iso3c data
fish_trade_countries <- fish_trade_matrix %>%
  # filter out NEI iso3c code
  filter(consumer_iso3c != "NEI",
         source_country_iso3c != "NEI") %>% 
  # join with countries data to producer iso3c
  left_join(countries %>% 
              select(-Country_Code),
            by = c("source_country_iso3c" = "ISO3")) %>%
  # rename to producer columns
  rename(producer_country = Country, producer_iso3c = source_country_iso3c) %>% 
  # relocate to after producer country code
  relocate(c(producer_country), .after = producer_iso3c) %>% 
  # join with countries data to consumer iso3c
  left_join(countries %>% 
              select(-Country_Code),
            by = c("consumer_iso3c" = "ISO3")) %>%
  # rename to producer columns
  rename(consumer_country = Country, consumer_iso3c = consumer_iso3c) %>% 
  # relocate to after producer country code
  relocate(c(consumer_country), .after = consumer_iso3c) 

# check to see if any country codes didn't match
country_na <- fish_trade_countries %>% 
  filter(is.na(consumer_country) | is.na(producer_country) | is.na(consumer_iso3c) | is.na(producer_iso3c))
# no missing country code data!
```

#### Calculate the total pressures
```{r}
fish_trade_pressures <- fish_trade_countries %>% 
  left_join(pressures_fish_wide,
            by = c("producer_iso3c" = "iso3c",
                   # for fish we join by the nceas_group 
                   "nceas_group")) %>% 
  # remove some redundant columns, keep food_group for now to check for NAs
  select(- c(item, item_code, SPAM_super))
  # # calculate the total pressure traded by multiplying consumption_live_weight_t by the pressure efficiency
  # mutate(disturbance_total = disturbance*consumption_live_weight_t,
  #        water_total = water*consumption_live_weight_t,
  #        ghg_total = ghg*consumption_live_weight_t,
  #        nutrient_total = nutrient*consumption_live_weight_t)
```

```{r}
na_fish <- fish_trade_pressures %>% 
  filter(is.na(food_group))

# what percentage by volume is NA?
sum(na_fish$consumption_live_weight_t)/sum(fish_trade_pressures$consumption_live_weight_t)
# 2.2% by traded tonnes

# what about by number of traded items?
nrow(na_fish)/nrow(fish_trade_pressures)
# 6.6% by number of rows

unique(pressures_fish$nceas_group)

unique(fish_trade_matrix$nceas_group)

```

