---
title: "Adjust the pressures from crop trade matrix used for feed"
author: "Haley Epperly"
date: "2022-11-16"
output: html_document
---

Objective: Attribute consumption pressures for crops and fofm used as feed to the animal consuming country.

## Old description
Follow steps outlined in this issue:
https://github.com/OHI-Science/social_justice_issues/issues/51

Steps:
- Read in trade script by primary product country of origin (from Kastner) for crops and connect to pressures (already completed in script connect_2017_crop_trade_to_pressures)
- Subset into non-feed type crops (apples, etc.) and feed type crops (grains, etc.)
- Aggregate grains (oil crops, pulses, soy and palm kernels don't need to be aggregated because they only have one spam super category)
- Group by consuming and producing countries and then sum tonnes and pressures traded
- Add column with proportion of each aggregate crop each consuming country uses for feed
- Multiply proportion used as feed by total pressures (split into 2 dfs - crop trade matrix connected to pressures used as human food and crop trade matrix connected to pressures used as feed)
Note: data are already grouped by consuming country, producing country, and crop and pressures and tonnes going to feed are summed across those categories

- Read in tonnes crop consumed per animal group per country data https://github.com/OHI-Science/food_systems/blob/master/feed/data/system_country_mapspam_tonnes_consumption.csv
- Subset to 5 feed crop categories we're using and aggregate the grains
- Match animal categories and names to what we're using with FAO data (e.g., milk is combined)
- Group by crop and country and sum tonnes consumption as feed
- Calculate proportion of each crop's consumption that comes from each animal system

- Combine dfs - add variables for animal system and feed proportions per crop to the trade matrix with pressures df (grain producer and grain consumer trade matrix)
- Multiply total pressures per aggregated crop (between each pair of trading partners) by proportion feed going to each animal system

- Read in animal, fw aquaculture, and fish trade matrices and combine into one.
- Merge feed producer/consumer trade matrix with pressures with animal producer/consumer trade matrix with pressures (make sure you have a row for each grain producing, animal producing, and animal consuming country combination)
- Multiply traded feed pressures for each crop, animal system, and trading pair (feed producer and feed consumer) by the proportion of each animal traded between trading pair (animal producer and animal consumer)


- We have 2 dfs that are crops not used for feed (non-feed crops and feed crops not used for feed), we need to put these back together at the end (do we combine these with feed crops after they get correctly distributed?)

## Setup

Load libraries
```{r}
library(tidyverse)
```

Data Paths
```{r}
raw_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/raw_data/"
trade_pressure_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/04b_connect_crop_livestock_oth_fish_pressures/"
feed_prop_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/03a_calc_proportion_feed_per_crop_country/"
animal_consumption_data_path <- paste0(raw_path, "feed_consumption/")
fw_aquaculture_consumption_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/03b_fofm_fw_aquaculture_feed/"
animal_proportions_for_feed_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/03c_calculate_prop_crop_and_fofm_used_for_each_animal/"
save_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/04c_adjust_trade_matrix_pressures_for_feed/"
```

Read in trade_pressures data
```{r}
trade_w_pressures_no_feed <- read_csv(paste0(trade_pressure_path, "trade_w_pressures_no_feed.csv"))

```
## FOFM

FOFM trade is currently broken up by the item description "fofm" and "fofm_feed". "fofm_feed" is all from trade code 230120 which is specified as "unfit for human consumption." Therefore we will assume that all FOFM from that trade is all used for feed of livestock and fish. 

### Separate FOFM from trade data
```{r}
fofm_trade_no_feed_adjustment <-  trade_w_pressures_no_feed %>%
  filter(item == "fofm_feed")
```

### Read in fofm feed proportions for each animal within a country
```{r}
fofm_feed_animal_proportions_wide <- read.csv(paste0(animal_proportions_for_feed_path, "fofm_feed_animal_proportions_wide.csv")) %>% 
  # make zero_test to mark rows where a country has no animal allocation for that crop 
  mutate(zero_test = select(., chickens_eggs:fw_aquaculture_miscellaneous_diadromous_fishes) %>% 
           rowSums(na.rm = TRUE)) %>% 
  # if zero_test is equal to 0 then there is no animal specified
  # and now in our calculation all trade and pressures will go there
  mutate(no_animal_specified = if_else(zero_test == 0,
                                       true = 1,
                                       false = 0)) %>% 
  select(-zero_test) %>% 
  # make feed category "fofm_feed"
  mutate(feed_category = "fofm_feed")

proportions_test <- fofm_feed_animal_proportions_wide %>% 
  pivot_longer(cols = chickens_eggs:fw_aquaculture_miscellaneous_diadromous_fishes,
               names_to = "animal_group",
               values_to = "prop_fofm_feed_per_animal") %>% 
  group_by(iso3c) %>% 
  summarise(sum_test = sum(prop_fofm_feed_per_animal))
```

### Join fofm proportions per animal with the trade data used for feed
Combine dfs - add variables for animal system and feed proportions per crop to the trade matrix with pressures df (fofm producer and fofm consumer trade matrix). By using a left join we may lose data where we have animal proportions for that crop but no trade data of that crop into that country. We are not gapfilling trade data of products so this is just note for methods.

```{r}
fofm_trade_feed <- fofm_trade_no_feed_adjustment %>% 
  select(consumer_iso3c, producer_iso3c, feed_category = item, tonnes_feed = traded_tonnes, 
         water_pressure_feed = water_total, ghg_pressure_feed = ghg_total, 
         nutrient_pressure_feed = nutrient_total, disturbance_pressure_feed = disturbance_total)

summary(fofm_trade_feed) # no NAs

summary(fofm_feed_animal_proportions_wide) # no NAs

# we can't do anything without the pressures data, so left_join
# so any countries where we have feed proportion data but don't 
# have trade of that crop will be lost
fofm_trade_feed_pressures <- left_join(fofm_trade_feed, fofm_feed_animal_proportions_wide, by = c("consumer_iso3c" = "iso3c", "feed_category"))

summary(fofm_trade_feed_pressures) # NAs for 5 rows
# these rows will have fofm go to no_animal_specified

# pivot longer to make calculations simple
fofm_trade_feed_pressures <- fofm_trade_feed_pressures %>% 
  # mutate to make any column with NA in no_animal_specified to 1
  mutate(no_animal_specified = if_else(condition = is.na(no_animal_specified),
                                       true = 1,
                                       false = no_animal_specified)) %>% 
  pivot_longer(cols = chickens_eggs:no_animal_specified,
               names_to = "animal_group",
               values_to = "prop_fofm_feed_per_animal") %>% 
  # remove proportions that are equal to zero or NA
  filter(prop_fofm_feed_per_animal != 0 | !is.na(prop_fofm_feed_per_animal))

```

### Calculate tonnes traded and pressures going to feed to consuming countries
Multiply FOFM pressures (between each pair of trading partners) by proportion feed going to each animal system
```{r}
fofm_trade_feed_pressures_adjusted <- fofm_trade_feed_pressures %>% 
  mutate(tonnes_traded_system_feed = tonnes_feed*prop_fofm_feed_per_animal) %>% 
  mutate(water_traded_system_feed = water_pressure_feed*prop_fofm_feed_per_animal) %>% 
  mutate(nutrient_traded_system_feed = nutrient_pressure_feed*prop_fofm_feed_per_animal) %>% 
  mutate(disturbance_traded_system_feed = disturbance_pressure_feed*prop_fofm_feed_per_animal) %>% 
  mutate(ghg_traded_system_feed = ghg_pressure_feed*prop_fofm_feed_per_animal) 

#check data 
check_props_1 <- fofm_trade_feed_pressures_adjusted %>% 
  group_by(consumer_iso3c, producer_iso3c, feed_category) %>% 
  summarise(sum = sum(prop_fofm_feed_per_animal)) %>% 
  ungroup()
range(check_props_1$sum)

check_props_2 <- check_props_1 %>% 
  select(-producer_iso3c) %>% 
  unique()

```

### Join feed traded for pressures with corressponding livestock and fish trade

Filter trade for animal products and calculate proportion of animal trade from producer to consumer so that fofm feed pressures can go with correct animals.
```{r}
# filter for non-crops and remove FOFM
livestock_fish_trade_raw <- trade_w_pressures_no_feed %>% 
  filter(food_group != "crops") 

livestock_fish_trade_no_fofm_for_proportions <- livestock_fish_trade_raw %>% 
  filter(item != "fofm",
         item != "fofm_feed")
  
livestock_fish_trade_proportions <- livestock_fish_trade_no_fofm_for_proportions %>% 
  # remove pressures for now
  select(-c(disturbance_total, water_total, ghg_total, nutrient_total)) %>% 
  # group by producer country and item to calculate total of item traded by producer
  group_by(producer_iso3c, item) %>% 
  mutate(total_item_tonnes = sum(traded_tonnes, na.rm = TRUE)) %>% 
  ungroup() %>% 
  # calculate proportion traded of item to each consuming country from producer
  mutate(proportion_animal_traded = traded_tonnes/total_item_tonnes) %>% 
  # select specific columns to join with feed trade
  select(animal_producer_iso3c = producer_iso3c, 
         animal_consumer_iso3c = consumer_iso3c, 
         item, proportion_animal_traded)

# livestock_fish_trade_proportions includes some wild capture fish that don't eat feed
# that's not an issue though because we're not changing these pressures, we're 
# just adding new feed pressures on top of these existing animal trade pressures
```

Merge feed producer/consumer trade matrix with pressures with animal producer/consumer trade matrix with pressures (make sure you have a row for each fofm producing, animal producing, and animal consuming country combination).
```{r}
# rename variables
fofm_trade_feed_pressures_adjusted_for_join <- fofm_trade_feed_pressures_adjusted %>%
  select(-c(tonnes_feed,
            water_pressure_feed,
            ghg_pressure_feed,
            nutrient_pressure_feed,
            disturbance_pressure_feed,
            prop_fofm_feed_per_animal)) %>% 
  rename(animal_producer_iso3c = consumer_iso3c,
         feed_producer_iso3c = producer_iso3c,
         product = animal_group)

# left join because this will not discount animal trade but simply directing the feed to the animals it was fed to
fofm_animal_feed_pressures_trade <- left_join(fofm_trade_feed_pressures_adjusted_for_join, 
                                              livestock_fish_trade_proportions, 
                                              by = c("animal_producer_iso3c", "product" = "item"))

# check data
summary(fofm_animal_feed_pressures_trade)

no_feed_data <- fofm_animal_feed_pressures_trade %>% 
  filter(is.na(tonnes_traded_system_feed))
nrow(no_feed_data)
# 0 because we did a left join. Otherwise this would show 
# where we have meat trade between countries but no recorded
# feed for that animal

no_animal_data <- fofm_animal_feed_pressures_trade %>% 
  filter(is.na(proportion_animal_traded))
nrow(no_animal_data)
# 64,304 NAs for proportion_animal_traded - have feed data, but no animal trade data
# (including what a country produces and keeps)
(sum(no_animal_data$tonnes_traded_system_feed)/sum(fofm_animal_feed_pressures_trade$tonnes_traded_system_feed))*100
# this amounts to 0.31% of total trade data.
# we will assume that all of this data stays in the feed consuming country

fofm_animal_feed_pressures_trade <- fofm_animal_feed_pressures_trade %>% 
  # if animal consumer is NA make it the same as feed consumer
  mutate(animal_consumer_iso3c = if_else(condition = is.na(animal_consumer_iso3c),
                                         true = animal_producer_iso3c,
                                         false = animal_consumer_iso3c)) %>% 
  # if animal consumer was NA make 100% of trade within that country
  mutate(proportion_animal_traded = if_else(condition = is.na(proportion_animal_traded),
                                            true = 1,
                                            false = proportion_animal_traded)) 


```

### Adjust feed trade to follow animals trade from animal producing country
Multiply traded feed pressures for each fofm, animal system, and trading pair (feed producer and feed consumer) by the proportion of each animal traded between trading pair (animal producer and animal consumer). As stated above, we are assuming that all feed trade data that does not have matching animal trade data by the feed consuming country will stay within that country for the animal system. This is 0.31% of the total tonnes traded so it is unlikely to have a large impact on overall trends.

```{r}
fofm_animal_feed_pressures_trade_adjusted <- fofm_animal_feed_pressures_trade  %>% 
  mutate(tonnes_traded_feed_producer_animal_consumer = tonnes_traded_system_feed*proportion_animal_traded) %>% 
  mutate(water_pressure_feed_producer_animal_consumer = water_traded_system_feed*proportion_animal_traded) %>% 
  mutate(nutrient_pressure_feed_producer_animal_consumer = nutrient_traded_system_feed*proportion_animal_traded) %>% 
  mutate(disturbance_pressure_feed_producer_animal_consumer = disturbance_traded_system_feed*proportion_animal_traded) %>% 
  mutate(ghg_pressure_feed_producer_animal_consumer = ghg_traded_system_feed*proportion_animal_traded)

# quick visual check data - sum columns made here should be the same
# as corresponding system_feed columns
check_1 <- fofm_animal_feed_pressures_trade_adjusted %>% 
  group_by(animal_producer_iso3c, feed_producer_iso3c, feed_category, product, tonnes_traded_system_feed, water_traded_system_feed, nutrient_traded_system_feed, disturbance_traded_system_feed,
           ghg_traded_system_feed) %>% 
  summarise(sum_trade = sum(tonnes_traded_feed_producer_animal_consumer),
            sum_water = sum(water_pressure_feed_producer_animal_consumer),
            sum_nutrient = sum(nutrient_pressure_feed_producer_animal_consumer),
            sum_dist = sum(disturbance_pressure_feed_producer_animal_consumer),
            sum_ghg = sum(ghg_pressure_feed_producer_animal_consumer)) %>% 
  ungroup()

```

Time to take out the middle man. 
Group by feed producing country, feed_category, animal category, and animal_consuming country and sum pressures
```{r}
# rename product to animal product
fofm_animal_feed_pressures_trade_totals <- fofm_animal_feed_pressures_trade_adjusted %>% 
  rename(animal_product = product) %>%  
  group_by(feed_producer_iso3c, animal_consumer_iso3c, feed_category, animal_product) %>% 
  summarise(sum_trade = sum(tonnes_traded_feed_producer_animal_consumer),
            sum_water = sum(water_pressure_feed_producer_animal_consumer),
            sum_ghg = sum(ghg_pressure_feed_producer_animal_consumer),
            sum_nutrient = sum(nutrient_pressure_feed_producer_animal_consumer),
            sum_disturbance = sum(disturbance_pressure_feed_producer_animal_consumer)) %>% 
  ungroup()
```

So now feed fofm tonnage and pressures traded from a fofm producing country to an animal producing country and used for feed are traded to the country that consumes that animal.

### Stopped here

## Crops

### Separate Crops into feed and not feed from trade

Subset into non-feed type crops (apples, etc.) and feed type crops (grains, etc.)
```{r}
feed_crops <- trade_w_pressures_no_feed %>% 
  # filter for crops
  filter(food_group == "crops") %>% 
  # filter for SPAM_super categories of feed
  filter(SPAM_super == "barl" | SPAM_super == "maiz" | SPAM_super == "ocer" | SPAM_super == "rice" |
           SPAM_super == "sorg" | SPAM_super == "whea" | SPAM_super == "xmil" | SPAM_super == "soyb" |
           SPAM_super == "xoil" | SPAM_super == "oilp" | SPAM_super == "xpul")

table(feed_crops$SPAM_super)

non_feed_crops <- trade_w_pressures_no_feed %>% 
  # filter for crops
  filter(food_group == "crops") %>% 
  filter(!SPAM_super %in% feed_crops$SPAM_super)

table(non_feed_crops$SPAM_super)
```


Aggregate grains (oil crops, pulses, soy and palm kernels don't need to be aggregated because they only have one spam super category).
Group by consuming and producing countries and then sum tonnes and pressures traded for each feed category.
```{r}
# Note: These groups are already aggregated in the "GROUP" category, but oilcrops include soyb, xoil, and oilp all combined, so we need to make a new variable with the groupings we want.
feed_crops <- feed_crops %>% 
  mutate(feed_category = case_when(SPAM_super == "barl" ~ "grain",
                                   SPAM_super == "maiz" ~ "grain",
                                   SPAM_super == "ocer" ~ "grain",
                                   SPAM_super == "rice" ~ "grain",
                                   SPAM_super == "sorg" ~ "grain",
                                   SPAM_super == "whea" ~ "grain",
                                   SPAM_super == "xmil" ~ "grain",
                                   SPAM_super == "soyb" ~ "soybean",
                                   SPAM_super == "xoil" ~ "oilcrop",
                                   SPAM_super == "oilp" ~ "palmoil",
                                   SPAM_super == "xpul" ~ "pulse",
                                   TRUE ~ as.character(NA)))
table(feed_crops$feed_category)
summary(feed_crops)

# calculated the aggregate feed_category group total trade and pressures
feed_crops_agg <- feed_crops %>% 
  group_by(consumer_country, consumer_iso3c, producer_country, producer_iso3c, feed_category) %>% 
  summarise(traded_tonnes = sum(traded_tonnes, na.rm = TRUE),
            water_total = sum(water_total, na.rm = TRUE),
            ghg_total = sum(ghg_total, na.rm = TRUE),
            disturbance_total = sum(disturbance_total, na.rm = TRUE),
            nutrient_total = sum(nutrient_total, na.rm = TRUE)) %>% 
  ungroup()
#summary(feed_crops_agg)

## check data
sum(feed_crops$traded_tonnes)
sum(feed_crops_agg$traded_tonnes)
# same

sum(feed_crops$disturbance_total, na.rm = TRUE)
sum(feed_crops_agg$disturbance_total, na.rm = TRUE)
# same

sum(feed_crops$ghg_total, na.rm = TRUE)
sum(feed_crops_agg$ghg_total, na.rm = TRUE)
# same

sum(feed_crops$nutrient_total, na.rm = TRUE)
sum(feed_crops_agg$nutrient_total, na.rm = TRUE)
# same

sum(feed_crops$water_total, na.rm = TRUE)
sum(feed_crops_agg$water_total, na.rm = TRUE)
# same
```

To turn the feed_crops that will not be used for feed back into their original items we will calculate proportions below of how much each item contributes to the total feed category.
```{r}
feed_crops_item_proportions <- feed_crops %>% 
  group_by(consumer_country, consumer_iso3c, producer_country, producer_iso3c, feed_category) %>% 
  # calculate the total of each feed_category is traded from producer to consumer
  mutate(feed_cat_traded_tonnes = sum(traded_tonnes, na.rm = TRUE),
         feed_cat_water_total = sum(water_total, na.rm = TRUE),
         feed_cat_ghg_total = sum(ghg_total, na.rm = TRUE),
         feed_cat_disturbance_total = sum(disturbance_total, na.rm = TRUE),
         feed_cat_nutrient_total = sum(nutrient_total, na.rm = TRUE)) %>% 
  ungroup() %>% 
  # now calculate the proportion of each item contributes to the feed category traded to the consuming country from the specific producer
  group_by(consumer_country, consumer_iso3c, producer_country, producer_iso3c, item_code, item, SPAM_super) %>% 
  # if value is zero make the proportion zero
  summarise(traded_tonnes_proportion = if_else(condition = traded_tonnes == 0,
                                               true = 0,
                                               false = traded_tonnes/feed_cat_traded_tonnes),
            water_proportion = if_else(condition = water_total == 0,
                                               true = 0,
                                               false = water_total/feed_cat_water_total),
            ghg_proportion = if_else(condition = ghg_total == 0,
                                               true = 0,
                                               false = ghg_total/feed_cat_ghg_total),
            disturbance_proportion = if_else(condition = disturbance_total == 0,
                                               true = 0,
                                               false = disturbance_total/feed_cat_disturbance_total),
            nutrient_proportion = if_else(condition = nutrient_total == 0,
                                               true = 0,
                                               false = nutrient_total/feed_cat_nutrient_total)) %>% 
  ungroup()

# add back in feed categories to join with feed_crops_not_used_for_feed
feed_crops_item_proportions <- feed_crops_item_proportions %>% 
  mutate(feed_category = case_when(SPAM_super == "barl" ~ "grain",
                                   SPAM_super == "maiz" ~ "grain",
                                   SPAM_super == "ocer" ~ "grain",
                                   SPAM_super == "rice" ~ "grain",
                                   SPAM_super == "sorg" ~ "grain",
                                   SPAM_super == "whea" ~ "grain",
                                   SPAM_super == "xmil" ~ "grain",
                                   SPAM_super == "soyb" ~ "soybean",
                                   SPAM_super == "xoil" ~ "oilcrop",
                                   SPAM_super == "oilp" ~ "palmoil",
                                   SPAM_super == "xpul" ~ "pulse",
                                   TRUE ~ as.character(NA)))
  
```

Add column with proportion of each crop each consuming country uses for feed
```{r}
# Read in proportion aggregated crops used as feed by country
prop_feed_raw <- read_csv(paste0(feed_prop_path, "all_crops_perc_feed.csv"))

# convert to long format
prop_feed <- prop_feed_raw %>% 
  select(- c(Area, region)) %>% 
  pivot_longer(!c(iso3), names_to = "category", values_to = "prop_feed") %>% 
  mutate(category = case_when(category == "grain_prop_feed_gf" ~ "grain",
                              category == "pulses_prop_feed_gf" ~ "pulse",
                              category == "oil_prop_feed_gf" ~ "oilcrop",
                              category == "soy_prop_feed_gf" ~ "soybean",
                              category == "pk_prop_feed_gf" ~ "palmoil",
                              TRUE ~ as.character(NA)))

feed_crops_w_prop <- left_join(feed_crops_agg, prop_feed, by = c("consumer_iso3c" = "iso3", "feed_category" = "category"))

summary(feed_crops_w_prop)

sum(feed_crops_w_prop$traded_tonnes)
sum(feed_crops$traded_tonnes)
# same!

```


Multiply proportion used as feed by total pressures (split into 2 dfs here, crop trade matrix connected to pressures used as human food and crop trade matrix connected to pressures used as feed)
```{r}
feed_crops_used_for_feed <- feed_crops_w_prop %>% 
  mutate(tonnes_feed = traded_tonnes*prop_feed) %>% 
  mutate(water_pressure_feed = water_total*prop_feed) %>% 
  mutate(nutrient_pressure_feed = nutrient_total*prop_feed) %>% 
  mutate(ghg_pressure_feed = ghg_total*prop_feed) %>% 
  mutate(disturbance_pressure_feed = disturbance_total*prop_feed)

feed_crops_not_used_for_feed <- feed_crops_w_prop %>% 
  mutate(tonnes_not_feed = traded_tonnes*(1-prop_feed)) %>% 
  mutate(water_pressure_not_feed = water_total*(1-prop_feed)) %>% 
  mutate(nutrient_pressure_not_feed = nutrient_total*(1-prop_feed)) %>% 
  mutate(ghg_pressure_not_feed = ghg_total*(1-prop_feed)) %>% 
  mutate(disturbance_pressure_not_feed = disturbance_total*(1-prop_feed))

# check
sum(feed_crops_w_prop$traded_tonnes)
sum(feed_crops_used_for_feed$tonnes_feed) + sum(feed_crops_not_used_for_feed$tonnes_not_feed)
# same 

sum(feed_crops_w_prop$water_total)
sum(feed_crops_used_for_feed$water_pressure_feed) + sum(feed_crops_not_used_for_feed$water_pressure_not_feed)
# same
sum(feed_crops_w_prop$nutrient_total)
sum(feed_crops_used_for_feed$nutrient_pressure_feed) + sum(feed_crops_not_used_for_feed$nutrient_pressure_not_feed)
# same
sum(feed_crops_w_prop$ghg_total)
sum(feed_crops_used_for_feed$ghg_pressure_feed) + sum(feed_crops_not_used_for_feed$ghg_pressure_not_feed)
# same
sum(feed_crops_w_prop$disturbance_total)
sum(feed_crops_used_for_feed$disturbance_pressure_feed) + sum(feed_crops_not_used_for_feed$disturbance_pressure_not_feed)
# same
```

Convert crops not used for feed back into items
```{r}
# join feed category item proportions with crops not used for feed
feed_crops_not_used_for_feed_back_to_items <- left_join(x = feed_crops_item_proportions,
                                                        y = feed_crops_not_used_for_feed %>% 
                                                          # remove extra columns
                                                          select(-c(traded_tonnes, water_total, ghg_total, disturbance_total, nutrient_total)),
                                                        by = c("consumer_country", "consumer_iso3c", "producer_country", "producer_iso3c", "feed_category"))

# using the proportions and tonnes/pressures not used for feed calculate the items traded totals
feed_crops_not_used_for_feed_back_to_items <- feed_crops_not_used_for_feed_back_to_items %>% 
  mutate(tonnes_traded = traded_tonnes_proportion*tonnes_not_feed,
         ghg_total = ghg_proportion*ghg_pressure_not_feed,
         water_total = water_proportion*water_pressure_not_feed,
         nutrient_total = nutrient_proportion*nutrient_pressure_not_feed,
         disturbance_total = disturbance_proportion*disturbance_pressure_not_feed) %>%
  # remove proportions columns
  select(-c(traded_tonnes_proportion, ghg_proportion, water_proportion, nutrient_proportion, disturbance_proportion),
         # remove not used for feed columns,
         -c(tonnes_not_feed, ghg_pressure_not_feed, water_pressure_not_feed, nutrient_pressure_not_feed, disturbance_pressure_not_feed))

# check
sum(feed_crops_w_prop$traded_tonnes)
sum(feed_crops_used_for_feed$tonnes_feed) + sum(feed_crops_not_used_for_feed_back_to_items$tonnes_traded)
# same 

sum(feed_crops_w_prop$water_total)
sum(feed_crops_used_for_feed$water_pressure_feed) + sum(feed_crops_not_used_for_feed_back_to_items$water_total)
# same
sum(feed_crops_w_prop$nutrient_total)
sum(feed_crops_used_for_feed$nutrient_pressure_feed) + sum(feed_crops_not_used_for_feed_back_to_items$nutrient_total)
# same
sum(feed_crops_w_prop$ghg_total)
sum(feed_crops_used_for_feed$ghg_pressure_feed) + sum(feed_crops_not_used_for_feed_back_to_items$ghg_total)
# same
sum(feed_crops_w_prop$disturbance_total)
sum(feed_crops_used_for_feed$disturbance_pressure_feed) + sum(feed_crops_not_used_for_feed_back_to_items$disturbance_total)
# same
```


Note: data are already grouped by consuming country, producing country, and crop so pressures and tonnes going to feed are summed across those categories

### Read in crop feed proportions for each animal within a country
```{r}
crop_feed_animal_proportions_wide <- read.csv(paste0(animal_proportions_for_feed_path, "crop_feed_animal_proportions_wide.csv")) %>% 
  # make zero_test to mark rows where a country has no animal allocation for that crop 
  mutate(zero_test = select(., buffaloes_milk:fw_aquaculture_miscellaneous_diadromous_fishes) %>% 
           rowSums(na.rm = TRUE)) %>% 
  # if zero_test is equal to 0 then there is no animal specified
  # and now in our calculation all trade and pressures will go there
  mutate(no_animal_specified = if_else(zero_test == 0,
                                       true = 1,
                                       false = 0)) %>% 
  select(-zero_test)
```

### Join crop proportions per animal with the trade data used for feed
Combine dfs - add variables for animal system and feed proportions per crop to the trade matrix with pressures df (grain producer and grain consumer trade matrix). By using a left join we may lose data where we have animal proportions for that crop but no trade data of that crop into that country. We are not gapfilling trade data of products so this is just note for methods.
```{r}
feed_crops_used_for_feed <- feed_crops_used_for_feed %>% 
  select(consumer_iso3c, producer_iso3c, feed_category, tonnes_feed, water_pressure_feed, ghg_pressure_feed, nutrient_pressure_feed, disturbance_pressure_feed)

#summary(feed_crops_used_for_feed) # no NAs

#summary(crop_feed_animal_proportions_wide) # no NAs

# we can't do anything without the pressures data, so left_join
# so any countries where we have feed proportion data but don't 
# have trade of that crop will be lost
crop_feed_pressures <- left_join(feed_crops_used_for_feed, crop_feed_animal_proportions_wide, by = c("consumer_iso3c" = "iso3c", "feed_category"))

#summary(crop_feed_pressures) # no NAs

# pivot longer to make calculations simple
crop_feed_pressures <- crop_feed_pressures %>% 
  pivot_longer(cols = buffaloes_milk:no_animal_specified,
               names_to = "animal_group",
               values_to = "prop_crop_feed_per_animal") %>% 
  # remove proportions that are equal to zero
  filter(prop_crop_feed_per_animal != 0)

```


### Calculate tonnes traded and pressures going to feed to consuming countries
Multiply pressures per aggregated crop (between each pair of trading partners) by proportion feed going to each animal system
```{r}
crop_feed_pressures_adjusted <- crop_feed_pressures %>% 
  mutate(tonnes_traded_system_feed = tonnes_feed*prop_crop_feed_per_animal) %>% 
  mutate(water_traded_system_feed = water_pressure_feed*prop_crop_feed_per_animal) %>% 
  mutate(nutrient_traded_system_feed = nutrient_pressure_feed*prop_crop_feed_per_animal) %>% 
  mutate(disturbance_traded_system_feed = disturbance_pressure_feed*prop_crop_feed_per_animal) %>% 
  mutate(ghg_traded_system_feed = ghg_pressure_feed*prop_crop_feed_per_animal) 

#check data 
check_props_1 <- crop_feed_pressures_adjusted %>% 
  group_by(consumer_iso3c, producer_iso3c, feed_category) %>% 
  summarise(sum = sum(prop_crop_feed_per_animal)) %>% 
  ungroup()
range(check_props_1$sum)

check_props_2 <- check_props_1 %>% 
  select(-producer_iso3c) %>% 
  unique()
range(check_props_2$sum)

```

Note: The below data check shows there is a small difference between the total water pressures before joining with the animal proportions compared to after. As this is a small value we will assume it is a rounding error introduced from R and the proportions.

```{r}
# wherever check_props_2$sum == 0, there will be a discrepancy with pressures/trade data
# for example, in tonnes_feed_consumed, for ALB and palmoil, the tonnes_feed is 0 for all animal groups
# this makes the proportion of palmoil going to animal feed = 0 for each animal group
# so when we combine it with pressures, which say 21.933962% of palmoil goes to feed in Albania (in feed_crop_w_prop_1)
# and has associated pressures, those pressures are deleted when we multiply by 0% of each animal system
# consuming the palm oil

# Options:
# 1. Calculate what percent of the pressures we're losing and if it's small, then ignore these rows
# 2. For all rows where check_props_2$sum == 0, assume each animal group is consuming an equal
# proportion of the crops (e.g., cows consume 33% of grains, chickens consume 33% of grains, pigs consume 33% of grains)
# This is probably a bigger assumption than just ignoring those rows though so going with option 1 for now


# what percent of traded tonnes changed?
sum(crop_feed_pressures_adjusted$tonnes_traded_system_feed)
sum(feed_crops_used_for_feed$tonnes_feed)
((sum(feed_crops_used_for_feed$tonnes_feed) - sum(crop_feed_pressures_adjusted$tonnes_traded_system_feed))/sum(feed_crops_used_for_feed$tonnes_feed))*100 # 0!

# water
sum(crop_feed_pressures_adjusted$water_traded_system_feed)
sum(feed_crops_used_for_feed$water_pressure_feed)
((sum(feed_crops_used_for_feed$water_pressure_feed) - sum(crop_feed_pressures_adjusted$water_traded_system_feed))/sum(feed_crops_used_for_feed$water_pressure_feed))*100 # -1.675025e-14% we will ignore this.

# ghg
sum(crop_feed_pressures_adjusted$ghg_traded_system_feed)
sum(feed_crops_used_for_feed$ghg_pressure_feed)
((sum(feed_crops_used_for_feed$ghg_pressure_feed) - sum(crop_feed_pressures_adjusted$ghg_traded_system_feed))/sum(feed_crops_used_for_feed$ghg_pressure_feed))*100 # 0!

# nutrient
sum(crop_feed_pressures_adjusted$nutrient_traded_system_feed)
sum(feed_crops_used_for_feed$nutrient_pressure_feed)
((sum(feed_crops_used_for_feed$nutrient_pressure_feed) - sum(crop_feed_pressures_adjusted$nutrient_traded_system_feed))/sum(feed_crops_used_for_feed$nutrient_pressure_feed))*100 # 0!

# disturbance
sum(crop_feed_pressures_adjusted$disturbance_traded_system_feed)
sum(feed_crops_used_for_feed$disturbance_pressure_feed)
((sum(feed_crops_used_for_feed$disturbance_pressure_feed) - sum(crop_feed_pressures_adjusted$disturbance_traded_system_feed))/sum(feed_crops_used_for_feed$disturbance_pressure_feed))*100 # 0!
```


### Join feed traded for pressures with corressponding livestock and fish trade

Filter trade for animal products and calculate proportion of animal trade from producer to consumer so that feed pressures can go with correct animals.
```{r}
# filter for non-crops and remove FOFM
livestock_fish_trade_raw <- trade_w_pressures_no_feed %>% 
  filter(food_group != "crops") 

livestock_fish_trade_no_fofm_for_proportions <- livestock_fish_trade_raw %>% 
  filter(item != "fofm",
         item != "fofm_feed")
  
livestock_fish_trade_proportions <- livestock_fish_trade_no_fofm_for_proportions %>% 
  # remove pressures for now
  select(-c(disturbance_total, water_total, ghg_total, nutrient_total)) %>% 
  # group by producer country and item to calculate total of item traded by producer
  group_by(producer_iso3c, item) %>% 
  mutate(total_item_tonnes = sum(traded_tonnes, na.rm = TRUE)) %>% 
  ungroup() %>% 
  # calculate proportion traded of item to each consuming country from producer
  mutate(proportion_animal_traded = traded_tonnes/total_item_tonnes) %>% 
  # select specific columns to join with feed trade
  select(animal_producer_iso3c = producer_iso3c, 
         animal_consumer_iso3c = consumer_iso3c, 
         item, proportion_animal_traded)

# livestock_fish_trade_proportions includes some wild capture fish that don't eat feed
# that's not an issue though because we're not changing these pressures, we're 
# just adding new feed pressures on top of these existing animal trade pressures
```

Merge feed producer/consumer trade matrix with pressures with animal producer/consumer trade matrix with pressures (make sure you have a row for each grain producing, animal producing, and animal consuming country combination).
```{r}
# rename variables
crop_feed_pressures_adjusted_for_join <- crop_feed_pressures_adjusted %>%
  select(-c(tonnes_feed,
            water_pressure_feed,
            ghg_pressure_feed,
            nutrient_pressure_feed,
            disturbance_pressure_feed,
            prop_crop_feed_per_animal)) %>% 
  rename(animal_producer_iso3c = consumer_iso3c,
         feed_producer_iso3c = producer_iso3c,
         product = animal_group)

# left join because this will not discount animal trade but simply directing the feed to the animals it was fed to
animal_feed_pressures_trade <- left_join(crop_feed_pressures_adjusted_for_join, 
                                         livestock_fish_trade_proportions, 
                                         by = c("animal_producer_iso3c", "product" = "item"))

# check data
summary(animal_feed_pressures_trade)

no_feed_data <- animal_feed_pressures_trade %>% 
  filter(is.na(tonnes_traded_system_feed))
nrow(no_feed_data)
# 0 because we did a left join. Otherwise this would show 
# where we have meat trade between countries but no recorded
# feed for that animal

no_animal_data <- animal_feed_pressures_trade %>% 
  filter(is.na(proportion_animal_traded))
nrow(no_animal_data)
# 59,817 NAs for proportion_animal_traded - have feed data, but no animal trade data
# (including what a country produces and keeps)
(sum(no_animal_data$tonnes_traded_system_feed)/sum(animal_feed_pressures_trade$tonnes_traded_system_feed))*100
# this amounts to 0.01% of total trade data.
# we will assume that all of this data stays in the feed consuming country

animal_feed_pressures_trade <- animal_feed_pressures_trade %>% 
  # if animal consumer is NA make it the same as feed consumer
  mutate(animal_consumer_iso3c = if_else(condition = is.na(animal_consumer_iso3c),
                                         true = animal_producer_iso3c,
                                         false = animal_consumer_iso3c)) %>% 
  # if animal consumer was NA make 100% of trade within that country
  mutate(proportion_animal_traded = if_else(condition = is.na(proportion_animal_traded),
                                            true = 1,
                                            false = proportion_animal_traded)) 


```

### Adjust feed trade to follow animals trade from animal producing country
Multiply traded feed pressures for each crop, animal system, and trading pair (feed producer and feed consumer) by the proportion of each animal traded between trading pair (animal producer and animal consumer). As stated above, we are assuming that all feed trade data that does not have matching animal trade data by the feed consuming country will stay within that country for the animal system. This is 0.01% of the total tonnes traded so it is unlikely to have a large impact on overall trends.

```{r}
animal_feed_pressures_trade_adjusted <- animal_feed_pressures_trade  %>% 
  mutate(tonnes_traded_feed_producer_animal_consumer = tonnes_traded_system_feed*proportion_animal_traded) %>% 
  mutate(water_pressure_feed_producer_animal_consumer = water_traded_system_feed*proportion_animal_traded) %>% 
  mutate(nutrient_pressure_feed_producer_animal_consumer = nutrient_traded_system_feed*proportion_animal_traded) %>% 
  mutate(disturbance_pressure_feed_producer_animal_consumer = disturbance_traded_system_feed*proportion_animal_traded) %>% 
  mutate(ghg_pressure_feed_producer_animal_consumer = ghg_traded_system_feed*proportion_animal_traded)

# check data
check_1 <- animal_feed_pressures_trade_adjusted %>% 
  group_by(animal_producer_iso3c, feed_producer_iso3c, feed_category, product, tonnes_traded_system_feed, water_traded_system_feed, nutrient_traded_system_feed, disturbance_traded_system_feed,
           ghg_traded_system_feed) %>% 
  summarise(sum_trade = sum(tonnes_traded_feed_producer_animal_consumer),
            sum_water = sum(water_pressure_feed_producer_animal_consumer),
            sum_nutrient = sum(nutrient_pressure_feed_producer_animal_consumer),
            sum_dist = sum(disturbance_pressure_feed_producer_animal_consumer),
            sum_ghg = sum(ghg_pressure_feed_producer_animal_consumer)) %>% 
  ungroup()

```

Time to take out the middle man. 
Group by feed producing country, feed_category, animal category, and animal_consuming country and sum pressures
```{r}
# rename product to animal product
animal_feed_pressures_trade_totals <- animal_feed_pressures_trade_adjusted %>% 
  rename(animal_product = product) %>%  
  group_by(feed_producer_iso3c, animal_consumer_iso3c, feed_category, animal_product) %>% 
  summarise(sum_trade = sum(tonnes_traded_feed_producer_animal_consumer),
            sum_water = sum(water_pressure_feed_producer_animal_consumer),
            sum_ghg = sum(ghg_pressure_feed_producer_animal_consumer),
            sum_nutrient = sum(nutrient_pressure_feed_producer_animal_consumer),
            sum_disturbance = sum(disturbance_pressure_feed_producer_animal_consumer)) %>% 
  ungroup()
```

So now feed crop tonnage and pressures traded from a crop producing country to an animal producing country and used for feed are traded to the country that consumes that animal.

### Join non-feed crops (non_feed_crops) and feed crops used not as feed (feed_crops_not_used_for_feed)
Joining this data back together is all crops traded and not used for feed purposes

```{r}
# format data so they can be row bound (rbind)
non_feed_crops <- non_feed_crops %>% 
  select(consumer_iso3c, producer_iso3c, item, SPAM_super, food_group, traded_tonnes, ghg_total, water_total, nutrient_total, disturbance_total)

feed_crops_not_used_for_feed_back_to_items <- feed_crops_not_used_for_feed_back_to_items %>% 
  select(consumer_iso3c, producer_iso3c, item, SPAM_super, traded_tonnes = tonnes_traded, ghg_total, water_total, nutrient_total, disturbance_total) %>% 
  mutate(food_group = "crops", .after = SPAM_super)

# bind together
non_feed_crops_joined <- rbind(non_feed_crops, feed_crops_not_used_for_feed_back_to_items)

```

## Combine fofm feed, non-feed crops trade, animal feed trade, and animal (capture fisheries, mariculture, aquaculture, livestock) trade into one trade matrix that accounts for traded feed pressures.
```{r}
# non_feed_crops_joined
# animal_feed_pressures_trade_totals
# livestock_fish_trade_raw
# fofm_animal_feed_pressures_trade_totals

# format data so we can rbind it
# order = producer, consumer, item, food_group, tonnes traded, ghg, water, nutrient, disturbance

## crop items not used for feed
non_feed_crops_trade_pressures_for_final <- non_feed_crops_joined %>% 
  select(producer_iso3c, consumer_iso3c, item, food_group,
         tonnes_traded = traded_tonnes, 
         ghg_traded = ghg_total, 
         water_traded = water_total,
         nutrient_traded = nutrient_total, 
         disturbance_traded = disturbance_total)

summary(non_feed_crops_trade_pressures_for_final) # no NAs

## fofm used for feed
fofm_animal_feed_pressures_trade_for_final <- fofm_animal_feed_pressures_trade_totals %>% 
  mutate(item = paste0(feed_category, "_for_", animal_product),
         food_group = "fofm_feed") %>% 
  select(-c(feed_category, animal_product)) %>% 
  select(producer_iso3c = feed_producer_iso3c,
         consumer_iso3c = animal_consumer_iso3c,
         item, food_group,
         tonnes_traded = sum_trade,
         ghg_traded = sum_ghg,
         water_traded = sum_water,
         nutrient_traded = sum_nutrient,
         disturbance_traded = sum_disturbance) 

summary(fofm_animal_feed_pressures_trade_for_final)

## crops used for animal feed per animal
animal_feed_pressures_trade_for_final <- animal_feed_pressures_trade_totals %>% 
  mutate(item = paste0(feed_category, "_feed_for_", animal_product),
         food_group = "crop_feed") %>% 
  select(-c(feed_category, animal_product)) %>% 
  select(producer_iso3c = feed_producer_iso3c,
         consumer_iso3c = animal_consumer_iso3c,
         item, food_group,
         tonnes_traded = sum_trade,
         ghg_traded = sum_ghg,
         water_traded = sum_water,
         nutrient_traded = sum_nutrient,
         disturbance_traded = sum_disturbance) 

summary(animal_feed_pressures_trade_for_final)

## livestock and fish trade - no FOFM for now because tbd how to divide up
livestock_fish_trade_pressures_for_final <- livestock_fish_trade_raw %>% 
  # remove fofm_feed item as it has been accounted for in fofm_animal_feed_pressures_trade_for_final
  filter(item != "fofm_feed") %>% 
  select(producer_iso3c, consumer_iso3c, item, food_group,
         tonnes_traded = traded_tonnes, 
         ghg_traded = ghg_total, 
         water_traded = water_total,
         nutrient_traded = nutrient_total, 
         disturbance_traded = disturbance_total)
summary(livestock_fish_trade_pressures_for_final)

# rbind dfs together
trade_matrix_w_pressures_accounting_for_feed <- rbind(non_feed_crops_trade_pressures_for_final, animal_feed_pressures_trade_for_final, livestock_fish_trade_pressures_for_final, fofm_animal_feed_pressures_trade_for_final)

# check data 
check_trade <- trade_w_pressures_no_feed 

sum(trade_matrix_w_pressures_accounting_for_feed$tonnes_traded)
sum(check_trade$traded_tonnes)
# no rounded difference
sum(check_trade$traded_tonnes) - sum(trade_matrix_w_pressures_accounting_for_feed$tonnes_traded) # pretty much zero!

```

## Save!
```{r}
# save csv
write_csv(trade_matrix_w_pressures_accounting_for_feed, paste0(save_path, "trade_matrix_w_pressures_accounting_for_feed.csv"))
```