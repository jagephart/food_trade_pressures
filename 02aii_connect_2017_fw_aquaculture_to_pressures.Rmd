---
title: "connect_2017_fw_aquaculture_to_pressures"
author: "Haley Epperly"
date: "2022-11-17"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
```

File paths
```{r}
raw_data_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/raw_data/"
aquatic_trade_data_path <- paste0(raw_data_path,"trade/aquatic_food_trade/")
pressures_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/02ai_fw_aquaculture_pressures/"
save_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/02aii_connect_2017_fw_aquaculture_to_pressures/"
```

## Method update with new data
```{r}
trade_matrix_raw <- read_csv(paste0(aquatic_trade_data_path, "20230420_nceas_consumption.csv")) # read in the updated data

fw_trade_clean <- trade_matrix_raw %>% 
  filter(!source_country_iso3c == "unknown",              # filter out data with unknown source country
         habitat == "inland" & method == "aquaculture")   # only want inland aquaculture to accurately allocate freshwater (inland) aquaculture pressures
```

For each fish producing/catching country, calculate the proportion of each organism (using nceas categories) that they trade with each consuming country (e.g., trade 5% of tuna with country B, 7% with country C, etc.)
```{r}
fw_trade_proportions <- fw_trade_clean %>% 
  group_by(source_country_iso3c, consumer_iso3c, nceas_group) %>% 
  summarise(traded_tons = sum(consumption_live_weight_t, na.rm = TRUE)) %>%     # sum the total tons of nceas_group for each consumer country from the source
  ungroup() %>%                                                                 # ungroup for further calcs
  group_by(source_country_iso3c, nceas_group) %>% 
  mutate(sum_caught = sum(traded_tons, na.rm = TRUE)) %>%                       # sum the total tons farmed by species for each source country
  ungroup() %>%                                                                 # ungroup for further calcs
  mutate(proportion_traded = traded_tons/sum_caught)                            # calculate proportions of catch from source country goes to consumer country

# check that proportions sum to 1 for each animal product in each producing country
# check_props <- fw_trade_proportions %>% 
#   group_by(source_country_iso3c, nceas_group) %>% 
#   summarise(sum = sum(proportion_traded))
# 
# unique(check_props$sum)                                                         # only 1s so the proportions are calculated correctly
```

Read in freshwater aquaculture pressures data from Mel - calculated in step 02ai

```{r}
pressure <- read_csv(paste0(pressures_path, "fw_aquaculture_pressures.csv"))
```


Compare species groups - these are extremely different. 
```{r}
table(pressure$stressor_group)
table(fw_trade_proportions$nceas_group)
```


Investigating salmon to make sure Salmons, trouts, smelts are all inland aquaculture and don't include marine species.
Salmonids are all marine aquaculture, so Salmons, trouts, smelts is probably just inland.
```{r}
salmonid <- trade_matrix_raw %>% 
  filter(nceas_group=="salmonids")
salmon <- trade_matrix_raw %>% 
  filter(nceas_group=="salmons, trouts, smelts")
```


From Mel - for original data (left is trade matrix categories, right is pressures categories):
Carps, barbels and other cyprinids = oth_carp + hypoph_carp
Miscellaneous diadromous fishes = misc_diad + milkfish
Salmons, trouts, smelts = trout
Miscellaneous freshwater fishes = catfish
Tilapias and other cichlids = tilapia

Mel's key - updated data (left is trade matrix categories, right is pressures categories):
oth_carp = oth_carp 
hypoph_carp = hypoph_carp
miscellaneous diadromous fishes = misc_diad + milkfish
salmons, trouts, smelts = trout
miscellaneous freshwater fishes = catfish
tilapias and other cichlids = tilapia

Re-label pressures data to categories used in trade data (pressures data is more disaggregated)
```{r}
pressure_relabel <- pressure %>% 
  mutate(nceas_group = case_when(stressor_group == "catfish" ~ "miscellaneous freshwater fishes",
                                 stressor_group == "hypoph_carp" ~ "hypoph_carp",
                                 stressor_group == "milkfish" ~ "miscellaneous diadromous fishes",
                                 stressor_group == "misc_diad" ~ "miscellaneous diadromous fishes",
                                 stressor_group == "oth_carp" ~ "oth_carp",
                                 stressor_group == "tilapia" ~ "tilapias and other cichlids",
                                 stressor_group == "trout" ~ "salmons, trouts, smelts",
                                 TRUE ~ as.character(NA)))
summary(pressure_relabel)

pressure_relabel <- pressure_relabel %>% 
  mutate(pressure = case_when(pressure == "GHG" ~ "ghg",
                              pressure == "nutrients" ~ "nutrient",
                              TRUE ~ pressure))
summary(pressure_relabel)
```


Sum pressures  by country for the same nceas category
```{r}
pressure_agg <- pressure_relabel %>% 
  group_by(iso3c, country_name, pressure, nceas_group) %>% 
  summarise(sum_pressure_value = sum(stressor_value))

# check data
# sum(pressure_agg$sum_pressure_value)
# sum(pressure_relabel$stressor_value)
```


Subset trade to relevant categories for which we have pressures data (removes ~ 25% of rows)
```{r}
fw_trade_subset <- fw_trade_proportions %>% 
  filter(nceas_group == "oth_carp" | 
           nceas_group == "hypoph_carp" |
           nceas_group == "miscellaneous diadromous fishes" |
           nceas_group == "salmons, trouts, smelts" |
           nceas_group == "miscellaneous freshwater fishes"|
           nceas_group == "tilapias and other cichlids")

# check to see how much of trade data is unaccounted for when subset by available pressure data
nrow(fw_trade_subset)/nrow(fw_trade_proportions)
```


To get to cumulative pressure, divide each pressure by the global pressure (to standardize) and then sum the four pressures for each animal product. The data is taken from the below GitHub but saved within this projects folder.
https://github.com/OHI-Science/food_systems/blob/master/_analysis/rescale_values.csv

```{r}
# read in data on total global pressures
total_global_pressure <- read_csv(paste0(raw_data_path, "pressures/rescale_values.csv"))

# join the fish pressures with the total global pressures
sum_pressures <- left_join(pressure_agg, total_global_pressure, by = "pressure")

# divide each pressure by the global total pressure to standardize - this includes total pressures from all crops and animal products
sum_pressures_1 <- sum_pressures %>% 
  mutate(prop_global_pressure = sum_pressure_value/global_total)

# sum the four pressures for each crop
sum_pressures_and_cumu <- sum_pressures_1 %>% 
  group_by(iso3c, country_name, nceas_group) %>% 
  mutate(cumu_pressure = sum(prop_global_pressure)) %>% 
  ungroup()

sum(sum_pressures_and_cumu$cumu_pressure) # 0.3585281

# check: make sure cumulative pressures looks right (should have only one cumu pressure value for each crop product in each country)
test1 <- sum_pressures_and_cumu %>% 
  filter(country_name == "Brazil")
test2 <- sum_pressures_and_cumu %>% 
  filter(country_name == "Australia")

# change formatting so all in wide format (right now only cumulative pressure is in wide format and other pressures are in long format)
sum_pressures_and_cumu_wide <- sum_pressures_and_cumu %>% 
  select(!c(global_total, prop_global_pressure)) %>% 
  pivot_wider(names_from = pressure, values_from = sum_pressure_value)
```


Join the trade matrix with pressures df and look at missing values
```{r}
fish_trade_pressures_w_missing <- full_join(fw_trade_subset, sum_pressures_and_cumu_wide, by = c("source_country_iso3c" = "iso3c", "nceas_group" = "nceas_group"))

# check missing trade data (have pressures but no trade data)
missing_trade <- fish_trade_pressures_w_missing %>% 
  filter(is.na(proportion_traded))

# note: there are 20 rows of data that are included in sum_pressures_and_cumu_wide, but not in fw_trade_subset
# this means that we have 2017 pressures data for these items in these countries, but they are not in Jessica's trade matrix.

# for how many rows do we have trade data but not pressures data?
missing_pressures <- fish_trade_pressures_w_missing %>% 
  filter(is.na(cumu_pressure))

# note: there are 409 rows of data that are included in fw_trade_subset, but not in sum_pressures_and_cumu_wide
# this means that we have 2017 trade data for these items in these countries, but we don't have pressures data for them

# sum of pressures from missing trade - we can use this as a check later
summary_missing_pressures <- missing_trade %>% 
  summarise_at(vars(cumu_pressure:water), sum, na.rm = TRUE)

# left_join instead so we don't include those rows where we only have pressures data, but no trade
fish_trade_pressures <- left_join(fw_trade_subset, sum_pressures_and_cumu_wide, by = c("source_country_iso3c" = "iso3c", "nceas_group" = "nceas_group"))
```


Multiply proportion traded between each country with the total amount of pressures for that product produced in that country. Then you can get the value of pressures (4 individual plus cumulative) for each product trade between 2 countries.
```{r}
fish_trade_pressures_1 <- fish_trade_pressures %>% 
  mutate(trade_cumu_pressure = proportion_traded*cumu_pressure) %>% 
  mutate(trade_ghg = proportion_traded*ghg) %>% 
  mutate(trade_water = proportion_traded*water) %>% 
  mutate(trade_nutrient = proportion_traded*nutrient) %>% 
  mutate(trade_disturbance = proportion_traded*disturbance)

# subset to remove extra variables
fish_trade_pressures_cut <- fish_trade_pressures_1 %>% 
  rename(Producer_country = country_name) %>% 
  select(-c(cumu_pressure, ghg, water, nutrient, disturbance))

# reorganize
fish_trade_pressures_cut <- fish_trade_pressures_cut[,c(1, 7, 2:6, 8:12)]

# save df
write_csv(fish_trade_pressures_cut, paste0(save_path, "inland_aquaculture_products_trade_matrix_w_pressures.csv"))
```


```{r}
# check to see if it looks right
alb_test <- fish_trade_pressures_1 %>% 
  filter(source_country_iso3c == "ALB") %>% 
  filter(nceas_group == "salmons, trouts, smelts")
sum(alb_test$traded_tons) # 569.4352 (matches sum_caught in df)
sum(alb_test$proportion_traded) #1

# make sure total value of "salmons, trouts, smelts" caught in ALB still matches original data
alb_check <- fw_trade_proportions %>% 
  filter(source_country_iso3c == "ALB") %>% 
  filter(nceas_group == "salmons, trouts, smelts")
sum(alb_check$traded_tons) # 569.4352 (matches alb_test)

# these values should match the rows labeled cumu_pressure, disturbance, ghg, nutrient, and water in alb_test
sum(alb_test$trade_cumu_pressure)
sum(alb_test$trade_disturbance)
sum(alb_test$trade_ghg)
sum(alb_test$trade_nutrient)
sum(alb_test$trade_water)
```



