---
title: "connect_2017_fw_aquaculture_to_pressures"
author: "Haley Epperly"
date: "2022-11-17"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
```
## Set Up

File paths
```{r}
raw_data_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/raw_data/"
aquatic_trade_data_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/01c_allocate_unknown_trade_fish_consumption/"
pressures_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/02b_fw_aquaculture_pressures/"
save_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/02aii_connect_2017_fw_aquaculture_to_pressures/"
```


Method:
The trade data contains the source country, consumer country, habitat, fishing method, nceas group, and the live weight traded between each country. The pressures data has the environmental pressure produced per tonne live weight of a given species. The pressures data is a global average for freshwater aquaculture so we only need to match the species traded with each pressure and multiple the two to get the total environmental pressure for the consuming country.

## Read in the two data streams

Trade data - from step 01c
```{r}
# read in all of the fish trade data, these are means of the years 2015-2019
trade_matrix_raw <- read_csv(paste0(aquatic_trade_data_path, "fish_trade_matrix_w_unknowns_allocated.csv")) # read in the updated data

# only want inland aquaculture to accurately allocate freshwater (inland) aquaculture pressures
fw_trade_clean <- trade_matrix_raw %>% 
  filter(habitat == "inland" & method == "aquaculture")


```

Read in freshwater aquaculture pressures data per tonne from Mel - calculated in step 02a
```{r}
pressure <- read_csv(paste0(pressures_path, "fw_aquaculture_pressures_per_tonne.csv")) 
```

## Match up the species groupings
Compare species groups - these are extremely different. We will need to make sure that we can join the pressures per tonne of each species to their correct species in the trade data
```{r}
table(pressure$stressor_group)
table(fw_trade_clean$nceas_group)
```

Investigating salmon to make sure Salmons, trouts, smelts are all inland aquaculture and don't include marine species.
```{r}
salmonid <- trade_matrix_raw %>% 
  filter(nceas_group=="salmonids")
salmon <- trade_matrix_raw %>% 
  filter(nceas_group=="salmons, trouts, smelts")
```
Salmonids are all marine aquaculture, so Salmons, trouts, smelts is probably just inland.

Reminder from `02b_fw_aqua_pressures.Rmd`, we have excluded milkfish pressures for now and all miscellaneous diadromous fish (misc_diad) trade will be categorized as this stressor. 

Mel's key - updated data (left is trade matrix categories, right is pressures categories):
oth_carp = oth_carp 
hypoph_carp = hypoph_carp
miscellaneous diadromous fishes = misc_diad (+ milkfish if pressure is reintroduced)
salmons, trouts, smelts = trout
miscellaneous freshwater fishes = catfish
tilapias and other cichlids = tilapia

Re-label pressures data to categories used in trade data (pressures data is more disaggregated)
```{r}
pressure_relabel <- pressure %>% 
  mutate(nceas_group = case_when(stressor_group == "catfish" ~ "miscellaneous freshwater fishes",
                                 stressor_group == "hypoph_carp" ~ "hypoph_carp",
                                 #stressor_group == "milkfish" ~ "miscellaneous diadromous fishes",
                                 stressor_group == "misc_diad" ~ "miscellaneous diadromous fishes",
                                 stressor_group == "oth_carp" ~ "oth_carp",
                                 stressor_group == "tilapia" ~ "tilapias and other cichlids",
                                 stressor_group == "trout" ~ "salmons, trouts, smelts",
                                 TRUE ~ as.character(NA)))
summary(pressure_relabel)

pressure_relabel <- pressure_relabel %>% 
  mutate(pressure = case_when(pressure == "GHG" ~ "ghg",
                              pressure == "nutrients" ~ "nutrient",
                              TRUE ~ pressure)) %>% 
  filter(!is.na(nceas_group)) %>% 
  select(nceas_group, pressure, pressure_per_tonne, stressor_group) %>% 
  pivot_wider(names_from = pressure,
              values_from = pressure_per_tonne)

```

Subset trade to relevant categories for which we have pressures data (removes ~ 25% of rows). There is not freshwater aquaculture pressures for the following groups:
- freshwater crustaceans
- sturgeons, paddlefishes
- river eels
- miscellaneous coastal fishes
- marine fishes not identified
- freshwater molluscs
- shads
- miscellaneous marine crustaceans
- shrimps, prawns
- abalones, winkles, conchs

```{r}
fw_trade_subset <- fw_trade_clean %>% 
  filter(nceas_group == "oth_carp" | 
           nceas_group == "hypoph_carp" |
           nceas_group == "miscellaneous diadromous fishes" |
           nceas_group == "salmons, trouts, smelts" |
           nceas_group == "miscellaneous freshwater fishes"|
           nceas_group == "tilapias and other cichlids")

# check to see how much of trade data is unaccounted for when subset by available pressure data
nrow(fw_trade_subset)/nrow(fw_trade_clean)
# 75% of trade by rows

#check by weight how much trade is unaccounted for
sum(fw_trade_subset$consumption_live_weight_t)/sum(fw_trade_clean$consumption_live_weight_t)
# more than 92% of the trade by weight
```


## Calculate the environmental pressures from freshwater aquaculture
Now join trade data with pressure efficiency data by the `nceas_group`. The `fw_trade_pressures` should have 4x as many rows as `fw_trade_subset` as there are 4 pressures per `nceas_group`.
```{r}
# join trade data with the pressures data
fw_trade_pressures <- left_join(x = fw_trade_subset, y = pressure_relabel, by = "nceas_group")

# check join
nrow(fw_trade_pressures)
nrow(fw_trade_subset)*4

fw_trade_pressures <- fw_trade_pressures %>% 
  # calculate the total pressure from live_weight_t and pressure_per_tonne
  mutate(pressure_total = consumption_live_weight_t * pressure_per_tonne) %>% 
  # select columns to make simpler
  select(source_country_iso3c, consumer_iso3c, nceas_group, consumption_live_weight_t, pressure_type = pressure, pressure_per_tonne, pressure = pressure_total)
```

## Set up for joining with other data and save
```{r}

```

