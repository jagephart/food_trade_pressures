---
title: "connect_trade_and_pressures"
output: html_document
date: "2023-09-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The goal of this script is to connect the trade data to the environmental efficiency data to calculate the quantity of the pressures from the producing countries. The next script will combine these pressures with freshwater aquaculture and adjust the trade for feed.

## Setup
Packages
```{r}
library(tidyverse)
library(countrycode)
```


Filepaths
```{r}
trade_matrix_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/01b_calc_trade_matrix_2017/"
fmfo_trade_matrix_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/01d_allocate_unknown_trade_fmfo_consumption/"
fish_trade_matrix_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/01c_allocate_unknown_trade_fish_consumption/"
fw_aquaculture_trade_pressures_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/04a_connect_fw_aquaculture_pressures/"
pressure_efficiency_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/02a_efficiencies_data_prep/"
code_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/raw_data/Codes/"
save_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/04b_connect_crop_livestock_oth_fish_pressures/"
```

## Pressure Efficiency Data
Read in the pressure efficiency data. 

```{r}
pressures_per_tonne <- read.csv(paste0(pressure_efficiency_path, "pressures_per_tonne.csv"))
```

### Crops
Subset the pressure efficiency data to the crops food group. Pivot wider to make joining with trade data easier to manage.
```{r}
pressures_crops <- pressures_per_tonne %>% 
  filter(food_group == "crops") 

pressures_crops_wide <- pressures_crops %>% 
  # pivot wide to simplify join with trade data
  pivot_wider(names_from = pressure,
              values_from = pressure_per_tonne) %>% 
  # per conversations with the authors of the pressures data
  # we are assuming that any individual missing pressure for crops is a true 0
  mutate(disturbance = if_else(condition = is.na(disturbance),
                               true = 0,
                               false = disturbance),
         ghg = if_else(condition = is.na(ghg),
                       true = 0,
                       false = ghg),
         nutrient = if_else(condition = is.na(nutrient),
                            true = 0,
                            false = nutrient),
         water = if_else(condition = is.na(water),
                         true = 0,
                         false = water)) %>% 
  # remove item and item code because the data is aggregated by SPAM_super
  select(-item_code, -item) %>% 
  # join will be with SPAM_super so make sure we have no repeats
  distinct()



# check for dupes
pressures_crops_dupes <- pressures_crops %>%
    dplyr::group_by(iso3c, nceas_group, SPAM_super, item_code, item, food_group, pressure) %>%
    dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%
    dplyr::filter(n > 1L)
```

#### Gapfill Set Up
Set up regional gapfilling for crops pressures. For this purpose we will use the countrycode package and the United Nations regional designations. This will be used to gapfill countries that have trade data with another country for a given product, but are missing pressures data.
```{r warning=FALSE}
pressures_crops_regions <- pressures_crops_wide %>% 
  pivot_longer(cols = c(disturbance, ghg, water, nutrient),
               values_to = "pressure_per_tonne",
               names_to = "pressure") %>% 
  # add UN_region
  mutate(UN_region = countrycode(iso3c, 'iso3c', 'un.region.name')) %>% 
  # add subregion
  mutate(subregion = countrycode(iso3c, 'iso3c', 'un.regionsub.name')) %>% 
  # add intermediate region
  mutate(intermed_region = countrycode(iso3c, 'iso3c', 'un.regionintermediate.name')) %>% 
  # the intermediate region designation is less broad than subregion
  # make a region column for when there is no intermediate region use the subregion
  mutate(region = case_when(is.na(intermed_region) ~ subregion,
                            TRUE ~ intermed_region))  

# fill in Taiwan UN_region, region, and subregion
pressures_crops_regions$UN_region[pressures_crops_regions$iso3c == "TWN"] <- "Asia"
pressures_crops_regions$region[pressures_crops_regions$iso3c == "TWN"] <- "Eastern Asia"

# the iso3c code is presumed to be for Kosovo and will therefor have a designation of Southern Europe like neighboring countries
pressures_crops_regions$UN_region[pressures_crops_regions$iso3c == "XKO"] <- "Europe"
pressures_crops_regions$region[pressures_crops_regions$iso3c == "XKO"] <- "Southern Europe"

na_test <- pressures_crops_regions %>% 
  filter(is.na(UN_region) | is.na(region))%>% 
  mutate(country = countrycode(iso3c, 'iso3c', 'country.name'))
# no region NAs

# calculate UN_region averages
pressures_crops_UN_regions <- pressures_crops_regions %>% 
  group_by(UN_region, SPAM_super, pressure) %>% 
  # count number of pressures used in calculation
  summarise(n = dplyr::n(),
            # calculate means of groupings 
            UN_region_pressure_per_tonne = mean(pressure_per_tonne, na.rm = TRUE)) %>% 
  ungroup() %>% 
  # filter only for regional averages that are made up of more than 1 data point
  filter(n > 1)

pressures_crops_UN_regions_wide <- pressures_crops_UN_regions %>% 
  # remove count column
  select(-n) %>% 
  # pivot wide to merge with other data easily
  pivot_wider(names_from = pressure,
              values_from = UN_region_pressure_per_tonne) %>% 
  rename(UN_region_ghg = ghg,
         UN_region_disturbance = disturbance,
         UN_region_nutrient = nutrient,
         UN_region_water = water)

# calculate regional averages
pressures_crops_regions <- pressures_crops_regions %>% 
  group_by(region, SPAM_super, pressure) %>% 
  # count number of pressures used in calculation
  summarise(n = dplyr::n(),
            # calculate means of groupings 
            region_pressure_per_tonne = mean(pressure_per_tonne, na.rm = TRUE)) %>% 
  ungroup() %>% 
  # filter only for regional averages that are made up of more than 1 data point
  filter(n > 1)

pressures_crops_regions_wide <- pressures_crops_regions %>% 
  # remove count column
  select(-n) %>% 
  # pivot wide to merge with other data easily
  pivot_wider(names_from = pressure,
              values_from = region_pressure_per_tonne) %>% 
  rename(region_ghg = ghg,
         region_disturbance = disturbance,
         region_nutrient = nutrient,
         region_water = water)
  
```

### Livestock
```{r}
pressures_livestock <- pressures_per_tonne %>% 
  filter(food_group == "livestock") %>% 
  distinct()

pressures_livestock_wide <- pressures_livestock %>% 
  # pivot wide to simplify join with trade data
  pivot_wider(names_from = pressure,
              values_from = pressure_per_tonne) %>% 
  # per conversations with the authors of the pressures data
  # we are assuming that any individual missing pressure for livestock is a true 0
  mutate(disturbance = if_else(condition = is.na(disturbance),
                               true = 0,
                               false = disturbance),
         ghg = if_else(condition = is.na(ghg),
                       true = 0,
                       false = ghg),
         nutrient = if_else(condition = is.na(nutrient),
                            true = 0,
                            false = nutrient),
         water = if_else(condition = is.na(water),
                         true = 0,
                         false = water))

# check for dupes
pressure_livestock_dupes <- pressures_livestock %>%
    dplyr::group_by(iso3c, nceas_group, SPAM_super, item_code, item, food_group, pressure) %>%
    dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%
    dplyr::filter(n > 1L) 

pressure_livestock_codes <- pressures_livestock %>% 
  select(item_code, nceas_group) %>% 
  # there is no associated item code for goats milk
  filter(!is.na(item_code)) %>% 
  distinct()
```

#### Gapfill Set Up
Set up regional gapfilling for livestock pressures. For this purpose we will use the countrycode package and the United Nations regional designations. This will be used to gapfill countries that have trade data with another country for a given product, but are missing pressures data.
```{r warning=FALSE}
pressures_livestock_regions <- pressures_livestock_wide %>% 
  pivot_longer(cols = c(disturbance, ghg, water, nutrient),
               values_to = "pressure_per_tonne",
               names_to = "pressure") %>% 
  # add UN_region
  mutate(UN_region = countrycode(iso3c, 'iso3c', 'un.region.name')) %>% 
  # add subregion
  mutate(subregion = countrycode(iso3c, 'iso3c', 'un.regionsub.name')) %>% 
  # add intermediate region
  mutate(intermed_region = countrycode(iso3c, 'iso3c', 'un.regionintermediate.name')) %>% 
  # the intermediate region designation is less broad than subregion
  # make a region column for when there is no intermediate region use the subregion
  mutate(region = case_when(is.na(intermed_region) ~ subregion,
                            TRUE ~ intermed_region))  

# fill in Taiwan regions
pressures_livestock_regions$UN_region[pressures_livestock_regions$iso3c == "TWN"] <- "Asia"
pressures_livestock_regions$region[pressures_livestock_regions$iso3c == "TWN"] <- "Eastern Asia"

na_test <- pressures_livestock_regions %>% 
  filter(is.na(UN_region) | is.na(region)) %>% 
  mutate(country = countrycode(iso3c, 'iso3c', 'country.name'))
# no region NAs

# calculate UN_region averages
pressures_livestock_UN_regions <- pressures_livestock_regions %>% 
  group_by(UN_region, item, item_code, pressure) %>% 
  # count number of pressures used in calculation
  summarise(n = dplyr::n(),
            # calculate means of groupings 
            UN_region_pressure_per_tonne = mean(pressure_per_tonne, na.rm = TRUE)) %>% 
  ungroup() %>% 
  # only keep means made of more than one value
  filter(n >1)

pressures_livestock_UN_regions_wide <- pressures_livestock_UN_regions %>% 
  # remove count column
  select(-n) %>% 
  # pivot wide to merge with other data easily
  pivot_wider(names_from = pressure,
              values_from = UN_region_pressure_per_tonne) %>% 
  rename(UN_region_ghg = ghg,
         UN_region_disturbance = disturbance,
         UN_region_nutrient = nutrient,
         UN_region_water = water)

# calculate regional averages
pressures_livestock_regions <- pressures_livestock_regions %>% 
  group_by(region, item, item_code, pressure) %>% 
  # count number of pressures used in calculation
  summarise(n = dplyr::n(),
            # calculate means of groupings 
            region_pressure_per_tonne = mean(pressure_per_tonne, na.rm = TRUE)) %>% 
  ungroup() 

pressures_livestock_regions_wide <- pressures_livestock_regions %>% 
  # remove count column
  select(-n) %>% 
  # pivot wide to merge with other data easily
  pivot_wider(names_from = pressure,
              values_from = region_pressure_per_tonne) %>% 
  rename(region_ghg = ghg,
         region_disturbance = disturbance,
         region_nutrient = nutrient,
         region_water = water)
  
```

### Marine Fish and Fish Oil Fish Meal (FOFM)

```{r}
pressures_fish <- pressures_per_tonne %>% 
  filter(food_group == "fisheries and mariculture") %>% 
  # filter out highseas pressure data (HSX) and XMI (unknown country) iso3c presssure data
  filter(iso3c != "XMI",
         iso3c != "HSX")

pressures_fish_wide <- pressures_fish %>% 
  # pivot wide to simplify join with trade data
  pivot_wider(names_from = pressure,
              values_from = pressure_per_tonne) %>% 
  mutate(food_group = "fisheries and mariculture") %>% 
  # per conversations with the authors of the pressures data
  # we are assuming that any individual missing pressure for livestock is a true 0
  mutate(disturbance = if_else(condition = is.na(disturbance),
                               true = 0,
                               false = disturbance),
         ghg = if_else(condition = is.na(ghg),
                       true = 0,
                       false = ghg),
         nutrient = if_else(condition = is.na(nutrient),
                            true = 0,
                            false = nutrient))

# check for dupes
pressures_fish_dupes <- pressures_fish %>% 
  dplyr::group_by(iso3c, nceas_group, SPAM_super, item, item_code, food_group, pressure) %>%
    dplyr::summarise(n = dplyr::n(), .groups = "drop") %>%
    dplyr::filter(n > 1L)
```

#### Gapfill Set Up
Set up regional gapfilling for marine fish(an inland capture) pressures. For this purpose we will use the countrycode package and the United Nations regional designations. This will be used to gapfill countries that have trade data with another country for a given product, but are missing pressures data.
```{r}
pressures_fish_regions <- pressures_fish_wide %>% 
  pivot_longer(cols = c(disturbance, ghg, nutrient),
               values_to = "pressure_per_tonne",
               names_to = "pressure") %>%  
  # add UN_region
  mutate(UN_region = countrycode(iso3c, 'iso3c', 'un.region.name')) %>% 
  # add subregion
  mutate(subregion = countrycode(iso3c, 'iso3c', 'un.regionsub.name')) %>% 
  # add intermediate region
  mutate(intermed_region = countrycode(iso3c, 'iso3c', 'un.regionintermediate.name')) %>% 
  # the intermediate region designation is less broad than subregion
  # make a region column for when there is no intermediate region use the subregion
  mutate(region = case_when(is.na(intermed_region) ~ subregion,
                            TRUE ~ intermed_region))  

# na check
region_na <- pressures_fish_regions %>% 
  filter(is.na(UN_region) | is.na(region))

# fill in Taiwan region
pressures_fish_regions$UN_region[pressures_fish_regions$iso3c == "TWN"] <- "Asia"
pressures_fish_regions$region[pressures_fish_regions$iso3c == "TWN"] <- "Eastern Asia"

# the iso3c code is presumed to be for Kosovo and will therefor have a designation of Southern Europe like neighboring countries
pressures_fish_regions$UN_region[pressures_fish_regions$iso3c == "XKO"] <- "Europe"
pressures_fish_regions$region[pressures_fish_regions$iso3c == "XKO"] <- "Southern Europe"

na_test <- pressures_fish_regions %>% 
  filter(is.na(UN_region) | is.na(region)) %>% 
  mutate(country = countrycode(iso3c, 'iso3c', 'country.name'))
# no region NAs

# calculate UN_region averages
pressures_fish_UN_regions <- pressures_fish_regions %>% 
  group_by(UN_region, nceas_group, pressure) %>% 
  # count number of pressures used in calculation
  summarise(n = dplyr::n(),
            # calculate means of groupings 
            UN_region_pressure_per_tonne = mean(pressure_per_tonne, na.rm = TRUE)) %>% 
  ungroup() %>% 
  # filter only for regional averages that are made up of more than 1 data point
  filter(n > 1)

pressures_fish_UN_regions_wide <- pressures_fish_UN_regions %>% 
  # remove count column
  select(-n) %>% 
  # pivot wide to merge with other data easily
  pivot_wider(names_from = pressure,
              values_from = UN_region_pressure_per_tonne) %>% 
  rename(UN_region_ghg = ghg,
         UN_region_disturbance = disturbance,
         UN_region_nutrient = nutrient)

# calculate regional averages
pressures_fish_regions <- pressures_fish_regions %>% 
  group_by(region, nceas_group, pressure) %>% 
  # count number of pressures used in calculation
  summarise(n = dplyr::n(),
            # calculate means of groupings 
            region_pressure_per_tonne = mean(pressure_per_tonne, na.rm = TRUE)) %>% 
  ungroup() %>% 
  # filter only for regional averages that are made up of more than 1 data point
  filter(n > 1)

pressures_fish_regions_wide <- pressures_fish_regions %>% 
  # remove count column
  select(-n) %>% 
  # pivot wide to merge with other data easily
  pivot_wider(names_from = pressure,
              values_from = region_pressure_per_tonne) %>% 
  rename(region_ghg = ghg,
         region_disturbance = disturbance,
         region_nutrient = nutrient)
  
```

## Trade matrix - crops, animals, and fish
Read in the trade data and clean if necessary. 

```{r}
crop_livestock_trade_matrix <- read.csv(paste0(trade_matrix_path, "trade_matrix_by_country_of_origin_2015_2019_import.csv")) %>% 
  # don't need year column
  select(-Year) %>% 
  # rename some columns
  rename(consumer_country_code = Consumer_Country_Code,
         producer_country_code = Producer_Country_Code,
         traded_tonnes = Value,
         item_code = Item_Code) %>% 
  # remove zeros data (removes close to 60,000 rows of data)
  filter(traded_tonnes > 0) 

#  Subset to only crops and livestock (866 == cattle, everything < 866 == non animal product)
crop_trade_matrix <- crop_livestock_trade_matrix %>% 
  filter(item_code < 866)

livestock_trade_matrix <- crop_livestock_trade_matrix %>% 
  filter(item_code >= 866)

fish_marine_trade_matrix <- read.csv(paste0(fish_trade_matrix_path, "fish_trade_matrix_w_unknowns_allocated.csv")) %>% 
  # remove freshwater aquaculture since it is handled in step 04a
  filter(habitat == "marine")

inland_capture_trade_matrix <- read.csv(paste0(fish_trade_matrix_path, "fish_trade_matrix_w_unknowns_allocated.csv")) %>% 
  # inland capture pressures are included in these pressure efficiencies
  filter(habitat == "inland" & method == "capture")

# join marine trade and inland capture trade
# important note, the FOFM from this trade is not for animal consumption
fish_trade_matrix <- rbind(fish_marine_trade_matrix, inland_capture_trade_matrix) %>% 
  # we have no pressures data for jellyfish so filter out completely
  filter(nceas_group != "jellyfish")

# the FOFM trade matrix will be joined with the fish_trade_matrix
# the below code sets this up
# important note, the FOFM from this trade is for animal consumption
fofm_trade_matrix <- read.csv(paste0(fmfo_trade_matrix_path, "fmfo_trade_matrix_w_unknowns_allocated.csv")) %>% 
  group_by(consumer_iso3c, source_country_iso3c) %>% 
  summarise(consumption_live_weight_t = sum(consumption_live_weight_t)) %>% 
  # add nceas_group, habitat, and method column
  # fofm for nceas_group is to join for pressures
  mutate(nceas_group = "fofm",
         # we will use habitat and method as fofm_feed later to distinguish 
         # fofm for feed vs not for feed
         habitat = "fofm_feed",
         method = "fofm_feed")
  
#old_trade <- read.csv(paste0(trade_matrix_path, "trade_matrix_by_country_of_origin_2017_import.csv"))

```

## Connect trade and pressures
This section will connect trade and pressures based on their broad groups. 

- Crops and livestock trade will be connected to the pressures via the producer country code and the item code
- fish and fmfo trade will be combined and connect to the pressures via their country code and nceas_group category

Set Up country codes and FAO codes to join trade and pressures
```{r}
# read in country codes from FAO detailed trade matrix definitions selecting the partner country group tab (reported country group tab says data unavailable)
country_codes <- read_csv(paste0(code_path, "FAOSTAT_country_codes_8-10-2022.csv"))

# format to match trade matrix variables names
countries <- country_codes %>% 
  select(`Partner Country Code`, `Partner Countries`, `ISO3 Code`) %>% 
  rename('Country_Code' = 'Partner Country Code',
         'Country' = 'Partner Countries',
         'ISO3' = 'ISO3 Code') %>% 
  unique()

# "China, mainland" on the FAO website has the ISO3 code F41.
# China, the aggregated country, has the ISO3 code CHN.
# In the pressures data, they assign China mainland the ISO3 code CHN, so we need to be aware
# of this in the gravity model if we match using ISO3 code. 
# we will keep in line with the pressures data here, and give China mainland the ISO3 code CHN.
countries <- countries %>% 
  mutate(ISO3 = ifelse(Country == "China, mainland", "CHN", ISO3))

# read in data to map item_code from trade_matrix to pressures data
map_to_fao <- read_csv(paste0("/home/shares/food-systems/social_justice_projects/food_trade_pressures/raw_data/Codes/", "MapSPAM_to_FAO_v2.csv")) %>% 
  select(item_code = FAO_item_code, item = product_description_FAOSTAT, SPAM_super) %>% 
  distinct()
```



### Crops
The crop trade data has a number of items/categories that should be removed as they are not considered food so we do not have pressures data for them.

- SPAM_super "ofib" includs fiber crops that are not considered food
- SPAM_super "othr" includes hops, pyrethrum, and rubber
- SPAM_super "teas" includes tea, which are all not considered food
- SPAM_super "toba" includes tobacco, which are all not considered food
- SPAM_super "xcof" includes green coffee, which are all not considered food
- Item "mate" is not considered food
- We do not have pressures for "Chillies and peppers, green"
```{r}
# join the trade matrix with iso3c data
crop_trade_countries <- crop_trade_matrix %>%
  # join with countries data to producer country code
  left_join(countries, by = c("producer_country_code" = "Country_Code")) %>%
  # rename to producer columns
  rename(producer_country = Country, producer_iso3c = ISO3) %>% 
  # relocate to after producer country code
  relocate(c(producer_country, producer_iso3c), .after = producer_country_code) %>% 
  # join with countries data to consumer country code
  left_join(countries, by = c("consumer_country_code" = "Country_Code")) %>%
  # rename to producer colomns
  rename(consumer_country = Country, consumer_iso3c = ISO3) %>% 
  # relocate to after producer country code
  relocate(c(consumer_country, consumer_iso3c), .after = consumer_country_code) %>% 
  # join with FAO SPAM and item_code data
  left_join(map_to_fao, 
            by = "item_code") %>% 
  # remove SPAM_super categories as explained above
  filter(!SPAM_super == "ofib", !SPAM_super == "othr", !SPAM_super == "teas",
         !SPAM_super == "toba", !SPAM_super == "xcof")

# check to see if any country codes didn't match
country_na <- crop_trade_countries %>% 
  filter(is.na(consumer_country) | is.na(producer_country) | is.na(consumer_iso3c) | is.na(producer_iso3c))
# no missing country code data!

```

#### Calculate the total pressures
```{r}
# Join pressures/tonne data based on the producer_iso3c from trader data and the item_code
crop_trade_pressures <- left_join(x = crop_trade_countries, 
                                  y = pressures_crops_wide,
                                  by = c("producer_iso3c" = "iso3c",
                                         # for crops we join by the SPAM_super category
                                         "SPAM_super")) %>% 
  # remove some redundant columns, keep nceas_group for now to check for NAs
  select(- c(consumer_country_code, producer_country_code)) %>% 
  # calculate the total pressure traded by multiplying traded_tonnes by the pressure efficiency
  mutate(disturbance_total = disturbance*traded_tonnes,
         water_total = water*traded_tonnes,
         ghg_total = ghg*traded_tonnes,
         nutrient_total = nutrient*traded_tonnes) %>% 
  # we do not have pressure efficiency data for sugar beet so filter out
  filter(item != "Sugar beet")

```

#### Missing Data Check
NA check for items we do not have pressures for
```{r}
trade_pressures_na <- crop_trade_pressures %>% 
  filter(is.na(nceas_group)) 

# how much of of the original data does this include?
# by quantity?
crop_trade_matrix_test <- crop_livestock_trade_matrix %>% 
  # join with FAO SPAM and item_code data
  left_join(map_to_fao, 
            by = "item_code") %>% 
  # remove SPAM_super categories as explained above
  filter(!SPAM_super == "ofib", !SPAM_super == "othr", !SPAM_super == "teas",
         !SPAM_super == "toba", !SPAM_super == "xcof") %>% 
  filter(item_code < 866) %>% 
  filter(item != "Sugar beet")

nrow(trade_pressures_na)/nrow(crop_trade_matrix_test)
# about 7.6% of the original rows of data

# by volume?
sum(trade_pressures_na$traded_tonnes)/sum(crop_trade_matrix_test$traded_tonnes)
# about 2.6% of total tonnes traded.

# read in item codes from FAO production data
item_codes <- read_csv(paste0(code_path, "FAOSTAT_production_item_codes_8-5-2022.csv"))

# format to match trade matrix
item_codes <- item_codes %>% 
  select("Item Code", Item) %>% 
  rename('item_code' = 'Item Code')

trade_pressures_na_items <- left_join(trade_pressures_na, item_codes, by = "item_code") %>% 
  select(producer_country, producer_iso3c, item_code, Item) %>% 
  distinct()

items_na <- trade_pressures_na_items %>% 
  select(item_code, Item) %>% 
  distinct()
```

We have a number of items that have been traded but do not have pressures associated with them. We will gapfill these pressures using regional averages.

#### Gapfill Missing Pressures - Crops
```{r, warning=FALSE}
crop_trade_pressures_missing <- crop_trade_pressures %>% 
  # Filter for rows with missing pressures
  filter(is.na(ghg) | is.na(nutrient) | is.na(disturbance) | is.na(water)) %>% 
  # add in regional ids
  # add UN_region
  mutate(producer_UN_region = countrycode(producer_iso3c, 'iso3c', 'un.region.name')) %>%
  # add subregion
  mutate(subregion = countrycode(producer_iso3c, 'iso3c', 'un.regionsub.name')) %>% 
  # add intermediate region
  mutate(intermed_region = countrycode(producer_iso3c, 'iso3c', 'un.regionintermediate.name')) %>% 
  # the intermediate region designation is less broad than subregion
  # make a region column for when there is no intermediate region use the subregion
  mutate(producer_region = case_when(is.na(intermed_region) ~ subregion,
                            TRUE ~ intermed_region)) %>% 
  select(-c(subregion, intermed_region, disturbance_total, water_total, ghg_total, nutrient_total))

# fill in Taiwan Region
crop_trade_pressures_missing$producer_UN_region[crop_trade_pressures_missing$producer_iso3c == "TWN"] <- "Asia"
crop_trade_pressures_missing$producer_region[crop_trade_pressures_missing$producer_iso3c == "TWN"] <- "Eastern Asia"

# the iso3c code is presumed to be for Kosovo and will therefor have a designation of Southern Europe like neighboring countries
crop_trade_pressures_missing$producer_UN_region[crop_trade_pressures_missing$producer_iso3c == "XKO"] <- "Europe"
crop_trade_pressures_missing$producer_region[crop_trade_pressures_missing$producer_iso3c == "XKO"] <- "Southern Europe"

# join with regions
crop_trade_pressures_gapfilled <- left_join(x = crop_trade_pressures_missing, 
                                            y = pressures_crops_regions_wide,
                                            by = c("producer_region" = "region",
                                                   # for crops we join by the SPAM_super category
                                                   "SPAM_super")) %>% 
  left_join( y = pressures_crops_UN_regions_wide,
             by = c("producer_UN_region" = "UN_region",
                    # for crops we join by the SPAM_super category
                    "SPAM_super")) %>% 
  # gapfill using region first
  mutate(ghg = if_else(condition = is.na(ghg),
                       true = region_ghg,
                       false = ghg),
         disturbance = if_else(condition = is.na(disturbance),
                       true = region_disturbance,
                       false = disturbance),
         water = if_else(condition = is.na(water),
                       true = region_water,
                       false = water),
         nutrient = if_else(condition = is.na(nutrient),
                       true = region_nutrient,
                       false = nutrient)) %>% 
  # gapfill using UN_region next
  mutate(ghg = if_else(condition = is.na(ghg),
                       true = UN_region_ghg,
                       false = ghg),
         disturbance = if_else(condition = is.na(disturbance),
                       true = UN_region_disturbance,
                       false = disturbance),
         water = if_else(condition = is.na(water),
                       true = UN_region_water,
                       false = water),
         nutrient = if_else(condition = is.na(nutrient),
                       true = UN_region_nutrient,
                       false = nutrient)) %>% 
  # remove extra columns for joining back with other data
  select(-c( producer_region, region_disturbance, region_ghg, region_nutrient, region_water),
         -c( producer_UN_region, UN_region_disturbance, UN_region_ghg, UN_region_nutrient, UN_region_water)) %>% 
  # calculate the total pressure traded by multiplying traded_tonnes by the pressure efficiency
  mutate(disturbance_total = disturbance*traded_tonnes,
         water_total = water*traded_tonnes,
         ghg_total = ghg*traded_tonnes,
         nutrient_total = nutrient*traded_tonnes)

remaining_na <- crop_trade_pressures_gapfilled %>% 
  # Filter for rows with missing pressures
  filter(is.na(ghg) | is.na(nutrient) | is.na(disturbance) | is.na(water))

nrow(remaining_na)/nrow(crop_trade_matrix_test)
# about 0.5% of the original rows of data

# by volume?
sum(remaining_na$traded_tonnes)/sum(crop_trade_matrix_test$traded_tonnes)
# about 0.1% of total tonnes traded.

unique(remaining_na$SPAM_super)
```
We still have missing pressures for trade of crops but it is a small amount so we will just filter these out.

```{r}
crop_trade_pressures_gapfilled <- crop_trade_pressures_gapfilled %>% 
  # Filter out rows with missing pressures
  filter(!is.na(ghg) | !is.na(nutrient) | !is.na(disturbance) | !is.na(water))
```



#### Rejoin gapfilled data
```{r}
# record the number of rows to ensure bind does not result in lost data besides few remaining NA
nrow(crop_trade_pressures)
sum(crop_trade_pressures$traded_tonnes)

crop_trade_pressures <- crop_trade_pressures %>% 
  # Filter for rows with no missing pressures
  filter(!is.na(ghg) & !is.na(nutrient) & !is.na(disturbance) & !is.na(water)) 

nrow(crop_trade_pressures) + nrow(crop_trade_pressures_gapfilled) + nrow(remaining_na)

crop_trade_pressures <- rbind(crop_trade_pressures, crop_trade_pressures_gapfilled)
sum(crop_trade_pressures$traded_tonnes) + sum(remaining_na$traded_tonnes)

# no loses, crops are done!
```

### Livestock
```{r}
livestock_trade_countries <- livestock_trade_matrix %>%
  # join with countries data to producer country code
  left_join(countries, by = c("producer_country_code" = "Country_Code")) %>%
  # rename to producer columns
  rename(producer_country = Country, producer_iso3c = ISO3) %>% 
  # relocate to after producer country code
  relocate(c(producer_country, producer_iso3c), .after = producer_country_code) %>% 
  # join with countries data to consumer country code
  left_join(countries, by = c("consumer_country_code" = "Country_Code")) %>%
  # rename to producer columns
  rename(consumer_country = Country, consumer_iso3c = ISO3) %>% 
  # relocate to after producer country code
  relocate(c(consumer_country, consumer_iso3c), .after = consumer_country_code) %>% 
  # removing beeswax, hides, skins, silk-worms, honey, other bird eggs, and meats (nes, ass, camel, duck, game, goose, horse, rabbit, turkey)
  filter(item_code %in% c(pressure_livestock_codes[,1]))
                          
      
# check to see if any country codes didn't match
country_na <- livestock_trade_countries %>% 
  filter(is.na(consumer_country) | is.na(producer_country) | is.na(consumer_iso3c) | is.na(producer_iso3c))
# no missing country code data!

```

#### Calculate the total pressures
```{r}
livestock_trade_pressures <- livestock_trade_countries %>% 
  left_join(pressures_livestock_wide,
            by = c("producer_iso3c" = "iso3c",
                   # for livestock we join by the item_code 
                   "item_code")) %>% 
  # remove some redundant columns, keep nceas_group for now to check for NAs
  select(- c(consumer_country_code, producer_country_code, SPAM_super)) %>% 
  # calculate the total pressure traded by multiplying traded_tonnes by the pressure efficiency
  mutate(disturbance_total = disturbance*traded_tonnes,
         water_total = water*traded_tonnes,
         ghg_total = ghg*traded_tonnes,
         nutrient_total = nutrient*traded_tonnes)
```

#### Missing Pressures Check
```{r}
# since we are joining by producer_iso3c and item_code
# any items with no associated pressures data would have 
# NA in the nceas_group column
na_livestock <- livestock_trade_pressures %>% 
  filter(is.na(nceas_group))

# what percentage by volume is NA?
sum(na_livestock$traded_tonnes)/sum(livestock_trade_countries$traded_tonnes)
# <1% by traded tonnes

# what about by number of traded items?
nrow(na_livestock)/nrow(livestock_trade_countries)
# <1% by number of rows

na_livestock_items <- left_join(na_livestock, item_codes, by = "item_code") %>% 
  select(item_code, Item) %>% 
  distinct()
```

#### Gapfill Livestock
```{r, warning=FALSE}
livestock_trade_pressures_missing <- livestock_trade_pressures %>% 
  # Filter for rows with missing pressures
  filter(is.na(ghg) | is.na(nutrient) | is.na(disturbance) | is.na(water)) %>% 
  # add in regional ids
  # add UN_region
  mutate(producer_UN_region = countrycode(producer_iso3c, 'iso3c', 'un.region.name')) %>%
  # add subregion
  mutate(subregion = countrycode(producer_iso3c, 'iso3c', 'un.regionsub.name')) %>% 
  # add intermediate region
  mutate(intermed_region = countrycode(producer_iso3c, 'iso3c', 'un.regionintermediate.name')) %>% 
  # the intermediate region designation is less broad than subregion
  # make a region column for when there is no intermediate region use the subregion
  mutate(producer_region = case_when(is.na(intermed_region) ~ subregion,
                            TRUE ~ intermed_region)) %>% 
  select(-c(subregion, intermed_region, disturbance_total, water_total, ghg_total, nutrient_total))

# join with regions
livestock_trade_pressures_gapfilled <- left_join(x = livestock_trade_pressures_missing %>% 
                                                   # remove item column
                                                   select(-item), 
                                                 y = pressures_livestock_regions_wide,
                                                 by = c("producer_region" = "region",
                                                        # for livestock we join by the item_code column
                                                        "item_code")) %>% 
  left_join( y = pressures_livestock_UN_regions_wide %>% 
               # remove item column
               select(-item),
             by = c("producer_UN_region" = "UN_region",
                    # for livestock we join by the item_code column
                    "item_code")) %>%
  # gapfill using region first
  mutate(ghg = if_else(condition = is.na(ghg),
                       true = region_ghg,
                       false = ghg),
         disturbance = if_else(condition = is.na(disturbance),
                       true = region_disturbance,
                       false = disturbance),
         water = if_else(condition = is.na(water),
                       true = region_water,
                       false = water),
         nutrient = if_else(condition = is.na(nutrient),
                       true = region_nutrient,
                       false = nutrient)) %>% 
  # gapfill using UN_region next
  mutate(ghg = if_else(condition = is.na(ghg),
                       true = UN_region_ghg,
                       false = ghg),
         disturbance = if_else(condition = is.na(disturbance),
                       true = UN_region_disturbance,
                       false = disturbance),
         water = if_else(condition = is.na(water),
                       true = UN_region_water,
                       false = water),
         nutrient = if_else(condition = is.na(nutrient),
                       true = UN_region_nutrient,
                       false = nutrient)) %>% 
  # remove extra columns for joining back with other data
  select(-c(producer_region, region_disturbance, region_ghg, region_nutrient, region_water),
         -c(producer_UN_region, UN_region_disturbance, UN_region_ghg, UN_region_nutrient, UN_region_water)) %>% 
  # calculate the total pressure traded by multiplying traded_tonnes by the pressure efficiency
  mutate(disturbance_total = disturbance*traded_tonnes,
         water_total = water*traded_tonnes,
         ghg_total = ghg*traded_tonnes,
         nutrient_total = nutrient*traded_tonnes)

remaining_na <- livestock_trade_pressures_gapfilled %>% 
  # Filter for rows with missing pressures
  filter(is.na(ghg) | is.na(nutrient) | is.na(disturbance) | is.na(water))

nrow(remaining_na)/nrow(livestock_trade_countries)
# no further missing data!

# by volume?
sum(remaining_na$traded_tonnes)/sum(livestock_trade_countries$traded_tonnes)
# no further missing data!

unique(remaining_na$item_code)
```

#### Rejoin gapfilled data
```{r}
# record the number of rows to ensure bind does not result in lost data 
nrow(livestock_trade_pressures)
sum(livestock_trade_pressures$traded_tonnes)

livestock_trade_pressures_new <- livestock_trade_pressures %>% 
  # Filter for rows with no missing pressures
  filter(!is.na(ghg) & !is.na(nutrient) & !is.na(disturbance) & !is.na(water)) 

nrow(livestock_trade_pressures_new) + nrow(livestock_trade_pressures_gapfilled)

livestock_trade_pressures_new <- rbind(livestock_trade_pressures_new, livestock_trade_pressures_gapfilled)
sum(livestock_trade_pressures_new$traded_tonnes)
# no loses, livestock is done except for housekeeping below!

# there are a few item codes that are missing nceas groups and items
na_items <- livestock_trade_pressures_new %>% 
  filter(is.na(item) | is.na(nceas_group))

na_item_codes <- unique(na_items$item_code)

# we fix the NA items here
# setup
livestock_items_nceas_group <- livestock_trade_pressures_new %>% 
  select(item_code, item, nceas_group) %>% 
  distinct() %>% 
  filter(!is.na(item),
         !is.na(nceas_group))

livestock_trade_pressures_new <- livestock_trade_pressures_new %>% 
  mutate(item = case_when(item_code == 867 ~ livestock_items_nceas_group$item[livestock_items_nceas_group$item_code == 867],
                          item_code == 882 ~ livestock_items_nceas_group$item[livestock_items_nceas_group$item_code == 882],
                          item_code == 951 ~ livestock_items_nceas_group$item[livestock_items_nceas_group$item_code == 951],
                          item_code == 977 ~ livestock_items_nceas_group$item[livestock_items_nceas_group$item_code == 977],
                          item_code == 982 ~ livestock_items_nceas_group$item[livestock_items_nceas_group$item_code == 982],
                          item_code == 1017 ~ livestock_items_nceas_group$item[livestock_items_nceas_group$item_code == 1017],
                          item_code == 1035 ~ livestock_items_nceas_group$item[livestock_items_nceas_group$item_code == 1035],
                          TRUE ~ item)) %>% 
  mutate(nceas_group = case_when(item_code == 867 ~ livestock_items_nceas_group$nceas_group[livestock_items_nceas_group$item_code == 867],
                                 item_code == 882 ~ livestock_items_nceas_group$nceas_group[livestock_items_nceas_group$item_code == 882],
                                 item_code == 951 ~ livestock_items_nceas_group$nceas_group[livestock_items_nceas_group$item_code == 951],
                                 item_code == 977 ~ livestock_items_nceas_group$nceas_group[livestock_items_nceas_group$item_code == 977],
                                 item_code == 982 ~ livestock_items_nceas_group$nceas_group[livestock_items_nceas_group$item_code == 982],
                                 item_code == 1017 ~ livestock_items_nceas_group$nceas_group[livestock_items_nceas_group$item_code == 1017],
                                 item_code == 1035 ~ livestock_items_nceas_group$nceas_group[livestock_items_nceas_group$item_code == 1035],
                                 TRUE ~ nceas_group))
  
na_items <- livestock_trade_pressures_new %>% 
  filter(is.na(item) | is.na(nceas_group))
# no NAs anymore!

# another quick check
sum(livestock_trade_pressures_new$traded_tonnes)
sum(livestock_trade_pressures$traded_tonnes)
# no changes! Good to go
```

### Fish and FOFM
```{r}
# join the trade matrix with iso3c data
fish_trade_countries <- fish_trade_matrix %>%
  # rbind with fofm_trade_matrix
  rbind(fofm_trade_matrix) %>% 
  # filter out NEI iso3c code
  filter(consumer_iso3c != "NEI",
         source_country_iso3c != "NEI") %>% 
  # join with countries data to producer iso3c
  left_join(countries %>% 
              select(-Country_Code),
            by = c("source_country_iso3c" = "ISO3")) %>%
  # rename to producer columns
  rename(producer_country = Country, producer_iso3c = source_country_iso3c) %>% 
  # relocate to after producer country code
  relocate(c(producer_country), .after = producer_iso3c) %>% 
  # join with countries data to consumer iso3c
  left_join(countries %>% 
              select(-Country_Code),
            by = c("consumer_iso3c" = "ISO3")) %>%
  # rename to producer columns
  rename(consumer_country = Country, consumer_iso3c = consumer_iso3c) %>% 
  # relocate to after producer country code
  relocate(c(consumer_country), .after = consumer_iso3c) 

# check to see if any country codes didn't match
country_na <- fish_trade_countries %>% 
  filter(is.na(consumer_country) | is.na(producer_country) | is.na(consumer_iso3c) | is.na(producer_iso3c))
# no missing country code data!
```

#### Calculate the total pressures
```{r}
fish_trade_pressures <- fish_trade_countries %>% 
  left_join(pressures_fish_wide,
            by = c("producer_iso3c" = "iso3c",
                   # for fish we join by the nceas_group 
                   "nceas_group")) %>% 
  # remove some redundant columns, keep food_group for now to check for NAs
  select(- c(item, item_code, SPAM_super)) %>% 
  # calculate the total pressure traded by multiplying consumption_live_weight_t by the pressure efficiency
  mutate(disturbance_total = disturbance*consumption_live_weight_t,
         ghg_total = ghg*consumption_live_weight_t,
         nutrient_total = nutrient*consumption_live_weight_t)
```

#### Missing Pressures Check
```{r}
na_fish <- fish_trade_pressures %>% 
  filter(is.na(food_group))

# what percentage by volume is NA?
sum(na_fish$consumption_live_weight_t)/sum(fish_trade_pressures$consumption_live_weight_t)
# 1.9% by traded tonnes

# what about by number of traded items?
nrow(na_fish)/nrow(fish_trade_pressures)
# 7.7% by number of rows

unique(pressures_fish$nceas_group)

unique(fish_trade_matrix$nceas_group)

```

#### Gapfill Fish
```{r, warning=FALSE}
fish_trade_pressures_missing <- fish_trade_pressures %>% 
  # Filter for rows with missing pressures
  filter(is.na(ghg) | is.na(nutrient) | is.na(disturbance)) %>% 
  # add in regional ids
  # add UN_region
  mutate(producer_UN_region = countrycode(producer_iso3c, 'iso3c', 'un.region.name')) %>%
  # add subregion
  mutate(subregion = countrycode(producer_iso3c, 'iso3c', 'un.regionsub.name')) %>% 
  # add intermediate region
  mutate(intermed_region = countrycode(producer_iso3c, 'iso3c', 'un.regionintermediate.name')) %>% 
  # the intermediate region designation is less broad than subregion
  # make a region column for when there is no intermediate region use the subregion
  mutate(producer_region = case_when(is.na(intermed_region) ~ subregion,
                            TRUE ~ intermed_region)) %>% 
  select(-c(subregion, intermed_region, disturbance_total, ghg_total, nutrient_total))

# join with regions
fish_trade_pressures_gapfilled <- left_join(x = fish_trade_pressures_missing, 
                                            y = pressures_fish_regions_wide,
                                            by = c("producer_region" = "region",
                                                   # for fish we join by the nceas_group column
                                                   "nceas_group")) %>% 
  left_join( y = pressures_fish_UN_regions_wide,
             by = c("producer_UN_region" = "UN_region",
                    # for fish we join by the nceas_group column
                    "nceas_group")) %>%
  # gapfill region first
  mutate(ghg = if_else(condition = is.na(ghg),
                       true = region_ghg,
                       false = ghg),
         disturbance = if_else(condition = is.na(disturbance),
                       true = region_disturbance,
                       false = disturbance),
         nutrient = if_else(condition = is.na(nutrient),
                       true = region_nutrient,
                       false = nutrient)) %>% 
  # gapfill using UN_region next
  mutate(ghg = if_else(condition = is.na(ghg),
                       true = UN_region_ghg,
                       false = ghg),
         disturbance = if_else(condition = is.na(disturbance),
                       true = UN_region_disturbance,
                       false = disturbance),
         nutrient = if_else(condition = is.na(nutrient),
                       true = UN_region_nutrient,
                       false = nutrient)) %>% 
  # remove extra columns for joining back with other data
  select(-c(producer_region, region_disturbance, region_ghg, region_nutrient),
         -c(producer_UN_region, UN_region_disturbance, UN_region_ghg, UN_region_nutrient)) %>% 
  # calculate the total pressure traded by multiplying traded_tonnes by the pressure efficiency
  mutate(disturbance_total = disturbance*consumption_live_weight_t,
         ghg_total = ghg*consumption_live_weight_t,
         nutrient_total = nutrient*consumption_live_weight_t)

remaining_na <- fish_trade_pressures_gapfilled %>% 
  # Filter for rows with missing pressures
  filter(is.na(ghg) & is.na(nutrient) & is.na(disturbance))

nrow(remaining_na)/nrow(fish_trade_pressures)
# less than 0.01% of rows.

# by volume?
sum(remaining_na$consumption_live_weight_t)/sum(fish_trade_pressures$consumption_live_weight_t)
# less than 0.01% of total tonnes traded.
```

We still have missing pressures for trade of fish but it is a small amount so we will just filter these out.

```{r}
fish_trade_pressures_gapfilled <- fish_trade_pressures_gapfilled %>% 
  # Filter out rows with missing pressures
  filter(!is.na(ghg) | !is.na(nutrient) | !is.na(disturbance))
```

#### Rejoin gapfilled data
```{r}
# record the number of rows to ensure bind does not result in lost data 
nrow(fish_trade_pressures)
sum(fish_trade_pressures$consumption_live_weight_t)

fish_trade_pressures <- fish_trade_pressures %>% 
  # Filter for rows with no missing pressures
  filter(!is.na(ghg) & !is.na(nutrient) & !is.na(disturbance)) 

nrow(fish_trade_pressures) + nrow(fish_trade_pressures_gapfilled) + nrow(remaining_na)

fish_trade_pressures <- rbind(fish_trade_pressures, fish_trade_pressures_gapfilled)
sum(fish_trade_pressures$consumption_live_weight_t) + sum(remaining_na$consumption_live_weight_t)

# no loses, crops are done!
```

## Join Crops, Livestock, and Marine Trade/Pressures
The below section joins the three areas of trade into one data frame. First we need to make sure they all have the same columns and structure
```{r}
### Crops
crop_trade_pressures_clean <- crop_trade_pressures %>% 
  # make sure food group is the same for all categories
  mutate(food_group = "crops") %>% 
  # remove SPAM_super and nceas_group
  select(-nceas_group) %>% 
  # remove pressures per tonne columns
  select(-c(ghg, water, disturbance, nutrient))

### Livestock
livestock_trade_pressures_clean <- livestock_trade_pressures_new %>%
  # remove item column 
  select(-item) %>% 
  # make nceas_group item
  rename(item = nceas_group) %>% 
  # make sure food group is the same for all categories
  mutate(food_group = "livestock",
         # SPAM_super category used with crops to separate out feed
         SPAM_super = NA) %>% 
  # remove pressures per tonne columns
  select(-c(ghg, water, disturbance, nutrient))

### Fish
fish_trade_pressures_clean <- fish_trade_pressures %>% 
  # use the habitat column to change the nceas_group name of fofm
  # that should be only used for feed
  mutate(nceas_group = if_else(condition = habitat == "fofm_feed",
                               true = "fofm_feed",
                               false = nceas_group)) %>% 
  # make sure food group is the same for all categories
  mutate(food_group = "fisheries and aquaculture",
         # add in water_total columns (will be zero)
         water_total = 0,
         # add in item code column for fisheries and aquaculture, will be NA
         item_code = NA,
         # SPAM_super category used with crops to separate out feed
         SPAM_super = NA) %>% 
  # rename consumption_live_weight_t
  rename(traded_tonnes = consumption_live_weight_t,
         # rename nceas_group to item
         item = nceas_group) %>% 
  # remove method, habitat 
  select(-habitat, -method) %>% 
  # remove pressures per tonne columns
  select(-c(ghg, disturbance, nutrient))

### Freshwater Aquaculture - made in 04a
fw_aquaculture_trade_pressures_clean <- read.csv(file = paste0(fw_aquaculture_trade_pressures_path, "fw_aquaculture_trade_pressures.csv")) %>% 
  # SPAM_super category used with crops to separate out feed
  mutate(SPAM_super = NA) %>% 
  #remove X column that appears
  select(-X)

# bind all together
trade_pressures_final <- rbind(crop_trade_pressures_clean,
                         livestock_trade_pressures_clean,
                         fish_trade_pressures_clean,
                         fw_aquaculture_trade_pressures_clean)

```

## Save
Note this saved file does not have pressures allocated to animals for feed yet. That will be done in the next step.
```{r}
write_csv(x = trade_pressures_final,
          file = paste0(save_path, "trade_w_pressures_no_feed.csv"))
```


