---
title: "Comtrade API downloads"
author: "Haley Epperly"
date: "2022-09-27"
output: html_document
editor_options: 
  chunk_output_type: console
---

Objective: Download 2017 Comtrade trade data using the Comtrade API for all trading partners for cattle (2 categories), goats (1 category), sheep (1 category), chickens (2 categories), and pigs (3 categories).

Comtradr - package that links Comtrade API to R
https://cran.r-project.org/web/packages/comtradr/vignettes/comtradr-vignette.html

There are many limitations to using the Comtrade API:
1. 1 request per second, 100 requests per hour - this means we likely cannot go through a for loop with different countries
2. Between args reporters, partners, and the query date range, only one of these three may use the catch-all input "All".
3. For the same group of three (reporters, partners, date range), if the input is not "All", then the maximum number of input values for each is five. - This means we can only select 5 reporter countries at a time


Load libraries
```{r}
library(tidyverse)
library(comtradr)
library(rjson)
```


Figure out the names of countries for which we need to download Comtrade data.
There are more countries in the Comtrade data than in the FAO/Kastner trade matrix, so we don't need to download them all. 
There are also some countries spelled differently in the Comtrade and TM.

Get list of countries included in 2017 Kastner calculated trade matrix
```{r}
# load in trade matrix - does not have countries, only country codes
trade_matrix <- read_csv("/home/shares/food-systems/social_justice_projects/food_trade_ej/kastner_2022_data_code/results_2017/trade_matrix_by_country_of_origin_2017_import.csv")

# combine with country names and ISO3 codes
# first load in FAO country codes, subset, and only select unique rows
country_codes <- read_csv("/home/shares/food-systems/social_justice_projects/food_trade_ej/FAOSTAT_country_codes_8-10-2022.csv")
country_codes_1 <- country_codes %>% 
  select(`Partner Country Code`, `Partner Countries`, `ISO3 Code`) %>% 
  distinct(`Partner Country Code`, `Partner Countries`, `ISO3 Code`)
# then combine with FAO trade matrix to see which countries (of all FAO countries) are included in 2017 Kastner trade matrix
trade_country <- left_join(trade_matrix, country_codes_1, by = c("Producer_Country_Code" = "Partner Country Code")) %>% 
  select(Producer_Country_Code, `Partner Countries`, `ISO3 Code`) %>% 
  distinct(Producer_Country_Code, `Partner Countries`, `ISO3 Code`)
# now we have the list of 199 countries for which we need to download Comtrade data
```


Get list of countries in Comtrade data and look at differences in countries between the Comtrade data and FAO/Kastner TM.
```{r}
# Load in list of country names in Comtrade data
# These country codes are not the same ones used in FAO data so will have to combine by country name
# But keeping in mind that country names are likely different between FAO and Comtrade
string <- "http://comtrade.un.org/data/cache/partnerAreas.json"
reporters <- fromJSON(file=string)
reporters <- as.data.frame(t(sapply(reporters$results,rbind)))

# remove first two rows (world and all) and set V1 to numeric
reporters_1 <- reporters[-c(1:2),] 
reporters_1$V1 <- as.numeric(reporters_1$V1)
  

# find countries that are in comtrade data that aren't in Kastner TM
# we don't need to download data for these countries since they aren't in the TM
in_comtrade <- reporters_1 %>% 
      filter(!reporters_1$V2 %in% trade_country$`Partner Countries`)

# find countries that are in Kastner TM that aren't in comtrade data
# these are countries with likely different names in Comtrade than FAO
in_TM_not_Comtrade <- trade_country %>% 
      filter(!trade_country$`Partner Countries` %in% reporters_1$V2)

# names that are slightly different between the 2 dfs have been identified and are saved here:
# /home/shares/food-systems/social_justice_projects/food_trade_ej/FAO_Comtrade_country_name_differences.csv
```


Create list of countries for which we need to download Comtrade data.
```{r}
# read in csv created in last code chunk
comtrade_country <- read_csv("/home/shares/food-systems/social_justice_projects/food_trade_ej/FAO_Comtrade_country_name_differences.csv")
 
# subset to only comtrade country names
comtrade_country_1 <- comtrade_country %>% 
  select(Comtrade)

# combine with list of the rest of the country names that are the same in FAO and Comtrade
in_both <- trade_country %>% 
      filter(trade_country$`Partner Countries` %in% reporters_1$V2) %>% 
  select(`Partner Countries`)
comtrade_list <- full_join(comtrade_country_1, in_both,  by = c("Comtrade" = "Partner Countries"))

# there are 199 rows, which matches with the number of countries we have in the Kastner TM
# However, we have two NAs where "China, Taiwan Province of" and "Puerto Rico" 
# are included in the FAO/Kastner TM but not in Comtrade data

# let's remove those NAs but check if PR or Taiwan have live animal trade
comtrade_list <- comtrade_list %>% 
  filter(!is.na(Comtrade))

# save list of countries we need to download Comtrade data for so we don't have to repeat this code
write_csv(comtrade_list, "/home/shares/food-systems/social_justice_projects/food_trade_ej/Comtrade_country_names_for_API.csv")
```


Read in list of countries for which we need to download Comtrade data
```{r}
comtrade <- read_csv("/home/shares/food-systems/social_justice_projects/food_trade_ej/Comtrade_country_names_for_API.csv")
```


Look up commodity codes
```{r}
ct_commodity_lookup("goat") # live goats = 010420

ct_commodity_lookup("sheep") # live sheep = 010410

ct_commodity_lookup("cattle") # 010221 - Cattle; live, pure-bred breeding animals
                              # 010229 - Cattle; live, other than pure-bred breeding animals

ct_commodity_lookup("poultry") # 010511 - Poultry; live, fowls of the species gallus domesticus, weighing not more than 185g
                              # 010591 - Poultry; live, fowls of the species gallus domesticus, weighing more than 185g
                              # 010592 - Poultry; live, weighing over 185g but not more than 2000g, fowls of the species gallus domesticus
                              # 010592 - Poultry; live, weighing over 2000g, fowls of the species gallus domesticus
                              # 010594 - Poultry; live, fowls of the species Gallus domesticus, weighing more than 185g

ct_commodity_lookup("swine") # 010310 - Swine; live, pure-bred breeding animals
                            # 010391 - Swine; live, other than pure-bred breeding animals, weighing less than 50kg
                            # 010392 - Swine; live, other than pure-bred breeding animals, weighing 50kg or more
```


Trying to get comtradr package to work with list of countries, but it is not working.
It won't work for countries that are longer than one word for some reason.
```{r}
country <- comtrade$Comtrade
q1 <- ct_search(reporters = c(country[1:5]),
               partners = "All", 
               trade_direction = "all", 
               start_date = 2017, 
               end_date = 2017,
               commod_codes = "010420")
```


Create separate dataframes for countries that are one word and those that are multiple words
```{r}
# find country names that are just one word
# separate countries into separate columns by spaces
comtrade_sep <- comtrade %>% 
  separate(Comtrade, c("one_word", "mult_words"))

# if the second column (mult_words) is NA, that means the country name is only 1 word
# make new df with countries with only 1 word names
one_word_countries <- comtrade_sep %>% 
  filter(is.na(mult_words)) %>% 
  select(one_word)

# create dataframe with countries with multiple words
mult_word_countries <- comtrade %>% 
      filter(!comtrade$Comtrade %in% one_word_countries$one_word)
```


Download live animal trade data for all animals for all one-word countries.
```{r}
# convert list of one word countries to vector
one_word_countries_vec <- one_word_countries$one_word

# subset of data to use in for loops - separate into 2 because of API limits
one_word_countries_vec_sub_1 <- one_word_countries_vec[1:75]
one_word_countries_vec_sub_2 <- one_word_countries_vec[76:150]

# for loop to run through the countries and download data for each animal
# group of interest for the year 2017

# create blank df to save outputs - bind them together as they save
comtrade_data <- data.frame()

for (country in one_word_countries_vec_sub_1){
  comtrade_data_country <- ct_search(reporters = country,
               partners = "All", 
               trade_direction = "all", 
               start_date = 2017, 
               end_date = 2017,
               commod_codes = c("010420", "010410", "010221", "010229", "010511",
                                "010591", "010592", "010593", "010594", "010310",
                                "010391", "010392"))
  comtrade_data <- rbind(comtrade_data_country, comtrade_data)
  print(comtrade_data)
}
# have to put print at the end, if we do "return" then it stops at the first country

# save dataframe
comtrade_data_single_1_75 <- comtrade_data
length(unique(comtrade_data_single_1_75$reporter)) # 61 countries


# repeat for loop with the second half of the vector with single word countries
# create blank df to save outputs - bind them together as they save
comtrade_data <- data.frame()

for (country in one_word_countries_vec_sub_2){
  comtrade_data_country <- ct_search(reporters = country,
               partners = "All", 
               trade_direction = "all", 
               start_date = 2017, 
               end_date = 2017,
               commod_codes = c("010420", "010410", "010221", "010229", "010511",
                                "010591", "010592", "010593", "010594", "010310",
                                "010391", "010392"))
  comtrade_data <- rbind(comtrade_data_country, comtrade_data)
  print(comtrade_data)
}
# have to put print at the end, if we do return then it stops at the first country

# save dataframe
comtrade_data_single_76_150 <- comtrade_data
length(unique(comtrade_data_single_76_150$reporter)) #46 countries
```


For some reason, some countries won't be included when downloading with the API even though their data is available on Comtrade AND we do not get the error message in R saying those countries are not in the database like we get for countries with multiple words. 
I have looked into this and cannot find any reasoning. 
Therefore, we need to compare the list of single word countries that we just downloaded with the list of countries available to download via the Comtrade API to see which countries were missed. 
```{r}
# combine previously downloaded single word country comtrade data
comtrade_data_single_word <- rbind(comtrade_data_single_1_75, comtrade_data_single_76_150)

# find countries that weren't downloaded
check <- one_word_countries %>% 
  filter(!one_word_countries$one_word %in% comtrade_data_single_word$reporter)

# spot checking with comtrade website https://comtrade.un.org/data
# these countries (e.g., Syria, Venezuela, Afghanistan, Australia, Austria) do 
# have live animal trade so not sure why they're not downloading with the API
```


Try running through the for loop again with the countries that weren't downloaded originally.
```{r}
# create vector of country names
skipped_countries_vec <- check$one_word

# got Error: Comtrade API request failed, with status code [409]
# when trying to run through all 43 countries so breaking into smaller groups
skipped_countries_vec_1 <- check$one_word[1:23]
skipped_countries_vec_2 <- check$one_word[24:47]

# create blank df to save outputs - bind them together as they save
comtrade_data <- data.frame()

for (country in skipped_countries_vec_1){
  comtrade_data_country <- ct_search(reporters = country,
               partners = "All", 
               trade_direction = "all", 
               start_date = 2017, 
               end_date = 2017,
               commod_codes = c("010420", "010410", "010221", "010229", "010511",
                                "010591", "010592", "010593", "010594", "010310",
                                "010391", "010392"))
  comtrade_data <- rbind(comtrade_data_country, comtrade_data)
  print(comtrade_data)
}
# have to put print at the end, if we do return then it stops at the first country

# save dataframe
comtrade_data_single_skip_1_23 <- comtrade_data
length(unique(comtrade_data_single_skip_1_23$reporter)) #13 countries


# run through for loop again with second half of one word country list
# create blank df to save outputs - bind them together as they save
comtrade_data <- data.frame()

for (country in skipped_countries_vec_2){
  comtrade_data_country <- ct_search(reporters = country,
               partners = "All", 
               trade_direction = "all", 
               start_date = 2017, 
               end_date = 2017,
               commod_codes = c("010420", "010410", "010221", "010229", "010511",
                                "010591", "010592", "010593", "010594", "010310",
                                "010391", "010392"))
  comtrade_data <- rbind(comtrade_data_country, comtrade_data)
  print(comtrade_data)
}
# have to put print at the end, if we do return then it stops at the first country

# save dataframe
comtrade_data_single_skip_24_47 <- comtrade_data
length(unique(comtrade_data_single_skip_24_47$reporter)) #2 countries

# combine comtrade data
comtrade_data_single_skip <- rbind(comtrade_data_single_skip_1_23, comtrade_data_single_skip_24_47)

# find countries that aren't included - 28 countries
check_2 <- check %>% 
  filter(!check$one_word %in% comtrade_data_single_skip$reporter)
```


I tried to repeat this entire process again by finding the skipped 28 countries, turning them into a vector, splitting them into smaller vectors, and running through the API for loop, but no more countries would download this way. (Code not included to keep it cleaner.)

I went through the leftover single word countries (check_2) to see if they have live animal trade data on the Comtrade website by selecting 5 countries at a time as reporters and selecting "download csv" rather than clicking "get data" because sometimes "get data" shows no rows, but downloading the data shows there are lots of rows.

Nauru and Niue do not show up in the Comtrade website or using the `comtradr` package. However, these countries were included in the list of Comtrade countries downloaded using this code: 
`string <- "http://comtrade.un.org/data/cache/partnerAreas.json"`
`reporters <- fromJSON(file=string)`
`reporters <- as.data.frame(t(sapply(reporters$results,rbind)))`

Seychelles, Singapore, and Samoa all have live animal trade data on comtrade website, the rest of the leftover single country words do not have any live animal trade. I hard coded these counties into the API request to download these data.
```{r}
# 13 entries for these 3 countries, which  matches what the Comtrade website shows
sey_sing_sam <- ct_search(reporters = c("Seychelles", "Singapore", "Samoa"),
               partners = "All", 
               trade_direction = "all", 
               start_date = 2017, 
               end_date = 2017,
               commod_codes = c("010420", "010410", "010221", "010229", "010511",
                                "010591", "010592", "010593", "010594", "010310",
                                "010391", "010392"))
```


Combine all the dataframes into one dataframe with Comtrade data for all single word countries.
```{r}
# combine single word countries into one df
single_1 <- rbind(comtrade_data_single_1_75, comtrade_data_single_76_150)
single_2 <- rbind(single_1, comtrade_data_single_skip_1_23)
single_3 <- rbind(single_2, comtrade_data_single_skip_24_47)
single_4 <- rbind(single_3, sey_sing_sam)
length(unique(single_4$reporter)) 
#125 countries - matches what we would expect
# because we started with 150 single word countries, and 25 of them had no data
# which was confirmed by checking on the Comtrade website.
```


Download Comtrade data for the 47 countries with multiple words in their name.
These were hard coded in because it wouldn't work going through the for loop or just inputting a query of the country list.
```{r}
# list of multiple word countries
mult_word_countries

# convert to vector
mult_word_countries_vec <- mult_word_countries$Comtrade

# checked row numbers with Comtrade website and looks correct
mult_word_countries_vec[1:5]
mult_1_5 <- ct_search(reporters = c("Bosnia Herzegovina", "Rep. of Korea", "Rep. of Moldova", "United Kingdom", "State of Palestine"),
               partners = "All", 
               trade_direction = "all", 
               start_date = 2017, 
               end_date = 2017,
               commod_codes = c("010420", "010410", "010221", "010229", "010511",
                                "010591", "010592", "010593", "010594", "010310",
                                "010391", "010392"))

# checked row numbers with Comtrade website and looks correct
mult_word_countries_vec[6:10]
mult_6_10 <- ct_search(reporters = c("United Rep. of Tanzania", "Dem. Rep. of the Congo", "Dem. People's Rep. of Korea", "Lao People's Dem. Rep.", "Dominican Rep."),
               partners = "All", 
               trade_direction = "all", 
               start_date = 2017, 
               end_date = 2017,
               commod_codes = c("010420", "010410", "010221", "010229", "010511",
                                "010591", "010592", "010593", "010594", "010310",
                                "010391", "010392"))

# checked row numbers with Comtrade website and looks correct
mult_word_countries_vec[11:15]
mult_11_15 <- ct_search(reporters = c("Central African Rep.", "FS Micronesia", "Cook Isds", "Solomon Isds", "Faeroe Isds"),
               partners = "All", 
               trade_direction = "all", 
               start_date = 2017, 
               end_date = 2017,
               commod_codes = c("010420", "010410", "010221", "010229", "010511",
                                "010591", "010592", "010593", "010594", "010310",
                                "010391", "010392"))

# checked row numbers with Comtrade website and looks correct
mult_word_countries_vec[16:20]
mult_16_20 <- ct_search(reporters = c("Marshall Isds", "North Macedonia", "New Zealand", "Russian Federation", "Saudi Arabia"),
               partners = "All", 
               trade_direction = "all", 
               start_date = 2017, 
               end_date = 2017,
               commod_codes = c("010420", "010410", "010221", "010229", "010511",
                                "010591", "010592", "010593", "010594", "010310",
                                "010391", "010392"))

# checked row numbers with Comtrade website and looks correct
#(note: had to run this one twice - was 0 rows at first for some reason, but same
# exact code worked a second time.)
mult_word_countries_vec[21:25]
mult_21_25 <- ct_search(reporters = c("South Africa", "United Arab Emirates", "Bolivia (Plurinational State of)", "Viet Nam", "New Caledonia"),
               partners = "All", 
               trade_direction = "all", 
               start_date = 2017, 
               end_date = 2017,
               commod_codes = c("010420", "010410", "010221", "010229", "010511",
                                "010591", "010592", "010593", "010594", "010310",
                                "010391", "010392"))

# checked row numbers with Comtrade website and looks correct
mult_word_countries_vec[26:30]
mult_26_30 <- ct_search(reporters = c("CÃ´te d'Ivoire", "El Salvador", "Burkina Faso", "Antigua and Barbuda", "Trinidad and Tobago"),
               partners = "All", 
               trade_direction = "all", 
               start_date = 2017, 
               end_date = 2017,
               commod_codes = c("010420", "010410", "010221", "010229", "010511",
                                "010591", "010592", "010593", "010594", "010310",
                                "010391", "010392"))

# checked row numbers with Comtrade website and looks correct
mult_word_countries_vec[31:35]
mult_31_35 <- ct_search(reporters = c("Cabo Verde", "Sri Lanka", "Costa Rica", "Papua New Guinea", "Guinea-Bissau"),
               partners = "All", 
               trade_direction = "all", 
               start_date = 2017, 
               end_date = 2017,
               commod_codes = c("010420", "010410", "010221", "010229", "010511",
                                "010591", "010592", "010593", "010594", "010310",
                                "010391", "010392"))

# checked row numbers with Comtrade website and looks correct
mult_word_countries_vec[36:40]
mult_36_40 <- ct_search(reporters = c("Timor-Leste", "Saint Vincent and the Grenadines", "Sao Tome and Principe", "Sierra Leone", "South Sudan"),
               partners = "All", 
               trade_direction = "all", 
               start_date = 2017, 
               end_date = 2017,
               commod_codes = c("010420", "010410", "010221", "010229", "010511",
                                "010591", "010592", "010593", "010594", "010310",
                                "010391", "010392"))

# checked row numbers with Comtrade website and looks correct
mult_word_countries_vec[41:45]
mult_41_45 <- ct_search(reporters = c("Brunei Darussalam", "Saint Lucia", "French Polynesia", "China, Hong Kong SAR", "Saint Kitts and Nevis"),
               partners = "All", 
               trade_direction = "all", 
               start_date = 2017, 
               end_date = 2017,
               commod_codes = c("010420", "010410", "010221", "010229", "010511",
                                "010591", "010592", "010593", "010594", "010310",
                                "010391", "010392"))

# checked row numbers with Comtrade website and looks correct
mult_word_countries_vec[46:47]
mult_46_47 <- ct_search(reporters = c("Equatorial Guinea", "China, Macao SAR"),
               partners = "All", 
               trade_direction = "all", 
               start_date = 2017, 
               end_date = 2017,
               commod_codes = c("010420", "010410", "010221", "010229", "010511",
                                "010591", "010592", "010593", "010594", "010310",
                                "010391", "010392"))

# bind the dataframes together
multiple_1 <- rbind(mult_1_5, mult_6_10)
multiple_2 <- rbind(multiple_1, mult_11_15)
multiple_3 <- rbind(multiple_2, mult_16_20)
multiple_4 <- rbind(multiple_3, mult_21_25)
multiple_5 <- rbind(multiple_4, mult_26_30)
multiple_6 <- rbind(multiple_5, mult_31_35)
multiple_7 <- rbind(multiple_6, mult_36_40)
multiple_8 <- rbind(multiple_7, mult_41_45)
multiple_9 <- rbind(multiple_8, mult_46_47)

length(unique(multiple_9$reporter))
```


Find which countries are missing from combined multi-word country comtrade data
```{r}
# this isn't fully working - showing countries that we did get Comtrade data downloaded for
# like Bosnia Herzegovina
mult_check <- mult_word_countries %>% 
  filter(!mult_word_countries$Comtrade %in% multiple_9$reporter)

# start with this list (mult_check) and figure out which ones we are actually 
# missing (in multiple_9) from the reporter column:

# Central African Rep.
# Cook Isds
# Dem. People's Rep. of Korea
# Equatorial Guinea
# Faeroe Isds
# FS Micronesia
# Guinea-Bissau
# Marshall Isds
# New Caledonia
# Papua New Guinea
# Sierra Leone
# Solomon Isds
# South Sudan

# check to see if the list of 13 countries above have live trade data on the Comtrade website
# NO, the countries listed above do not have any live trade data on the Comtrade website
```


Combine multiple word country data with single word country data
```{r}
all_countries_comtrade <- rbind(multiple_9, single_4)
length(unique(all_countries_comtrade$reporter)) #159 countries

# save df
write_csv(all_countries_comtrade, "/home/shares/food-systems/social_justice_projects/_raw_data/comtrade/comtrade_live_animal_trade_data_dl_9_29_22.csv")
```

Summary:
- Started with 199 countries in FAO/Kastner TM.
- Comtrade data not available for 2 of those countries - China, Taiwan Province of and Puerto Rico. So trying to download Comtrade data for 197 countries.
- 25 single word countries do not have Comtrade live animal trade data (also realized at this point that Narau and Niue are not included in Comtrade website at all), so down to 172 countries.
- 13 multiple word countries do not have Comtrade live animal trade data, so down to 159 countries.


