---
title: "Calculating live animal conversion metrics using 2017 FAO Production data"
author: "Haley Epperly"
date: "2022-11-10"
output: html_document
editor_options: 
  chunk_output_type: console
---

Objective: Create dataframe with yield per animal category (pigs, cows, chickens, goats, sheep) for each country using 2017 FAO production data.

Yield data are only available for meat and hides (not fat or edible offals). We are only interested in the meat since the hides are not edible. We can get yield data for fat and offals if we divide production tonnes of fat or offals by number of animals. 

Do we have fat in our trade matrix? - No, we only have meat in our Kastner trade matrix. Therefore, we are only interested in the meat conversion.

Load libraries
```{r}
library(tidyverse)
```


Read in production data from FAO
```{r}
fao <- read_csv("/home/shares/food-systems/social_justice_projects/food_trade_ej/kastner_2022_data_code/Data_2017/Production_LivestockPrimary_2017_E_All_Data_(Normalized)_7_20_22_formatted.csv")
```


Create separate dfs for each animal, convert to tonnes (in different units)
```{r}
# element code 5417 = Yield/Carcass Weight and is in hg/An
# to get to tonnes meat per animal, divide yield by 10,000
cattle <- fao %>% 
  filter(`Item Code` == 867) %>% 
  filter(`Element Code` == 5417) %>% 
  mutate(yield_ton_per_cow = Value/10000) %>% 
  select(`Area Code`, Area, yield_ton_per_cow)
  
# element code 5424 = Yield/Carcass Weight and is in 0.1g/An
# Chickens are in a different unit. They are in 0.1g / animal, whereas all other animals are in hg/animal.
#0.1g = 0.001hg, so we need to divide chicken yield by 10,000,000 to get to hg/animal.
chicken <- fao %>% 
  filter(`Item Code` == 1058) %>% 
  filter(`Element Code` == 5424) %>% 
  mutate(yield_ton_per_chicken = Value/10000000) %>% 
  select(`Area Code`, Area, yield_ton_per_chicken)

# element code 5417 = Yield/Carcass Weight and is in hg/An
# to get to tonnes meat per animal, divide yield by 10,000
goats <- fao %>% 
  filter(`Item Code` == 1017) %>% 
  filter(`Element Code` == 5417) %>% 
  mutate(yield_ton_per_goat = Value/10000) %>% 
  select(`Area Code`, Area, yield_ton_per_goat)

# element code 5417 = Yield/Carcass Weight and is in hg/An
# to get to tonnes meat per animal, divide yield by 10,000
sheep <- fao %>% 
  filter(`Item Code` == 977) %>% 
  filter(`Element Code` == 5417) %>% 
  mutate(yield_ton_per_sheep = Value/10000) %>% 
  select(`Area Code`, Area, yield_ton_per_sheep)

# element code 5417 = Yield/Carcass Weight and is in hg/An
# to get to tonnes meat per animal, divide yield by 10,000
pigs <- fao %>% 
  filter(`Item Code` == 1035) %>% 
  filter(`Element Code` == 5417) %>% 
  mutate(yield_ton_per_pig = Value/10000) %>% 
  select(`Area Code`, Area, yield_ton_per_pig)
```


Look for missing countries in fao data - see if we can gapfill with production and number of animals if yield is not available.

Which countries are missing for goats that are in cattle? Do we have goat/sheep/pigs data for any of these countries?
No - checked missing countries with FAO data and none of these countries have meat production data and heads data for goats or sheep.
```{r}
setdiff(cattle$Area, goats$Area)
setdiff(cattle$Area, sheep$Area)
setdiff(cattle$Area, pigs$Area)
```


Combine dfs
```{r}
conversions <- cattle %>% 
  full_join(chicken, by = c("Area", "Area Code")) %>% 
  full_join(goats, by = c("Area", "Area Code")) %>% 
  full_join(sheep, by = c("Area", "Area Code")) %>% 
  full_join(pigs, by = c("Area", "Area Code"))
```

Calculate global average for each animal group and use that to fill in missing values. We probably won't need these missing values because if the country has no meat production in FAO, then we won't need to convert that, but we'll do this just in case.
```{r}
conversions_1 <- conversions %>% 
  mutate(yield_ton_per_cow = case_when(is.na(yield_ton_per_cow) ~ mean(yield_ton_per_cow, na.rm = TRUE), 
                                       TRUE ~ yield_ton_per_cow)) %>% 
  mutate(yield_ton_per_chicken = case_when(is.na(yield_ton_per_chicken) ~ mean(yield_ton_per_chicken, na.rm = TRUE), 
                                           TRUE ~ yield_ton_per_chicken)) %>% 
  mutate(yield_ton_per_goat = case_when(is.na(yield_ton_per_goat) ~ mean(yield_ton_per_goat, na.rm = TRUE), 
                                        TRUE ~ yield_ton_per_goat)) %>% 
  mutate(yield_ton_per_sheep = case_when(is.na(yield_ton_per_sheep) ~ mean(yield_ton_per_sheep, na.rm = TRUE), 
                                        TRUE ~ yield_ton_per_sheep)) %>% 
  mutate(yield_ton_per_pig = case_when(is.na(yield_ton_per_pig) ~ mean(yield_ton_per_pig, na.rm = TRUE), 
                                        TRUE ~ yield_ton_per_pig))

# make sure there are no NAs
summary(conversions_1)

# add rows with MDV (Maldives Area code 132) and MHL (Marshall Islands area code 127)
conversions_1 <- conversions_1 %>% 
  add_row(`Area Code` = 132, Area = "Maldives") %>% 
  add_row(`Area Code` = 127, Area = "Marshall Islands")

# fill in MDV and MHL with column averages
conversions_2 <- conversions_1 %>% 
  mutate(yield_ton_per_cow = case_when(is.na(yield_ton_per_cow) ~ mean(yield_ton_per_cow, na.rm = TRUE),
                                       TRUE ~ yield_ton_per_cow)) %>% 
  mutate(yield_ton_per_pig = case_when(is.na(yield_ton_per_pig) ~ mean(yield_ton_per_pig, na.rm = TRUE),
                                       TRUE ~ yield_ton_per_pig)) %>% 
  mutate(yield_ton_per_sheep = case_when(is.na(yield_ton_per_sheep) ~ mean(yield_ton_per_sheep, na.rm = TRUE),
                                       TRUE ~ yield_ton_per_sheep)) %>% 
  mutate(yield_ton_per_goat = case_when(is.na(yield_ton_per_goat) ~ mean(yield_ton_per_goat, na.rm = TRUE),
                                       TRUE ~ yield_ton_per_goat)) %>% 
  mutate(yield_ton_per_chicken = case_when(is.na(yield_ton_per_chicken) ~ mean(yield_ton_per_chicken, na.rm = TRUE),
                                       TRUE ~ yield_ton_per_chicken))

# save csv
write_csv(conversions_2, "scripts/comtrade_live_animal_trade_weight/outputs/animal_to_meat_conversion_rates.csv")
```

