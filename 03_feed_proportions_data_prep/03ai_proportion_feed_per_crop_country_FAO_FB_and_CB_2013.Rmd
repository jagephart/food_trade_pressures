---
title: "Calculating proportion crop used as feed using 2013 FAO food balance and commodity balances data"
author: "Haley Epperly"
date: "2022-10-26"
output: html_document
editor_options: 
  chunk_output_type: console
---

Objective: Use 2013 data from the FAO Food Balances and Commodity Balances data to determine the proportion of crops being used as feed for which most of the crop is going to the processing category.

Crops we need to calculate proportions for using 2013 data:
- soy
- palm kernel
- oilcrops (groundnuts, sunflower seed, rape and mustardseed, sesame seed, cottonseed, other oilcrops = cakes)

We need to use 2013 data to determine the proportions of these crops because after 2013 FAO switched their data methods. After 2013 there is no breakdown of how much of these crops was going towards feed vs other uses.

We are using 2017 Food Balances data (prop going to feed) for:
- grains (barl, maiz, ocer, rice, sorg, whea, mil)
- pulses (peas, beans, other pulses)


General methods:
- download 2013 FAO Food Balances data
- download 2013 FAO Commodity Balances data


Soy methods:
- make sure all cake is going to feed (soy cake feed / soy cake production)
- calculate proportion soy Domestic Supply Quantity (DSQ) going to processing (soy processing / soy DSQ)
- calculate proportion soy processing going to cake (feed) (soy cake production / (soybean processing))
- calculate proportion soy DSQ going to feed via processing (multiply previous 2 proportions)
- calculate proportion soy DSQ directly going to feed (soy feed / soy DSQ)
- add proportion soy directly going to feed to proportion soy DSQ going to feed via processing

NOTE:
Since we ended up doing soy cake production / soybean processing, these calculations could have been much simpler.
Essentially all we're doing is (feed + cake)/ domestic supply quantity of soybeans. But instead I used the more complicated route with all the multiplying proportions because that made sense when I was originally doing soy cake production / (soy cake + soy oil production) and multiplying that ratio by percent of dsq of soybeans that are processed. Since this is already done, I'm not going to change it, but something to keep in mind going forward and for explaining methods. It was also helpful doing it this way to check out proportions - like how much of soy processing is going to cake + oil, etc.

## Set Up

Load libraries
```{r}
library(tidyverse)
library(countrycode)
```

### Data Paths
```{r}
raw_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/raw_data/"
FAO_path <- paste0(raw_path, "FAO/")
save_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/03a_calc_proportion_feed_per_crop_country/"
kastner_path <- paste0(raw_path, "kastner_2022/")
fish_trade_path <- paste0(raw_path, "trade/aquatic_food_trade/")
```


### Read in FAO Food Balances and Commodity Balanaces data and subset to 2013
```{r}
fb <- read_csv(paste0(FAO_path, "FoodBalanceSheetsHistoric_E_All_Data_(Normalized).csv")) %>% 
  filter(Year == 2013)

# subset to only Unit == 1,000 tonnes
fb <- fb %>% 
  filter(Unit == "1000 tonnes")

# commodity balances are in tonnes so multiply values in fb by 1000 to get to real tonnes
fb <- fb %>% 
  mutate(value_tonnes = Value*1000)

# remove China
fb <- fb %>% 
  filter(!Area == "China")
```


Read in FAO Commodity Balances data and subset to 2013
```{r}
cb <- read_csv(paste0(FAO_path, "CommodityBalances_(non-food)_E_All_Data_(Normalized).csv")) %>% 
  filter(Year == 2013)
```

### For Gapfilling missing data
We need to add in missing countries that are missing from FB and CB data. We will use a combination of FAO country names and additional countries from fisheries trade data. We won't need all of these countries, but it's good to include them all just in case.
```{r}
# rather than reading in the whole FAO country list, we'll just consider countries included in the Kastner trade matrices output
# read in FAO country list
tm_raw <- read_csv(paste0(kastner_path, "trade_matrix_by_country_of_origin_2017_import.csv"))

tm <- tm_raw %>% 
  # just select the country codes
  select(Consumer_Country_Code) %>% 
  unique() %>% 
  # match the country code to the country names
  mutate(country = countrycode(Consumer_Country_Code, "fao", "country.name")) %>% 
  # change some of the names for our needs
  mutate(country = case_when(Consumer_Country_Code == 41 ~ "China, mainland",
                             Consumer_Country_Code == 299 ~ "Palestine",
                             TRUE ~ country))

# read in fisheries trade data 
fish_tm_raw <- read_csv(paste0(fish_trade_path, "20230626_nceas_consumption.csv"))

# add country names and subset
fish_tm <- fish_tm_raw %>% 
  # just select the country codes
  select(consumer_iso3c) %>% 
  unique() %>% 
  # match the country code to the country names
  mutate(country = countrycode(consumer_iso3c, 'iso3c', 'country.name')) %>% 
  # change some of the names for our needs
  filter(!is.na(country)) # remove one NA (iso3c = NEI, Netherlands East Indies, not in FAO data either)


# combine dfs to get complete list of countries
countries <- full_join(tm, fish_tm, by = "country")

# add iso3c
countries <- countries %>% 
  mutate(iso3 = countrycode(country, "country.name", "iso3c")) %>% 
  select(country, iso3)
```

## Soy

From the commodity balances data, all "Domestic supply quantity" (DSQ) is practically the same as "Feed" for soyabean cake of each country. Any countries where DSQ does not equal Feed is a difference of less than 1%. Therefore for our purposes, all commodity balance soyabean cake production values will be associated to feed. "Soyabean Oil" is not typically used for feed so therefore it is not included

```{r}
# subset cb to soy cake
soy_cb <- cb %>% 
  filter(Item == "Soyabean Cake")

# subset and convert to wide
# This will be joined with the fb and oil data
soy_cake_cb_wide <- soy_cb %>% 
  select(Area, Element, Value) %>% 
  filter(Element == "Feed" | Element == "Domestic supply quantity" | Element == "Production") %>% 
  pivot_wider(names_from = Element, values_from = Value)

# calculate proportion DSQ of cake going to feed
# This serves as a data check and is not used again
soy_cb_cake_feed <- soy_cake_cb_wide %>%
  mutate(prop_cake_feed = Feed/`Domestic supply quantity`) %>%
  select(Area, prop_cake_feed)
```

The above chunk shows that most domestic supply of soy cake is from feed with the lowest proportion for a country being 80%. We will therefore assume all dsq of soy cake is for feed.

In the next code chunk we:
- calculate the proportion of soyabean DSQ going to processing (soy processing / soy DSQ)
- calculate the proportion of soyabean DSQ directly going to feed (soy feed / soy DSQ)
```{r}
# subset food balance data
soy_fb <- fb %>% 
  filter(Item == "Soyabeans") %>% 
  filter(Element ==  "Domestic supply quantity" | Element == "Feed" | Element == "Processing")

# pivot wider
soy_bean_fb_wide <- soy_fb %>% 
  select(Area, Item, Element, value_tonnes) %>% 
  pivot_wider(names_from = Element, values_from = value_tonnes) %>% 
  rename(domestic_supply_quantity = `Domestic supply quantity`)

# calculate proportion soy going to processing and proportion soy going to feed
# This will be joined with the cb and oil data
soy_bean_fb_wide <- soy_bean_fb_wide %>% 
  mutate(prop_process = Processing/domestic_supply_quantity) %>% 
  mutate(prop_raw_feed = Feed/domestic_supply_quantity)
```

### Calculate Soy Feed Proportions

```{r}
# rename production in cb to cake
soy_cake_production <- soy_cake_cb_wide %>% 
  rename(production_cake = Production) %>% 
  select(Area, production_cake)

# merge fb with cb data based on the country (Area)
soy_fb_cb_bean_cake <- full_join(soy_bean_fb_wide, soy_cake_production, by = "Area")

# calculate the sum of a countries feed and cake production 
# and divide it by the total DSQ from the FB data
# this is the proportion of DSQ that goes to feed for a country
soy_feed_proportion <- soy_fb_cb_bean_cake %>%
  rowwise() %>% 
  mutate(prop_feed_total = sum(Feed, production_cake, na.rm=TRUE)/domestic_supply_quantity)

# save soy df
write_csv(soy_feed_proportion, paste0(save_path, "perc_dsq_soy_used_as_feed.csv"))
  
```

For countries that don't have data to calculate the proportion of DSQ going to feed we will be calculating regional averages as done below. This is for any countries who's `prop_feed_total` calculation is `inf`, `NaN`, `NA`, or `zero`.

### Gapfill Soy

Read in previously made `soy_feed_proportion` of percent feed for soy, add region column, and gapfill.
```{r}
soy <- soy_feed_proportion

# have to rename Turkey because it got a ? symbol added when saved as csv previously
# can't use %in% or == to identify it because it isn't showing up as a string
soy[152,1]                    # check to make sure this is Turkey
soy[152,1] <- "Turkey"
soy[37,1]                     # check to make sure this is C么te d'Ivoire
soy[37,1] <- "C么te d'Ivoire"
soy[33,1]                     # check to make sure this is Taiwan
soy[33,1] <- "Taiwan"

# remove item column and rename prop_feed 
soy <- soy %>% 
  select(Area, domestic_supply_quantity, Feed, production_cake, prop_feed_total) %>% 
  rename(soy_dsq = domestic_supply_quantity, 
         soy_feed = Feed, 
         soy_cake = production_cake, 
         soy_prop_feed = prop_feed_total) %>% 
  # have to do this line with the utf coding to avoid error when adding regions with countrycode package
  mutate_if(is.character, utf8::utf8_encode) %>% 
  # add iso3 column
  mutate(iso3 = countrycode(Area, "country.name", "iso3c"))

# join with country list
soy <- full_join(soy, countries, by = "iso3") %>% 
  # fill in country name where NA
  mutate(Area = case_when(is.na(Area) ~ country, 
                          TRUE ~ Area)) %>% 
  select(-country)

# check iso3 codes for duplicates
# remove duplicates: China, China, mainland, Palestinian Territories
soy <- soy %>% 
  # this gets rid of duplicates of mainland China
  unique() %>% 
  # remove Palestinian Territories because we have Palestine
  filter(!Area == "Palestinian Territories")

# add region
# we need a combination of UN subregion and intermediate codes
# add subregion

soy_regions <- soy %>% 
  # add subregion
  mutate(subregion = countrycode(iso3, 'iso3c', 'un.regionsub.name')) %>% 
  # add intermediate region
  mutate(intermed_region = countrycode(iso3, 'iso3c', 'un.regionintermediate.name')) %>% 
  # make a region column for when there is no intermediate region use the subregion
  mutate(region = case_when(is.na(intermed_region) ~ subregion,
                            TRUE ~ intermed_region))  

# fill in Taiwan 
soy_regions$region[soy_regions$Area == "Taiwan"] <- "Eastern Asia"

# for the previously calculated regions (bottom rows in df) that show up as NA 
# when trying to add the region column with the countrycode package,
# copy their region name into the region column
soy_regions <- soy_regions %>% 
  mutate(region = case_when(is.na(region) ~ Area, 
                            TRUE ~ region))

# remove extra columns and reorder
soy_regions <- soy_regions %>% 
  select(-c(subregion, intermed_region)) %>% 
  select(Area, iso3, region, soy_dsq, soy_feed, soy_cake, soy_prop_feed) # reorder

# before using the regions to gapfill use this to look at the regional data
region_test <- soy_regions %>% 
  filter(Area == region) %>% 
  select(region, region_prop = soy_prop_feed)

# how much data needs to be gapfilled?
soy_missing <- soy_regions %>% filter(Area != region,
                                      soy_prop_feed == 0 | is.na(soy_prop_feed) | is.infinite(soy_prop_feed)) 

soy_not_missing <- soy_regions %>% filter(Area != region,
                                          soy_prop_feed > 0,
                                          !is.infinite(soy_prop_feed))

nrow(soy_missing)/(nrow(soy_missing) + nrow(soy_not_missing))
```

Melanesia, Micronesia, and Polynesia regions have NA for their soy_prop_feed. To gapfill these regions we will use Oceania as it is part of this greater region. 

```{r}
# replace NAs and 0s with region values (0s include NAs because of how this was previously calculated)
soy_gap_filled <- soy_regions %>% 
  group_by(region) %>% 
  # for countries with a calculated zero, NA, NaN, or inf value use the regional average
  mutate(soy_prop_feed_gf = case_when(soy_prop_feed == 0 ~ soy_prop_feed[Area == region],
                                      is.na(soy_prop_feed) ~ soy_prop_feed[Area == region],
                                      is.infinite(soy_prop_feed) ~ soy_prop_feed[Area == region],
                                      TRUE ~ soy_prop_feed)) %>% 
  ungroup()

soy_gap_filled <- soy_gap_filled %>% 
  # use "Oceania" average for missing regions 
  mutate(soy_prop_feed_gf = if_else(condition = region %in% c("Melanesia", "Micronesia", "Polynesia"),
                                    true = soy_gap_filled$soy_prop_feed[soy_gap_filled$Area == "Oceania"],
                                    false = soy_prop_feed_gf)) %>% 
  # select only the columns we need
  select(Area, iso3, region, soy_prop_feed_gf)
```

Below is a check to make sure that the above gapfilling works as intended. The only `data_test` value that should not be zero are Melanesia, Micronesia, and Polynesia regions but that is because they were originally NA and we fixed that in the above. This is shown by the value in the `soy_prop_feed_gf` column.
```{r}
gf_data_to_test <- soy_gap_filled %>%
  select(Area, soy_prop_feed_gf)

# check to make sure the above worked
test_gf <- soy_regions %>%
  filter(soy_prop_feed %in% c(0, NA, NaN, Inf)) %>%
  select(Area, region, soy_prop_feed) %>%
  left_join(gf_data_to_test, by = "Area") %>%
  left_join(region_test, by = "region") %>%
  mutate(data_test = soy_prop_feed_gf - region_prop)
# end check
```

Save the new data
```{r}
# save csv
write_csv(soy_gap_filled, paste0(save_path, "perc_dsq_soy_used_as_feed_gapfilled.csv"))
```


## Palm kernel
- palm oil comes from the palm oil fruit, palm kernel oil comes from the palm kernel (seed inside of fruit)
- only palm kernel cake is used as animal feed

Palm kernel methods:
- make sure all cake is going to feed
- calculate proportion palm kernel DSQ going to processing
- check to see if palm kernel oil production and palm kernel cake production are about equal to the weight of palm kernel dsq
- calculate proportion palm kernel processing going to cake (feed) 
- calculate proportion palm kernel DSQ going to feed via processing (multiply previous 2 proportions)
- check if any palm kernels are going to feed directly

Is all palm kernel cake going to feed?
- make sure all cake is going to feed
```{r}
# create df to with palm kernel cake 
pk_cake <- cb %>% 
  filter(Item == "Palmkernel Cake") %>% 
  select(Area, Element, Item, Value) %>% 
  filter(Element == "Feed" | Element == "Domestic supply quantity" | Element == "Production") %>% 
  pivot_wider(names_from = Element, values_from = Value)

# how much pk cake going to feed?
pk_cake_feed <- pk_cake %>%
  group_by(Area) %>% 
  summarise(perc_cake_to_feed = Feed/`Domestic supply quantity`)
```
At least 96% of palm oil cake going to feed except in one country where it was 77%. For our purposes then we will assume that all palmkernel cake is being used for feed by countries.

How much palm kernel is processed?
Not all of the DSQ is processed, and losses aren't always accounted for.
- calculate proportion palm kernel DSQ going to processing
```{r}
# subset palm kernels from commodity balances
pk_proc <- cb %>% 
  filter(Item == "Palm kernels") %>% 
  select(Area, Element, Item, Value) %>% 
  filter(Element == "Feed" | Element == "Domestic supply quantity" | Element == "Production"| Element == "Processing"| Element == "Losses") %>% 
  pivot_wider(names_from = Element, values_from = Value)

# check if any palm kernels are going to feed directly
# no - only 3 tonnes of palm kernels going directly to feed and that's in Romania only, so ignore this

# calculate percent of palm kernel dsq going to processing - most of it is processed
# assume some loss when processing palm kernels into oil and cake (palm kernel includes kernels and palm fruit according to FAO definitions)
pk_process_perc <- pk_proc %>% 
  mutate(perc_pk_processed = Processing/`Domestic supply quantity`)

```
Most of the domestic supply quantity of palm kernels is going to processing.

Does palm kernel oil and palm kernel cake production equal palm kernel DSQ? This next code chunk is to understand the process flow of palm kernel more and not used for the final calculations.
Sum tonnes palm kernel cake production from CB with palm kernel oil production from FB and compare to palm kernel DSQ from CB (or from FB - same values, but FB is rounded to the thousands, so CB is more detailed)
- check to see if palm kernel oil production and palm kernel cake production are about equal to the weight of palm kernel dsq
```{r}
# create df with palm kernels oil
pk_oil <- fb %>% 
  filter(Item == "Palmkernel Oil") %>% 
  select(Area, Element, Item, value_tonnes) %>% 
  filter(Element == "Feed" | Element == "Domestic supply quantity" | Element == "Production") %>% 
  pivot_wider(names_from = Element, values_from = value_tonnes)

# isolate palm cake production from cb
pk_cake_prod <- pk_cake %>% 
  # we are assuming all cake in production is used for feed
  select(Area, Production) %>% 
  rename(pk_cake_production = Production)

# isolate palm oil production from fb
pk_oil_prod <- pk_oil %>% 
  select(Area, Production) %>% 
  rename(pk_oil_production = Production)

# isolate palm kernel cb data for comparison (pk_proc is from above code chunk)
pk_proc <- pk_proc %>% 
  select(Area, `Domestic supply quantity`, Processing, Feed) %>% 
  rename(pk_dsq = `Domestic supply quantity`, pk_processing = Processing, pk_feed = Feed)

# join cake and oil production
pk_cake_oil <- full_join(pk_cake_prod, pk_oil_prod, by = "Area")
#join cake and oil with palm kernel data
pk_cake_oil_kernel <- full_join(pk_cake_oil, pk_proc, by = "Area")

# sum pk oil and pk cake
pk_cake_oil_kernel <- pk_cake_oil_kernel %>% 
  mutate(sum_cake_oil = (pk_cake_production + pk_oil_production))
# only about 50 countries produce palm kernel cake + palm oil


# check to see if pk_cake_production + pk_oil_production is close to pk processing
# divide sum by dsq of pk
pk_cake_oil_kernel <- pk_cake_oil_kernel %>% 
  mutate(perc_proc_in_oil_cake = sum_cake_oil/pk_dsq)

```
For most countries, over 80% of palm kernel DSQ is accounted for in the palm kernel cake and palm kernel oil production. There are 11 countries with oil and cake accounting for <60% of processing tonnes so we will assume those are lost or somehow else accounted for. Only 1 Romania includes feed as a category for palm kernels, and the amount is super low (3 tonnes) so it will be ignored.


### Calculate palm kernel proportions
```{r}
# rename production in cb to cake
pk_cake_production <- pk_cake %>% 
  rename(production_cake = Production) %>% 
  select(Area, production_cake)

# merge cb data based on the country (Area)
pk_cb_join_cake <- full_join(pk_proc, pk_cake_production, by = "Area")

# divide cake production by the total DSQ from the palm kernel commodity data
# this is the proportion of DSQ that goes to feed for a country
pk_feed_proportion <- pk_cb_join_cake %>%
  rowwise() %>% 
  mutate(prop_feed_total = production_cake/pk_dsq)

# save soy df
write_csv(pk_feed_proportion, paste0(save_path, "perc_dsq_palm_kernel_used_as_feed.csv"))
```

### Gapfill Palm Kernel

Read in previously made `pk_feed_proportion` of percent feed for palm kernels, add region column, and gapfill.
```{r}
pk <- pk_feed_proportion

# have to rename Turkey because it got a ? symbol added when saved as csv previously
# can't use %in% or == to identify it because it isn't showing up as a string
# check that this is Turkey
pk[109,1]
pk[109,1] <- "Turkey"
# check that this is C么te d'Ivoire
pk[27,1]                     
pk[27,1] <- "C么te d'Ivoire"
# check that this is Taiwan
pk[23,1]                     
pk[23,1] <- "Taiwan"

# add row for Polynesia and Central Asia region
pk <- pk %>% 
  add_row(Area = "Polynesia") %>% 
  add_row(Area = "Central Asia") %>% 
  add_row(Area = "Micronesia")


# remove item column and rename prop_feed 
# also have to do this line with the utf coding to avoid error when adding regions with countrycode package
pk <- pk %>% 
  select(Area, pk_dsq, pk_feed, production_cake, prop_feed_total) %>% 
  rename(pk_cake = production_cake, pk_prop_feed = prop_feed_total) %>% 
  mutate_if(is.character, utf8::utf8_encode)

# add iso3 column
pk <- pk %>% 
  mutate(iso3 = countrycode(Area, "country.name", "iso3c"))

# join with country list
pk <- pk %>% 
  full_join(countries, by = "iso3")

# fill in country name where NA
pk <- pk %>% 
  mutate(Area = case_when(is.na(Area) ~ country, 
                          TRUE ~ Area)) %>% 
  select(-country)

# check iso3 codes for duplicates
# remove duplicates: China, China, mainland, Palestinian Territories add in Central Asia as an Area
pk <- pk %>% 
  # this gets rid of duplicates of mainland China
  unique() %>% 
  # remove Palestinian Territories because we have Palestine
  filter(!Area == "Palestinian Territories") 

# we need a combination of UN subregion and intermediate codes
pk_region <- pk %>% 
  # add subregion
  mutate(subregion = countrycode(iso3, 'iso3c', 'un.regionsub.name')) %>% 
  # add intermediate region
  mutate(intermed_region = countrycode(iso3, 'iso3c', 'un.regionintermediate.name')) %>% 
  # when there is not an intermediate region make it equivalent to the subregion
  mutate(region = case_when(is.na(intermed_region) ~ subregion,
                            TRUE ~ intermed_region))  

# fill in Taiwan region
pk_region$region[pk_region$Area == "Taiwan"] <- "Eastern Asia"
# add central asia

# for the previously calculated regions that show up as NA 
# when trying to add the region column with the countrycode package,
# copy their region name into the region column
pk_region <- pk_region %>% 
  mutate(region = case_when(is.na(region) ~ Area, 
                            TRUE ~ region))

# remove extra columns and reorder
pk_region <- pk_region %>% 
  select(-c(subregion, intermed_region)) %>% 
  select(Area, iso3, region, pk_dsq, pk_feed, pk_cake, pk_prop_feed) # reorder

# explore the regional values
region_test <- pk_region %>% 
  filter(Area == region) %>% 
  select(Area, region, region_prop = pk_prop_feed)

# how much data needs to be gapfilled?
pk_missing <- pk_region %>% filter(Area != region,
                                      pk_prop_feed == 0 | is.na(pk_prop_feed) | is.infinite(pk_prop_feed)) 

pk_not_missing <- pk_region %>% filter(Area != region,
                                          pk_prop_feed > 0,
                                          !is.infinite(pk_prop_feed))

nrow(pk_missing)/(nrow(pk_missing) + nrow(pk_not_missing))
```

Using `region_test` we can see that there are a number of regions that have NA values. As palm kernel and palm cake productions is highly concentrated in certain parts of the world this is not completely surprising. However, we know that there is some production in these areas so we will need to gapfill this data with continent level averages. The regions we are missing data for or they have low DSQ are:

- Australia and NZ
- Central Asia
- Melanesia
- Northern Africa
- Northern America
- Northern Europe
- Oceania
- Southern Africa
- Southern Asia
- Western Asia

Now that the we have added regions to the data, gapfill the NA values for countries and zero values. Even though some countries may produce little to no palm kernel/cake themselves it is unlikely that none of it is going to feed. Therefor we will gapfill the countries with a calculated zero value just like in the soy calculations.
```{r}
# replace 0s and NAs with region values (0s include NAs because of how this was previously calculated)
pk_gap_filled <- pk_region %>% 
  group_by(region) %>% 
  # for countries with a calculated NA or zero values use the regional average
  mutate(pk_prop_feed_gf = case_when(pk_prop_feed == 0 ~ pk_prop_feed[Area == region],
                                     is.na(pk_prop_feed) ~ pk_prop_feed[Area == region],
                                     TRUE ~ pk_prop_feed)) %>%
  ungroup()
```

Add in continents to the data frame and gapfill again using the continents. Since Oceania does not have a value we will use the world average to gapfill that continental region.
```{r}
# add continent to df
pk_gap_filled$continent <- countrycode(pk_gap_filled$Area, origin = 'country.name', destination = 'continent')

# fill in continents names for gapfilling
# countrycode function doesn't work because you are not allowed to set continent
# or un.regionsub.name as the origin variable
pk_gap_filled <- pk_gap_filled %>% 
  mutate(continent = case_when(Area == "Africa" ~ "Africa",
                               Area == "Europe" ~ "Europe",
                               Area == "Americas" ~ "Americas",
                               Area == "Oceania" ~ "Oceania",
                               Area == "Asia" ~ "Asia",
                               Area == "Africa" ~ "Africa",
                               TRUE ~ continent))

# Oceania doesn't have a value for percent feed, so replace with World value
pk_gap_filled <- pk_gap_filled %>% 
  mutate(pk_prop_feed_gf = case_when(Area == "Oceania" ~ pk_gap_filled$pk_prop_feed_gf[pk_gap_filled$Area == "World"],
                                     TRUE ~ pk_prop_feed_gf))


# replace NAs with continent values 
pk_gap_filled <- pk_gap_filled %>% 
  group_by(continent) %>% 
  mutate(pk_prop_feed_gf = case_when(pk_prop_feed_gf == 0 ~ pk_prop_feed_gf[Area == continent],
                                     is.na(pk_prop_feed_gf) ~ pk_prop_feed_gf[Area == continent],
                                     TRUE ~ pk_prop_feed_gf)) %>% 
  ungroup()

# some regions have NAs (e.g., Australia and New Zealand) that's fine though because all countries
# have been gapfilled. We'll keep the NAs for regions in. No percent feed values below 0 or above 1.
```

Clean and save
```{r}
# clean df before saving
pk_gap_filled <- pk_gap_filled %>% 
  select(Area, iso3, region, pk_prop_feed_gf)

# save csv
write_csv(pk_gap_filled, paste0(save_path, "perc_dsq_palm_kernel_used_as_feed_gapfilled.csv"))
```


## Oilcrops

Includes cake related to groundnuts, sunflower seed, rape and mustardseed, sesame seed, cottonseed, and other oilcrops. Once these have all been calculated they will be combined into an oilcrops grouping.

Oilcrop methods:
- make sure all cake is going to feed (cake feed / cake production)
- calculate proportion DSQ going to feed via processing (cake_production / DSQ)
- calculate proportion DSQ directly going to feed (feed / DSQ)
- add proportion directly going to feed to proportion DSQ going to feed via processing



### Cottonseed

Is all cake going to feed? Check in commodity balances data. Cottonseed oil in the `fb` data does not have any feed values from the "Element" column therefore it is assumed to not be used for feed.
```{r}
# subset and convert to wide
cotton_cake_cb_wide <- cb %>% 
  filter(Item == "Cottonseed Cake") %>% 
  select(Area, Element, Value) %>% 
  filter(Element == "Feed" | Element == "Domestic supply quantity" | Element == "Production") %>% 
  pivot_wider(names_from = Element, values_from = Value)

# calculate proportion DSQ of cake going to feed - pretty much 100% for all countries except for China, mainland
# cotton_cb_cake_feed <- cotton_cake_cb_wide %>% 
#   mutate(prop_cake_feed = Feed/`Domestic supply quantity`)
```

Pretty much 100% of all cottonseed cake is used for feed according to the data except for mainland China. Because of the high quantity of cottonseed cake DSQ from mainland China this greatly affects the Asia and even World averages. As this is the only country where the proportion of feed is not >95% of cottonseed cake DSQ we will assume it is an artifact of the data and that for our purposes, all cake is going to feed.

Next:
- calculate proportion cotton DSQ directly going to feed (cotton feed / cotton DSQ)

Reminder: we use CB instead of FB because the FB rounds to the nearest thousandth but they are otherwise the same values 
```{r}
# subset commodity balance data
cotton_cb <- cb %>% 
  filter(Item == "Cottonseed") %>% 
  filter(Element ==  "Domestic supply quantity" | Element == "Feed" | Element == "Processing")

# pivot wider
cotton_cb_wide <- cotton_cb %>% 
  select(Area, Item, Element, Value) %>% 
  pivot_wider(names_from = Element, values_from = Value)

# calculate proportion cotton going to feed
cotton_cb_wide <- cotton_cb_wide %>% 
  rename(cotton_dsq = `Domestic supply quantity`) %>% 
  mutate(prop_raw_feed = Feed/cotton_dsq)
```

#### Calculate Cotton Feed Proportions
- add proportion directly going to feed to proportion DSQ going to feed via processing
```{r}
# rename production in cb to cake
cotton_cake_production <- cotton_cake_cb_wide %>% 
  rename(production_cake = Production) %>% 
  select(Area, production_cake)

# merge fb with cb data by country (Area)
cotton_seed_cake_fb_cb <- full_join(cotton_cb_wide, cotton_cake_production, by = "Area")  %>% 
  # there are negative values for some of the dsq of cotton, we will make these zero before calculations 
  # this will change some proportions for countries but we will gapfill these in with averages later if necessary
  mutate(cotton_dsq = if_else(condition = cotton_dsq < 0,
                                 true = 0,
                                 false = cotton_dsq))

# calculate the sum of a countries feed and cake production 
# and divide it by the total DSQ from the CB data
# this is the proportion of DSQ that goes to feed for a country
cotton_feed_proportion <- cotton_seed_cake_fb_cb %>%
  rowwise() %>% 
  mutate(prop_feed_total = sum(Feed, production_cake, na.rm=TRUE)/cotton_dsq)

# save soy df
write_csv(cotton_feed_proportion, paste0(save_path, "perc_dsq_cotton_used_as_feed.csv"))

```

For countries that don't have data to calculate the proportion of DSQ going to feed we will be calculating regional averages for oil crops as a whole. This is for any countries who's `prop_feed_total` calculation is `inf`, `NaN`, `NA`, or `zero`.

### Groudnut

Is all cake going to feed? Check in commodity balances data. - Yes
```{r}
# subset cb to soy cake
nut_cb <- cb %>% 
  filter(Item == "Groundnut Cake")

# subset and convert to wide
nut_cb_wide <- nut_cb %>% 
  select(Area, Element, Value) %>% 
  filter(Element == "Feed" | Element == "Domestic supply quantity" | Element == "Production") %>% 
  pivot_wider(names_from = Element, values_from = Value)

# calculate proportion DSQ of cake going to feed - pretty much 100% for all countries
nut_cb_cake_feed <- nut_cb_wide %>% 
  mutate(prop_cake_feed = Feed/`Domestic supply quantity`)
```

For all countries with data, more than 80% of groundnut cake DSQ is for feed so we will assume all cake processing goes towards feed.

Next:
- calculate proportion groundnuts DSQ directly going to feed (groundnut feed / groundnut DSQ)

We use FB data for groundnuts because the only CB data is for "Groundnut Cake".
```{r}
# subset food balance data (groundnuts not in cb data, so have to use fb)
nut_fb <- fb %>% 
  filter(Item == "Groundnuts (Shelled Eq)") %>% 
  filter(Element ==  "Domestic supply quantity" | Element == "Feed" | Element == "Processing")

# pivot wider
nut_fb_wide <- nut_fb %>% 
  select(Area, Item, Element, value_tonnes) %>% 
  pivot_wider(names_from = Element, values_from = value_tonnes)

# calculate proportion nut going to processing and proportion nut going to feed
nut_fb_wide <- nut_fb_wide %>% 
  rename(nut_dsq = `Domestic supply quantity`) %>% 
  mutate(prop_raw_feed = Feed/nut_dsq)
```

Only one country reports "Groundnuts (Shelled Eq)" data going to feed, Japan. Therefore we will exclude any of this product going directly into feed. 

#### Calculate Groundnut Feed Proportions
- calculate proportion DSQ going to feed via processing (cake_production / DSQ), for groundnuts this is the proportion of the product going to feed
- add proportion directly going to feed to proportion DSQ going to feed via processing

```{r}
# rename production in cb to cake
nut_cake_production <- nut_cb_wide %>% 
  rename(production_cake = Production) %>% 
  select(Area, production_cake)

# merge fb with cb data
nut_fb_cb <- full_join(nut_fb_wide, nut_cake_production, by = "Area")

# calculate the sum of a countries cake production 
# and divide it by the total DSQ from the FB data
# this is the proportion of DSQ that goes to feed for a country
nut_feed_proportion <- nut_fb_cb %>% 
  rowwise() %>% 
  mutate(prop_feed_total = production_cake/nut_dsq)

# save df
write_csv(nut_feed_proportion, paste0(save_path, "perc_dsq_groundnut_used_as_feed.csv"))
```

For countries that don't have data to calculate the proportion of DSQ going to feed we will be calculating regional averages for oil crops as a whole. This is for any countries who's `prop_feed_total` calculation is `inf`, `NaN`, `NA`, or `zero`.

### Oilseed, other
Oilcrops, other are used to caption the oilcrops that are not groundnut, sesamesee, etc. Use FB data because oilcrops, other CB data is only for cakes, which will be included.

Is all cake going to feed? Check in commodity balances data. - Yes
```{r}
# subset cb to soy cake
other_oil_cb <- cb %>% 
  filter(Item == "Oilseed Cakes, Other")

# subset and convert to wide
other_oil_cb_wide <- other_oil_cb %>% 
  select(Area, Element, Value) %>% 
  filter(Element == "Feed" | Element == "Domestic supply quantity" | Element == "Production") %>% 
  pivot_wider(names_from = Element, values_from = Value)

# calculate proportion DSQ of cake going to feed - pretty much 100% for all countries (errors with negative dsq)
other_oil_cb_cake_feed <- other_oil_cb_wide %>% 
  mutate(prop_cake_feed = Feed/`Domestic supply quantity`)
```

Most of "Oilseed Cakes, Other" DSQ is going towards feed barring a few countries. Something to note is that some countries have a negative DSQ, however, we will be using the production values that have no negatives for the rest of the calculations.

Next:
- calculate proportion oil_other DSQ directly going to feed (feed / DSQ)

Reminder: we use FB for "oilcrops, other" because the data is not included in CB 
```{r}
# subset food balance data ("oilcrops other" not in cb data, so have to use fb)
other_oil_fb <- fb %>% 
  filter(Item == "Oilcrops, Other") %>% 
  filter(Element ==  "Domestic supply quantity" | Element == "Feed" | Element == "Processing")

# pivot wider
other_oil_fb_wide <- other_oil_fb %>% 
  select(Area, Item, Element, value_tonnes) %>% 
  pivot_wider(names_from = Element, values_from = value_tonnes)

# calculate proportion other_oil going to feed
other_oil_fb_wide <- other_oil_fb_wide %>% 
  rename(other_oil_dsq = `Domestic supply quantity`) %>% 
  mutate(prop_raw_feed = Feed/other_oil_dsq)
```

#### Calculate Oilcrop, Other Proportions
- calculate proportion DSQ directly going to feed (feed / DSQ)
- add proportion directly going to feed to proportion DSQ going to feed via processing
```{r}
# rename production in cb to cake
other_oil_cake_production <- other_oil_cb_wide %>% 
  rename(production_cake = Production) %>% 
  select(Area, production_cake)

# merge fb with cb data by country (Area)
other_oil_fb_cb <- full_join(other_oil_fb_wide, other_oil_cake_production, by = "Area") %>% 
  # there are negative values for some of the dsq of other oilcrop, we will make these zero before calculations 
  # this will change some proportions for countries but we will gapfill these in with averages later if necessary
  mutate(other_oil_dsq = if_else(condition = other_oil_dsq < 0,
                                 true = 0,
                                 false = other_oil_dsq))

# calculate the sum of a countries feed and cake production 
# and divide it by the total DSQ from the CB data
# this is the proportion of DSQ that goes to feed for a country
other_oil_feed_proportion <- other_oil_fb_cb %>%
  rowwise() %>% 
  mutate(prop_feed_total = sum(Feed, production_cake, na.rm=TRUE)/other_oil_dsq)

# there are a number of countries where the proportion is greater than 1, we will change these to be equal to 1
other_oil_feed_proportion <- other_oil_feed_proportion %>% 
  mutate(prop_feed_total = if_else(condition = prop_feed_total > 1,
                                 true = 1,
                                 false = prop_feed_total))

# save soy df
write_csv(other_oil_feed_proportion, paste0(save_path, "perc_dsq_other_oil_used_as_feed.csv"))

```
For countries that don't have data to calculate the proportion of DSQ going to feed we will be calculating regional averages for oil crops as a whole. This is for any countries who's `prop_feed_total` calculation is `inf`, `NaN`, `NA`, or `zero`.

### Rape and mustardseed

Is all cake going to feed? Check in commodity balances data. - Yes
```{r}
# subset cb to soy cake
mustard_cake_cb <- cb %>% 
  filter(Item == "Rape and Mustard Cake")

# subset and convert to wide
mustard_cake_cb_wide <- mustard_cake_cb %>% 
  select(Area, Element, Value) %>% 
  filter(Element == "Feed" | Element == "Domestic supply quantity" | Element == "Production") %>% 
  pivot_wider(names_from = Element, values_from = Value)

# calculate proportion DSQ of cake going to feed - pretty much 100% for all countries
mustard_cb_cake_feed <- mustard_cake_cb_wide %>% 
  mutate(prop_cake_feed = Feed/`Domestic supply quantity`)
```
Almost all countries have greater than 75% of cake DSQ going to feed, for our needs we will assume all cake production is for feed. A quick check shows that only one country has a value for mustard seed oil going to feed so we will ignore it for our calculations.

Next:
- calculate proportion "Rape and Mustardseed" DSQ directly going to feed (feed / DSQ)

Reminder: we use CB instead of FB because the FB rounds to the nearest thousandth but they are otherwise the same values 
```{r}
# subset commodity balance data
mustard_cb <- cb %>% 
  filter(Item == "Rape and Mustardseed") %>% 
  filter(Element ==  "Domestic supply quantity" | Element == "Feed" | Element == "Processing")

# pivot wider
mustard_cb_wide <- mustard_cb %>% 
  select(Area, Item, Element, Value) %>% 
  pivot_wider(names_from = Element, values_from = Value)

# calculate proportion mustard going to processing and proportion mustard going to feed
mustard_cb_wide <- mustard_cb_wide %>% 
  rename(mustard_dsq = `Domestic supply quantity`) %>% 
  mutate(prop_raw_feed = Feed/mustard_dsq)
```

#### Calculate Rape and Mustard Seed Feed Proportions
- add proportion directly going to feed to proportion DSQ going to feed via processing
```{r}
# rename production in cb to cake
mustard_cake_production <- mustard_cake_cb_wide %>% 
  rename(production_cake = Production) %>% 
  select(Area, production_cake)

# merge fb with cb data by country (Area)
mustard_seed_cake <- full_join(mustard_cb_wide, mustard_cake_production, by = "Area") %>% 
  # there are negative values for some of the dsq of mustard, we will make these zero before calculations 
  # this will change some proportions for countries but we will gapfill these in with averages later if necessary
  mutate(mustard_dsq = if_else(condition = mustard_dsq < 0,
                               true = 0,
                               false = mustard_dsq))

# calculate the sum of a countries feed and cake production 
# and divide it by the total DSQ from the CB data
# this is the proportion of DSQ that goes to feed for a country
mustard_feed_proportion <- mustard_seed_cake %>%
  rowwise() %>% 
  mutate(prop_feed_total = sum(Feed, production_cake, na.rm=TRUE)/mustard_dsq)

# save mustard df
write_csv(mustard_feed_proportion, paste0(save_path, "perc_dsq_rapemustard_used_as_feed.csv"))

```

For countries that don't have data to calculate the proportion of DSQ going to feed we will be calculating regional averages for oil crops as a whole. This is for any countries who's `prop_feed_total` calculation is `inf`, `NaN`, `NA`, or `zero`.


### Sesameseed

Is all cake going to feed? Check in commodity balances data. - Yes
```{r}
# subset cb to soy cake
sesame_cb <- cb %>% 
  filter(Item == "Sesameseed Cake")

# subset and convert to wide
sesame_cb_wide <- sesame_cb %>% 
  select(Area, Element, Value) %>% 
  filter(Element == "Feed" | Element == "Domestic supply quantity" | Element == "Production") %>% 
  pivot_wider(names_from = Element, values_from = Value)

# calculate proportion DSQ of cake going to feed - all 100%
sesame_cb_cake_feed <- sesame_cb_wide %>% 
  mutate(prop_cake_feed = Feed/`Domestic supply quantity`)
```

All countries have 100% of cake DSQ going to feed, for our needs we will assume all cake production is for feed. A quick check shows that only one country has a value for mustard seed oil going to feed so we will ignore it for our calculations.

Next:
- calculate proportion sesame DSQ directly going to feed (sesame feed / sesame DSQ)
- FB data used for sesameseeds as it is not in CB data
```{r}
sesame_fb <- fb %>% 
  filter(Item == "Sesame seed") %>% 
  filter(Element ==  "Domestic supply quantity" | Element == "Feed" | Element == "Processing")

# pivot wider
sesame_fb_wide <- sesame_fb %>% 
  select(Area, Item, Element, value_tonnes) %>% 
  pivot_wider(names_from = Element, values_from = value_tonnes)

# calculate proportion sesame going to feed
sesame_fb_wide <- sesame_fb_wide %>% 
  rename(sesame_dsq = `Domestic supply quantity`) %>% 
  mutate(prop_raw_feed = Feed/sesame_dsq)
```

Only one country reports "Sesame seed" data going to feed, Ukraine. Therefore, we will exclude any of this product going directly into feed. 


#### Calculate Sesame Seed Feed Proportions
- calculate proportion DSQ going to feed via processing (cake_production / DSQ), for sesameseeds this is the proportion of the product going to feed
- add proportion directly going to feed to proportion DSQ going to feed via processing, this is zero for sesameseeds

```{r}
# rename production in cb to cake
sesame_cake_production <- sesame_cb_wide %>% 
  rename(production_cake = Production) %>% 
  select(Area, production_cake)

# merge fb with cb data
sesame_fb_cb <- full_join(sesame_fb_wide, sesame_cake_production, by = "Area") %>% 
  # there are negative values for some of the dsq of sesame, we will make these zero before calculations 
  # this will change some proportions for countries but we will gapfill these in with averages later if necessary
  mutate(sesame_dsq = if_else(condition = sesame_dsq < 0,
                              true = 0,
                              false = sesame_dsq))

# calculate the sum of a countries cake production 
# and divide it by the total DSQ from the FB data
# this is the proportion of DSQ that goes to feed for a country
sesame_feed_proportion <- sesame_fb_cb %>% 
  rowwise() %>% 
  mutate(prop_feed_total = production_cake/sesame_dsq)

# save df
write_csv(sesame_feed_proportion, paste0(save_path, "perc_dsq_sesame_used_as_feed.csv"))
```

For countries that don't have data to calculate the proportion of DSQ going to feed we will be calculating regional averages for oil crops as a whole. This is for any countries who's `prop_feed_total` calculation is `inf`, `NaN`, `NA`, or `zero`.

### Sunflower seed

Is all cake going to feed? Check in commodity balances data. - Yes
```{r}
# subset cb to soy cake
sunflower_cb <- cb %>% 
  filter(Item == "Sunflowerseed Cake")

# subset and convert to wide
sunflower_cb_wide <- sunflower_cb %>% 
  select(Area, Element, Value) %>% 
  filter(Element == "Feed" | Element == "Domestic supply quantity" | Element == "Production") %>% 
  pivot_wider(names_from = Element, values_from = Value)

# calculate proportion DSQ of cake going to feed - mostly all 99 - 100%
sunflower_cb_cake_feed <- sunflower_cb_wide %>% 
  mutate(prop_cake_feed = Feed/`Domestic supply quantity`)
```

For all countries except for China, more than 90% of cake is going to feed, for our calculations we will assume that 100% of cake is for feed for all countries.

Next:
- calculate proportion sunflower seed DSQ directly going to feed (feed / DSQ)
- FB data used for sesameseeds as it is not in CB data
```{r}
sunflower_fb <- fb %>% 
  filter(Item == "Sunflower seed") %>% 
  filter(Element ==  "Domestic supply quantity" | Element == "Feed" | Element == "Processing")

# pivot wider
sunflower_fb_wide <- sunflower_fb %>% 
  select(Area, Item, Element, value_tonnes) %>% 
  pivot_wider(names_from = Element, values_from = value_tonnes)

# calculate proportion sunflower going to feed
sunflower_fb_wide <- sunflower_fb_wide %>% 
  rename(sunflower_dsq = `Domestic supply quantity`) %>% 
  mutate(prop_raw_feed = Feed/sunflower_dsq)
```
There is a wide variety of sunflower seeds going directly to feed so we will include it in calculations.

#### Calculate Cotton Feed Proportions
- add proportion directly going to feed to proportion DSQ going to feed via processing
```{r}
# rename production in cb to cake
sunflower_cake_production <- sunflower_cb_wide %>% 
  rename(production_cake = Production) %>% 
  select(Area, production_cake)

# merge fb with cb data by country (Area)
sunflower_seed_cake_fb_cb <- full_join(sunflower_fb_wide, sunflower_cake_production, by = "Area")

# calculate the sum of a countries feed and cake production 
# and divide it by the total DSQ from the CB data
# this is the proportion of DSQ that goes to feed for a country
sunflower_feed_proportion <- sunflower_seed_cake_fb_cb %>%
  rowwise() %>% 
  mutate(prop_feed_total = sum(Feed, production_cake, na.rm=TRUE)/sunflower_dsq)

# there is one country where the proportion is greater than 1, we will change these to be equal to 1
sunflower_feed_proportion <- sunflower_feed_proportion %>% 
  mutate(prop_feed_total = if_else(condition = prop_feed_total > 1,
                                   true = 1,
                                   false = prop_feed_total))

# save df
write_csv(sunflower_feed_proportion, paste0(save_path, "perc_dsq_sunflower_used_as_feed.csv"))

```

### Combine Oilcrops
Combine all oilcrops (not soy or palm kernel) and calculate a total proportion feed for all oil crops
sum feed + sum cake / sum dsq
```{r}
# read in oilcrops percent feed csvs
sunflower <- read_csv(paste0(save_path, "perc_dsq_sunflower_used_as_feed.csv"))
sesame <- read_csv(paste0(save_path, "perc_dsq_sesame_used_as_feed.csv"))
rapemustard <- read_csv(paste0(save_path, "perc_dsq_rapemustard_used_as_feed.csv"))
other_oil <- read_csv(paste0(save_path, "perc_dsq_other_oil_used_as_feed.csv"))
groundnut <- read_csv(paste0(save_path, "perc_dsq_groundnut_used_as_feed.csv"))
cotton <- read_csv(paste0(save_path, "perc_dsq_cotton_used_as_feed.csv"))

# rename columns and subset to columns of interest
rename_subset_oilcrops <- function(df, dsq_col_name, feed_col_name, cake_col_name, prop_feed_col_name){
  df <- df %>% 
    select(Area, colnames(df[str_detect(string = colnames(df), pattern = "dsq")]), Feed, production_cake, prop_feed_total) %>% 
    rename({{feed_col_name}} := Feed, 
           {{cake_col_name}} := production_cake, 
           {{prop_feed_col_name}} := prop_feed_total)  
}

sunflower_1 <- rename_subset_oilcrops(sunflower, sunflower_dsq, sunflower_feed, sunflower_cake, sunflower_prop_feed)
cotton_1 <- rename_subset_oilcrops(cotton, cotton_dsq, cotton_feed, cotton_cake, cotton_prop_feed)
groundnut_1 <- rename_subset_oilcrops(groundnut, nut_dsq, groundnut_feed, groundnut_cake, groundnut_prop_feed)
other_oil_1 <- rename_subset_oilcrops(other_oil, other_oil_dsq, other_oil_feed, other_oil_cake, other_oil_prop_feed)
rapemustard_1 <- rename_subset_oilcrops(rapemustard, mustard_dsq, rapemustard_feed, rapemustard_cake, rapemustard_prop_feed)
sesame_1 <- rename_subset_oilcrops(sesame, sesame_dsq, sesame_feed, sesame_cake, sesame_prop_feed)

# combine dfs
oils <- sunflower_1 %>% 
  full_join(cotton_1, by = "Area") %>% 
  full_join(groundnut_1, by = "Area") %>% 
  full_join(other_oil_1, by = "Area") %>% 
  full_join(rapemustard_1, by = "Area") %>% 
  full_join(sesame_1, by = "Area")

# sum dsq, feed, and cake, calculate proportion going to feed
oils <- oils %>% 
  rowwise() %>% 
  # sum dsq for all oilcrops
  mutate(sum_dsq = sum(sunflower_dsq, cotton_dsq, nut_dsq, other_oil_dsq, mustard_dsq, sesame_dsq, na.rm = TRUE),
         # sum feed for all oilcrops excluding groundnuts and sesame seeds as noted in their sections
         sum_feed = sum(sunflower_feed, cotton_feed, other_oil_feed, rapemustard_feed, na.rm = TRUE),
         # sume the oilcrops cake productions
         sum_cake = sum(sunflower_cake, cotton_cake, groundnut_cake, other_oil_cake, rapemustard_cake, sesame_cake, na.rm = TRUE)) %>% 
  mutate(oil_prop_feed = sum(sum_feed, sum_cake, na.rm = TRUE)/sum_dsq) 

# one country where oil_prop_feed = Inf. Has cake production, but no dsq. 
# Also 8 cases where countries oil_prop_feed > 1 because more cake production than dsq.
# convert all of these cases to 1.
oils <- oils %>% 
  mutate(oil_prop_feed = case_when(oil_prop_feed > 1 ~ 1,
                                   TRUE ~ oil_prop_feed))

# reduce the columns
oils <- oils %>% 
  select(Area, sum_dsq, sum_feed, sum_cake, oil_prop_feed)

# save csv
write_csv(oils, paste0(save_path, "perc_dsq_oilcrops_used_as_feed.csv"))
```

There are a few countries with NaN or zero values that we will gapfill following the same process used for soy and palm kernel above.

### Gapfill Oilcrops

Read in previously made `oils` of percent feed for oil, add region column, and gapfill.
```{r}
# have to rename Turkey because it got a ? symbol added when saved as csv previously
# can't use %in% or == to identify it because it isn't showing up as a string
oils[131,1]                    # check to make sure this is Turkey
oils[131,1] <- "Turkey"
oils[184,1]                     # check to make sure this is C么te d'Ivoire
oils[184,1] <- "C么te d'Ivoire"
oils[33,1]                     # check to make sure this is Taiwan
oils[33,1] <- "Taiwan"

# add country code
oils <- oils %>% 
  # have to do this line with the utf coding to avoid error when adding regions with countrycode package
  mutate_if(is.character, utf8::utf8_encode) %>% 
  # add iso3 column
  mutate(iso3 = countrycode(Area, "country.name", "iso3c"))

# join with country list
oils <- full_join(oils, countries, by = "iso3") %>% 
  # fill in country name where NA
  mutate(Area = case_when(is.na(Area) ~ country, 
                          TRUE ~ Area)) %>% 
  select(-country)

# check iso3 codes for duplicates
# remove duplicates: China, China, mainland, Palestinian Territories
oils <- oils %>% 
  # this gets rid of duplicates of mainland China
  unique() %>% 
  # remove Palestinian Territories because we have Palestine
  filter(!Area == "Palestinian Territories")

# add region
# we need a combination of UN subregion and intermediate codes
# add subregion

oil_regions <- oils %>% 
  # add subregion
  mutate(subregion = countrycode(iso3, 'iso3c', 'un.regionsub.name')) %>% 
  # add intermediate region
  mutate(intermed_region = countrycode(iso3, 'iso3c', 'un.regionintermediate.name')) %>% 
  # make a region column for when there is no intermediate region use the subregion
  mutate(region = case_when(is.na(intermed_region) ~ subregion,
                            TRUE ~ intermed_region))  
# more countries are matched with region when we use country name instead of iso3 codes

# fill in Taiwan 
oil_regions$region[oil_regions$Area == "Taiwan"] <- "Eastern Asia"

# for the previously calculated regions (bottom rows in df) that show up as NA 
# when trying to add the region column with the countrycode package,
# copy their region name into the region column
oil_regions <- oil_regions %>% 
  mutate(region = case_when(is.na(region) ~ Area, 
                            TRUE ~ region))

# remove extra columns and reorder
oil_regions <- oil_regions %>% 
  select(-c(subregion, intermed_region)) %>% 
  select(Area, iso3, region, sum_dsq, sum_feed, sum_cake, oil_prop_feed) # reorder

# before using the regions to gapfill use this to look at the regional data
region_test <- oil_regions %>% 
  filter(Area == region) %>% 
  select(region, region_prop = oil_prop_feed)

# how much data needs to be gapfilled?
oil_missing <- oil_regions %>% filter(Area != region,
                                      oil_prop_feed == 0 | is.na(oil_prop_feed) | is.infinite(oil_prop_feed))

oil_not_missing <- oil_regions %>% filter(Area != region,
                                          oil_prop_feed > 0,
                                          !is.infinite(oil_prop_feed))

nrow(oil_missing)/(nrow(oil_missing) + nrow(oil_not_missing))
```

Melanesia, Micronesia, and Polynesia regions have zero for their oil_prop_feed. To gapfill these regions we will use Oceania. 

```{r}
# replace NAs and 0s with region values (0s include NAs because of how this was previously calculated)
oil_gap_filled <- oil_regions %>% 
  group_by(region) %>% 
  # for countries with a calculated zero, NA, NaN, or inf value use the regional average
  mutate(oil_prop_feed_gf = case_when(oil_prop_feed == 0 ~ oil_prop_feed[Area == region],
                                      is.na(oil_prop_feed) ~ oil_prop_feed[Area == region],
                                      is.infinite(oil_prop_feed) ~ oil_prop_feed[Area == region],
                                      TRUE ~ oil_prop_feed)) %>% 
  ungroup()

# fix zeros for Melanesia, Micronesia, and Polynesia
oil_gap_filled <- oil_gap_filled %>% 
  # use "small Island Developing States" average for missing regions 
  mutate(oil_prop_feed_gf = if_else(condition = region %in% c("Melanesia", "Micronesia", "Polynesia"),
                                    true = oil_gap_filled$oil_prop_feed[oil_gap_filled$Area == "Oceania"],
                                    false = oil_prop_feed_gf)) %>% 
  # select only the columns we need
  select(Area, iso3, region, oil_prop_feed_gf)
```

Below is a quick check to make sure the above gapfill worked as intended.
```{r}
# gf_data_to_test <- oil_gap_filled %>%
#   select(Area, oil_prop_feed_gf)
# 
# # check to make sure the above worked
# test_gf <- oil_regions %>%
#   filter(oil_prop_feed %in% c(0, NA, NaN, Inf)) %>%
#   select(Area, region, oil_prop_feed) %>%
#   left_join(gf_data_to_test, by = "Area") %>%
#   left_join(region_test, by = "region") %>%
#   mutate(data_test = oil_prop_feed_gf - region_prop)
# # end check
```

Save the new data
```{r}
# save csv
write_csv(oil_gap_filled, paste0(save_path, "perc_dsq_oilcrops_used_as_feed_gapfilled.csv"))
```