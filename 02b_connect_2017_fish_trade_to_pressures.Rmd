---
title: "02b_connect_2017_fish_trade_to_pressures"
author: "Haley Epperly"
date: "2022-10-12"
output: html_document
editor_options: 
  chunk_output_type: console
---

Objective: Use the 2017 seafood trade matrix created by Jessica to calculate the environmental pressures from traded animal products. We should have associated pressures for each product between each pair of trading partners. Keep aquaculture products separate.

Updated notes as of 05/10/2023:
- Intermediate countries are ignored, only grouping the source country (production pressures) and end country (consumption pressures)
- Data are included for 2015 - 2019, we can consider averaging later, but for now we will just use 2017 data to match the crop and livestock data

We have tonnes consumption for these marine aquaculture categories
(https://github.com/OHI-Science/food_systems/blob/master/feed/data/system_country_mapspam_tonnes_consumption.csv):
crustaceans_aquaculture_meat
marine-fish-general_aquaculture_meat
salmon_aquaculture_meat
shrimp_aquaculture_meat
tuna_aquaculture_meat

Updated notes as of 05/22/2023
- Inland aquaculture is handled in a separate script for now.
- Intermediate countries are ignored for this analysis so there is only production pressure and consumption pressure.

Load libraries
```{r}
library(tidyverse)
```

File paths
```{r}
raw_data_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/raw_data/"
aquatic_trade_data_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/01c_allocate_unknown_trade_fish_consumption/"
pressures_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/raw_data/pressures/"
save_path <- "/home/shares/food-systems/social_justice_projects/food_trade_pressures/output_data/02b_connect_2017_fish_trade_to_pressures/"
```

### New workflow that incorporates the new data from Jessica's team - mimics Haley's workflow
```{r}
trade_matrix_raw <- read_csv(paste0(aquatic_trade_data_path, "fish_trade_matrix_w_unknowns_allocated.csv")) # read in the updated data

trade_matrix_clean <- trade_matrix_raw %>% 
  filter(!c(habitat == "inland" & method == "aquaculture")) %>%  # inland capture fisheries are still included in this workflow
  filter(!nceas_group == "jellyfish")                            # remove jellyfish - Gage says jellyfish were not included in pressures or mariculture or fisheries data

trade_aquaculture <- trade_matrix_clean %>% 
  filter(method == "aquaculture")           # separate aquaculture data

trade_capture <- trade_matrix_clean %>% 
  filter(method == "capture")               # separate capture data
```

### Run through script with capture fisheries

For each fish producing/catching country, calculate the proportion of each organism (using nceas categories) that they trade with each consuming country (e.g., trade 5% of tuna with country B, 7% with country C, etc.)
```{r}
capture_trade_proportions <- trade_capture %>% 
  group_by(source_country_iso3c, consumer_iso3c, nceas_group) %>% 
  summarise(traded_tons = sum(consumption_live_weight_t, na.rm = TRUE)) %>%     # sum the total tons of nceas_group for each consumer country from the source
  ungroup() %>%                                                                 # ungroup for further calcs
  group_by(source_country_iso3c, nceas_group) %>% 
  mutate(sum_caught = sum(traded_tons, na.rm = TRUE)) %>%                       # sum the total tons farmed by species for each source country
  ungroup() %>%                                                                 # ungroup for further calcs
  mutate(proportion_traded = traded_tons/sum_caught)                            # calculate proportions of catch from source country goes to consumer country

# check data
sum(trade_capture$consumption_live_weight_t)
sum(capture_trade_proportions$traded_tons)

# These checks passed but are here in case someone would like to check again
# check that proportions sum to 1 for each animal product in each producing country
# check_props <- capture_trade_proportions %>%
#   group_by(source_country_iso3c, nceas_group) %>%
#   summarise(sum = sum(proportion_traded))
# 
# unique(check_props$sum)                                                         # only 1s so the proportions are calculated correctly
#length(which(is.na(check_props$sum))) # 0 NAs

```

Read in pressures data from Mel and subset to fisheries (capture and aquaculture and separate). fofm = species that are routinely caught to be used for the production of fish oil/meal.

```{r}
pressures <- read_csv(paste0(pressures_path, "rgn_raw_summary.csv"))

# remove fofm because this has the fofm catch used for feed taken out - adding this in in next code chunk
pressure_capture <- pressures %>% 
  filter(system == "fisheries") %>% 
  filter(category == "farm" | category == "wildcaught") %>% 
  filter(!organism == "fofm")

pressure_aquaculture <- pressures %>% 
  filter(system == "aquaculture") %>% 
  filter(category == "farm" | category == "wildcaught") %>% 
  filter(!organism == "fofm")
```


```{r}
# make sure crop feeds aren't included in here somehow, they are not when last checked so remove comments if want to check again
# table(pressure_capture$product)
# table(pressure_capture$category)
# table(pressure_capture$consumed)
# table(pressure_capture$organism)
# table(pressure_capture$system)
# 
# table(pressure_aquaculture$product)
# table(pressure_aquaculture$category)
# table(pressure_aquaculture$consumed)
# table(pressure_aquaculture$organism)
# table(pressure_aquaculture$system)
```

replace the values for fofm marine fisheries in the rgn_raw_summary with values frm (saved in project folder on server).
https://github.com/OHI-Science/food_systems/blob/master/_analysis/rgn_raw_summary_fofm_haley.csv
```{r}
fofm_pressures <- read_csv(paste0(pressures_path, "rgn_raw_summary_fofm_haley.csv"))

# remove first row - all NAs
fofm_pressures <- fofm_pressures %>% 
  slice(-1) %>% 
  rename(organism = spam_super)
sum(fofm_pressures$sum)

# simplify fish capture pressures df to bind with fofm df
# we're adding the fofm to the capture df because most fofm species are captured not farmed (although trimmings from some farmed fish can be used for fofm)
capture_pres_cut <- pressure_capture %>% 
  select(country, iso3c, organism, pressure, sum)

# row bind fofm with rest of fisheries df
all_capture_pressure <- rbind(fofm_pressures, capture_pres_cut)

# make sure pressure sums match - uncomment to check
#sum(capture_pres_cut$sum) + sum(fofm_pressures$sum)
#sum(all_capture_pressure$sum)
```

Compare species groups
```{r}
table(trade_capture$nceas_group)
table(all_capture_pressure$organism)
```

We need `all_capture_pressure` `organism` groups to match the `trade_capture` `nceas_groups`.
Spelling changes:
"large-pelagic" in pressures needs to change to "large-pelagics"
"medium-pelagic" in pressures needs to change to "medium-pelagics"
"small-pelagic" in pressures needs to change to "small-pelagics"
"reef" in pressures needs to change to "reef associated"
"fish" in pressures needs to change to "inland capture"


"jellyfish" included in trade matrix but not in pressure (removed in earlier code chunk)


Add new variable that matches organism groups in pressures data
```{r}
pressure_capture_rename <- all_capture_pressure %>% 
  mutate(nceas_group = case_when(organism == "bivalve" ~ "bivalves",
                                 organism == "large-pelagic" ~ "large pelagics",
                                 organism == "medium-pelagic" ~ "medium pelagics",
                                 organism == "small-pelagic" ~ "small pelagics",
                                 organism == "reef" ~ "reef associated",
                                 organism == "salmon" ~ "salmonids",
                                 organism == "shrimp" ~ "shrimps_prawns",
                                 organism == "fish" ~ "inland capture",
                                 organism == "marine-fish-general" ~ "marine_fish_general",
                                 TRUE ~ as.character(organism)))
```

To get to cumulative pressure, divide each pressure by the global pressure (to standardize) and then sum the four pressures for each nceas_group. The csv is saved on the server but the data is available here: https://github.com/OHI-Science/food_systems/blob/master/_analysis/rescale_values.csv
```{r}
# read in data on total global pressures
total_global_pressure <- read_csv(paste0(pressures_path, "rescale_values.csv"))

# join the fish pressures with the total global pressures
sum_pressures_capture <- left_join(pressure_capture_rename, total_global_pressure, by = "pressure")

# divide each pressure by the global total pressure to standardize - this includes total pressures from all crops and animal products
sum_pressures_capture_1 <- sum_pressures_capture %>% 
  mutate(prop_global_pressure = sum/global_total)

# sum the four pressures for each nceas_group
sum_pressures_and_cumu_capture <- sum_pressures_capture_1 %>% 
  group_by(country, nceas_group) %>% 
  mutate(cumu_pressure = sum(prop_global_pressure)) %>% 
  ungroup()


# check: make sure cumulative pressures looks right (should have only one cumu pressure value for each nceas group in each country)
test1 <- sum_pressures_and_cumu_capture %>% 
  filter(country == "Brazil")
test2 <- sum_pressures_and_cumu_capture %>% 
  filter(country == "Australia")

# change formatting so all in wide format (right now only cumulative pressure is in wide format and other pressures are in long format)
sum_pressures_and_cumu_capture_wide <- sum_pressures_and_cumu_capture %>% 
  select(!c(global_total, prop_global_pressure)) %>% 
  pivot_wider(names_from = pressure, values_from = sum)
```

Join the trade matrix with pressures df and look at missing values
```{r}
capture_trade_pressures_w_missing <- full_join(capture_trade_proportions, sum_pressures_and_cumu_capture_wide, by = c("source_country_iso3c" = "iso3c", "nceas_group" = "nceas_group"))

# check missing trade data (have pressures but no trade data)
missing_trade_capture <- capture_trade_pressures_w_missing %>% 
  filter(is.na(proportion_traded))

# note: there are 1,044 rows of data that are included in the capture_trade_pressures_w_missing, but not in the capture_trade_proportions
# this means that we have 2017 pressures data for these items in these countries, but they are not in Jessica's trade matrix.

nrow(missing_trade_capture) - length(which(missing_trade_capture$cumu_pressure == 0)) # check to see how many of these data with pressures but no trade actually have no associated pressure

# for how many rows do we have trade data but not pressures data?
missing_pressures_capture <- capture_trade_pressures_w_missing %>% 
  filter(is.na(cumu_pressure))
# only 1 row missing pressures data

# sum of pressures from missing values - we can use this as a check later
summary_missing_pressures_capture <- missing_trade_capture %>%
  summarise_at(vars(cumu_pressure:water), sum, na.rm = TRUE)

# left_join instead so we don't include those rows where we only have pressures data, but no trade
capture_trade_pressures <- left_join(capture_trade_proportions, sum_pressures_and_cumu_capture_wide, by = c("source_country_iso3c" = "iso3c", "nceas_group" = "nceas_group"))
```

Multiply proportion traded between each country with the total amount of pressures for that product produced in that country. Then you can get the value of pressures (4 individual plus cumulative) for each product trade between 2 countries.
```{r}
capture_trade_pressures <- capture_trade_pressures %>% 
  mutate(trade_cumu_pressure = proportion_traded*cumu_pressure) %>% 
  mutate(trade_ghg = proportion_traded*ghg) %>% 
  mutate(trade_water = proportion_traded*water) %>% 
  mutate(trade_nutrient = proportion_traded*nutrient) %>% 
  mutate(trade_disturbance = proportion_traded*disturbance)

# subset to remove producer country total pressure from nceas_group
capture_trade_pressures_cut <- capture_trade_pressures %>% 
  rename(Producer_country = country) %>% 
  select(source_country_iso3c, Producer_country, organism,                               # reorganize columns
         consumer_iso3c, nceas_group, traded_tons, sum_caught, proportion_traded,
         trade_cumu_pressure, trade_ghg, trade_water, trade_nutrient, trade_disturbance)

# save df
write_csv(capture_trade_pressures_cut, paste0(save_path, "capture_fish_products_trade_matrix_w_pressures.csv"))

# check to see if it looks right - uncomment to do checks

# ago_test <- capture_trade_pressures %>% 
#   filter(source_country_iso3c == "AGO") %>% 
#   filter(nceas_group == "benthic")
# sum(ago_test$traded_tons) # 2905.889 (matches sum_caught in df)
# sum(ago_test$proportion_traded) #1
# 
# # make sure total value of benthic organisms caught in AGO still matches original data
# ago_check <- capture_trade_proportions %>% 
#   filter(source_country_iso3c == "AGO") %>% 
#   filter(nceas_group == "benthic")
# sum(ago_check$traded_tons) # 2905.889 (matches ago_test)
# 
# # these values should be 0 because the sum of trade_pressure columns should match the rows labeled cumu_pressure, disturbance, ghg, nutrient, and water in ago_test
# ago_test$cumu_pressure[1] - sum(ago_test$trade_cumu_pressure)
# ago_test$disturbance[1] - sum(ago_test$trade_disturbance)
# ago_test$ghg[1] - sum(ago_test$trade_ghg)
# ago_test$nutrient[1] - sum(ago_test$trade_nutrient)
# ago_test$water[1] - sum(ago_test$trade_water)
```

### Repeat with marine aquaculture data

For each fish producing/catching country, calculate the proportion of each organism (using nceas categories) that they trade with each consuming country (e.g., trade 5% of tuna with country B, 7% with country C, etc.)
```{r}
table(trade_aquaculture$method)

aquaculture_trade_proportions <- trade_aquaculture %>% 
  group_by(source_country_iso3c, consumer_iso3c, nceas_group) %>% 
  summarise(traded_tons = sum(consumption_live_weight_t, na.rm = TRUE)) %>%     # sum the total tons of nceas_group for each consumer country from the source
  ungroup() %>%                                                                 # ungroup for further calcs
  group_by(source_country_iso3c, nceas_group) %>% 
  mutate(sum_caught = sum(traded_tons, na.rm = TRUE)) %>%                       # sum the total tons farmed by species for each source country
  ungroup() %>%                                                                 # ungroup for further calcs
  mutate(proportion_traded = traded_tons/sum_caught)                            # calculate proportions of catch from source country goes to consumer country

# check data
sum(trade_aquaculture$consumption_live_weight_t)
sum(aquaculture_trade_proportions$traded_tons)

# These checks passed but are here in case someone would like to check again
# check that proportions sum to 1 for each animal product in each producing country
# check_props <- aquaculture_trade_proportions %>%
#   group_by(source_country_iso3c, nceas_group) %>%
#   summarise(sum = sum(proportion_traded))
# 
# unique(check_props$sum)                                                         # only 1s so the proportions are calculated correctly
# length(which(is.na(check_props$sum))) # 0 NAs

```

Compare species groups
```{r}
table(aquaculture_trade_proportions$nceas_group)
table(pressure_aquaculture$organism)
```

Add new variable that matches organism groups in pressures data
```{r}
pressure_aquaculture_rename <- pressure_aquaculture %>% 
  mutate(nceas_group = case_when(organism == "bivalve" ~ "bivalves",
                                 organism == "salmon" ~ "salmonids",
                                 organism == "shrimp" ~ "shrimps_prawns",
                                 organism == "marine-fish-general" ~ "marine_fish_general",
                                 TRUE ~ as.character(organism)))
```



To get to cumulative pressure, divide each pressure by the global pressure (to standardize) and then sum the four pressures for each nceas_group. The csv is saved on the server but the data is available here: https://github.com/OHI-Science/food_systems/blob/master/_analysis/rescale_values.csv
```{r}
# read in data on total global pressures
total_global_pressure <- read_csv(paste0(pressures_path, "rescale_values.csv"))

# join the fish pressures with the total global pressures
sum_pressures_aquaculture <- left_join(pressure_aquaculture_rename, total_global_pressure, by = "pressure")

# divide each pressure by the global total pressure to standardize - this includes total pressures from all crops and animal products
sum_pressures_aquaculture_1 <- sum_pressures_aquaculture %>% 
  mutate(prop_global_pressure = sum/global_total)

# sum the four pressures for each crop
sum_pressures_and_cumu_aquaculture <- sum_pressures_aquaculture_1 %>% 
  group_by(country, nceas_group) %>% 
  mutate(cumu_pressure = sum(prop_global_pressure)) %>% 
  ungroup()

# check: make sure cumulative pressures looks right (should have only one cumu pressure value for each crop product in each country)
test1 <- sum_pressures_and_cumu_aquaculture %>% 
  filter(country == "Brazil")
test2 <- sum_pressures_and_cumu_aquaculture %>% 
  filter(country == "Australia")

# change formatting so all in wide format (right now only cumulative pressure is in wide format and other pressures are in long format)
sum_pressures_and_cumu_aquaculture_wide <- sum_pressures_and_cumu_aquaculture %>% 
  select(!c(global_total, prop_global_pressure)) %>% 
  pivot_wider(names_from = pressure, values_from = sum)
```

Join the trade matrix with pressures df and look at missing values
```{r}
aquaculture_trade_pressures_w_missing <- full_join(aquaculture_trade_proportions, sum_pressures_and_cumu_aquaculture_wide, by = c("source_country_iso3c" = "iso3c", "nceas_group" = "nceas_group"))

# check missing trade data (have pressures but no trade data)
missing_trade_aquaculture <- aquaculture_trade_pressures_w_missing %>% 
  filter(is.na(proportion_traded))
nrow(missing_trade_aquaculture)

# note: there are 1,237 rows of data that are included in the aquaculture_trade_pressures_w_missing, but not in the aquaculture_trade_proportions
# this means that we have 2017 pressures data for these items in these countries, but they are not in Jessica's trade matrix.

nrow(missing_trade_aquaculture) - length(which(missing_trade_aquaculture$cumu_pressure == 0))
# 14 rows where pressures > 0 for an item. So most of the "missing" trade data really have no associated pressure.

# for how many rows do we have trade data but not pressures data?
missing_pressures_aquaculture <- aquaculture_trade_pressures_w_missing %>% 
  filter(is.na(cumu_pressure))
nrow(missing_pressures_aquaculture)
# 259 rows with missing pressures data

# sum of pressures from missing values - we can use this as a check later
summary_missing_pressures_aquaculture <- missing_trade_aquaculture %>%
  summarise_at(vars(cumu_pressure:water), sum, na.rm = TRUE)


```

Multiply proportion traded between each country with the total amount of pressures for that product produced in that country. Then you can get the value of pressures (4 individual plus cumulative) for each product trade between 2 countries.
```{r}
# left_join instead so we don't include those rows where we only have pressures data, but no trade
aquaculture_trade_pressures <- left_join(aquaculture_trade_proportions, sum_pressures_and_cumu_aquaculture_wide, by = c("source_country_iso3c" = "iso3c", "nceas_group" = "nceas_group"))

aquaculture_trade_pressures <- aquaculture_trade_pressures %>% 
  mutate(trade_cumu_pressure = proportion_traded*cumu_pressure) %>% 
  mutate(trade_ghg = proportion_traded*ghg) %>% 
  mutate(trade_water = proportion_traded*water) %>% 
  mutate(trade_nutrient = proportion_traded*nutrient) %>% 
  mutate(trade_disturbance = proportion_traded*disturbance)

# rename nceas groups to include mariculture in name
table(aquaculture_trade_pressures$nceas_group)

aquaculture_trade_pressures <- aquaculture_trade_pressures %>% 
   mutate(nceas_group = paste0(nceas_group, "_mariculture"))

table(aquaculture_trade_pressures$nceas_group)

# subset to remove extra variables
aquaculture_trade_pressures_cut <- aquaculture_trade_pressures %>% 
  rename(Producer_country = country) %>% 
  select(source_country_iso3c, Producer_country, organism,                               # reorganize and keep certain columns
         consumer_iso3c, nceas_group, traded_tons, sum_caught, proportion_traded,
         trade_cumu_pressure, trade_ghg, trade_water, trade_nutrient, trade_disturbance)

# save df
write_csv(aquaculture_trade_pressures_cut, paste0(save_path, "mariculture_fish_products_trade_matrix_w_pressures.csv"))

# check to see if it looks right - uncomment to do checks

# chn_test <- aquaculture_trade_pressures %>%
#   filter(source_country_iso3c == "CHN") %>%
#   filter(nceas_group == "marine_fish_general_mariculture")
# sum(chn_test$traded_tons) # 1732561 (matches sum_caught in df)
# sum(chn_test$proportion_traded) #1
# 
# # make sure total value of marine_fish_general organisms caught in CHN still matches original data
# chn_check <- aquaculture_trade_proportions %>%
#   filter(source_country_iso3c == "CHN") %>%
#   filter(nceas_group == "marine_fish_general")
# sum(chn_check$traded_tons) # 1732561 (matches ago_test)
# 
# # these values should be 0 because the sum of trade_pressure columns should match the rows labeled cumu_pressure, disturbance, ghg, nutrient, and water in chn_test
# chn_test$cumu_pressure[1] - sum(chn_test$trade_cumu_pressure)
# chn_test$disturbance[1] - sum(chn_test$trade_disturbance)                       # technically not 0 but extremely close to the point where it is probably a rounding error
# chn_test$ghg[1] - sum(chn_test$trade_ghg)                                       # technically not 0 but extremely close to the point where it is probably a rounding error
# chn_test$nutrient[1] - sum(chn_test$trade_nutrient)
# chn_test$water[1] - sum(chn_test$trade_water)
```

### Combine capture df with aquaculture df
```{r}
aquaculture_df <- read_csv(paste0(save_path, "mariculture_fish_products_trade_matrix_w_pressures.csv"))
capture_df <- read_csv(paste0(save_path, "capture_fish_products_trade_matrix_w_pressures.csv"))

aquaculture_capture <- rbind(aquaculture_df, capture_df)
table(aquaculture_capture$nceas_group)

# save csv
write_csv(aquaculture_capture, paste0(save_path,  "capture_and_mariculture_trade_matrix_w_pressures.csv"))
```

Check data
```{r}
# check that trade weight is the same in the original trade matrix and the edited one
sum(aquaculture_capture$traded_tons)
sum(trade_matrix_clean$consumption_live_weight_t)

# check pressures - aquaculture_capture should have the same pressure values as sum_pressures_and_cumu_capture_wide + sum_pressures_and_cumu_aquaculture_wide minus the missing data (pts for which we had pressures data but no trade/production data)
sum(aquaculture_capture$trade_cumu_pressure, na.rm = TRUE)
sum(sum_pressures_and_cumu_capture_wide$cumu_pressure) + sum(sum_pressures_and_cumu_aquaculture_wide$cumu_pressure) - sum(missing_trade_aquaculture$cumu_pressure) - sum(missing_trade_capture$cumu_pressure)

sum(aquaculture_capture$trade_ghg, na.rm = TRUE)
sum(sum_pressures_and_cumu_capture_wide$ghg) + sum(sum_pressures_and_cumu_aquaculture_wide$ghg) - sum(missing_trade_aquaculture$ghg) - sum(missing_trade_capture$ghg)

sum(aquaculture_capture$trade_water, na.rm = TRUE)
sum(sum_pressures_and_cumu_capture_wide$water) + sum(sum_pressures_and_cumu_aquaculture_wide$water) - sum(missing_trade_aquaculture$water) - sum(missing_trade_capture$water)

sum(aquaculture_capture$trade_nutrient, na.rm = TRUE)
sum(sum_pressures_and_cumu_capture_wide$nutrient) + sum(sum_pressures_and_cumu_aquaculture_wide$nutrient) - sum(missing_trade_aquaculture$nutrient) - sum(missing_trade_capture$nutrient)

sum(aquaculture_capture$trade_disturbance, na.rm = TRUE)
sum(sum_pressures_and_cumu_capture_wide$disturbance) + sum(sum_pressures_and_cumu_aquaculture_wide$disturbance) - sum(missing_trade_aquaculture$disturbance) - sum(missing_trade_capture$disturbance)
```

